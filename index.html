<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت بات‌های ترکیبی</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-color: #5D3EBE;
            --secondary-color: #7B68EE;
            --light-bg: #f8f9fa;
            --dark-bg: #1e293b;
            --light-card-bg: #ffffff;
            --dark-card-bg: #2d3748;
            --light-text: #4a5568;
            --dark-text: #e2e8f0;
            --border-color-light: #e2e8f0;
            --border-color-dark: #4a5568;
        }

        body {
            background-color: var(--light-bg);
            color: var(--light-text);
            font-family: 'Vazirmatn', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* --- Main Layout --- */
        .page-wrapper {
            display: flex;
            transition: padding-right 0.3s ease;
        }

        .sidebar {
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 0;
            transition: right 0.3s ease;
            z-index: 1000;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        
        .sidebar .sidebar-header {
            text-align: center;
            padding: 0 15px 20px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar .sidebar-header h4 {
            font-weight: 700;
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 25px;
            display: flex;
            align-items: center;
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
            border-right: 4px solid transparent;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-weight: 600;
            border-right-color: #FFD700;
        }
        
        .sidebar .nav-link i {
            width: 25px;
            margin-left: 15px;
            text-align: center;
        }

        .content-wrapper {
            flex-grow: 1;
            padding: 25px;
            margin-right: var(--sidebar-width);
            transition: margin-right 0.3s ease;
        }
        
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .page-header h2 {
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* --- General Component Styling --- */
        .card {
            border: 1px solid var(--border-color-light);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            background-color: var(--light-card-bg);
            transition: all 0.3s;
            margin-bottom: 25px;
        }

        .card-header {
            background-color: transparent;
            border-bottom: 1px solid var(--border-color-light);
            padding: 20px 25px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(93, 62, 190, 0.25);
        }
        
        /* --- Dark Mode --- */
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        body.dark-mode .card {
            background-color: var(--dark-card-bg);
            border-color: var(--border-color-dark);
        }
        body.dark-mode .card-header {
            border-color: var(--border-color-dark);
        }
        body.dark-mode .page-header h2 {
            color: var(--secondary-color);
        }
        body.dark-mode .form-control, body.dark-mode .form-select {
            background-color: #4a5568;
            border-color: #718096;
            color: var(--dark-text);
        }
        body.dark-mode .table {
            color: var(--dark-text);
        }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > * {
            --bs-table-accent-bg: rgba(255, 255, 255, 0.05);
        }
        
        /* --- Specific Section Styles --- */
        .stat-card {
            padding: 20px;
            text-align: center;
        }
        .stat-card .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
        }
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .dark-mode .stat-card .stat-label {
            color: #a0aec0;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                right: calc(var(--sidebar-width) * -1);
            }
            body.sidebar-toggled .sidebar {
                right: 0;
            }
            .content-wrapper {
                margin-right: 0;
            }
            .sidebar-toggle-btn {
                display: block !important;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .container {
            max-width: 1200px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: none;
            background: rgba(255,255,255,0.95);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        .card-body {
            padding: 25px;
        }
        
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .dark-mode .card {
            background: rgba(44, 62, 80, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            color: #ecf0f1;
        }
        .dark-mode .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .dark-mode .form-control {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #ecf0f1;
        }
        .dark-mode .form-control:focus {
            background-color: rgba(255,255,255,0.15);
            border-color: #3498db;
            color: #ecf0f1;
        }
        .dark-mode .table {
            color: #ecf0f1;
        }
        .dark-mode .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: rgba(255,255,255,0.05);
        }
        
        /* Animations and Transitions */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }
        
        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Improved Alerts */
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideInRight 0.5s ease-out;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Keyboard Shortcuts Styling */
        kbd {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                margin-bottom: 15px;
                padding: 0 10px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .card-header {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            .card-body {
                padding: 15px;
            }
            
            #chats-table {
                font-size: 0.8rem;
            }
            
            #chats-table th,
            #chats-table td {
                padding: 8px 5px;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            .form-control {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                margin-top: 10px;
                margin-bottom: 10px;
                padding: 0 5px;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .card-header {
                padding: 12px;
                font-size: 0.85rem;
            }
            
            .card-body {
                padding: 12px;
            }
            
            #chats-table {
                font-size: 0.75rem;
            }
            
            .btn-group-sm .btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
        }
        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        /* Improved Buttons */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: none;
            position: relative;
            overflow: hidden;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
        }
        
        /* Improved Form Controls */
        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: none;
            padding: 12px 15px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-1px);
        }
        .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: none;
        }
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        .footer {
            margin-top: 50px;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        /* بهبود نمایش جدول چت‌های ثبت شده */
        #chats-table {
            font-size: 0.9rem;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #chats-table th {
            white-space: nowrap;
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 10;
            font-weight: 600;
            padding: 15px 10px;
        }
        
        #chats-table td {
            white-space: nowrap;
            vertical-align: middle;
            padding: 12px 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        #chats-table tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
            transition: none;
        }
        
        #chats-table .btn-group-sm .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        .table-responsive {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Dark mode table styles */
        .dark-mode #chats-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        .dark-mode #chats-table tbody tr:hover {
            background-color: rgba(52, 73, 94, 0.3);
        }
        
        /* بهبود نمایش کارت‌های آمار اعضای یکتا */
        #unique-members-stats .card {
            transition: none;
            height: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #unique-members-stats .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        #unique-members-stats .card-header {
            font-weight: 600;
            padding: 0.75rem;
        }
        
        #unique-members-stats .card-body {
            padding: 1rem;
        }
        
        #unique-members-stats .border {
            border-color: #e9ecef !important;
            transition: none;
            background-color: #f8f9fa;
        }
        
        #unique-members-stats .border:hover {
            border-color: #007bff !important;
            background-color: #e3f2fd;
            transform: scale(1.02);
        }
        
        #unique-members-stats .fw-bold {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        #unique-members-stats .fas, #unique-members-stats .fab {
            font-size: 1.3rem;
        }
        
        #unique-members-stats .badge {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        
        #unique-members-stats .small {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: middle;
            margin-right: 5px;
        }
        .badge {
            min-width: 40px;
            padding: 0.5em 0.7em;
            font-size: 0.8em;
        }
        .status-success { color: green; }
        .status-failure { color: red; }
        .platform-checkboxes, .content-input-group {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .content-input-group > div {
            margin-bottom: 10px;
        }
        .content-input-group > div:last-child {
            margin-bottom: 0;
        }
        .content-input-group label {
            margin-bottom: 5px;
        }
        .card-header {
            font-weight: 600;
        }
        .badge {
            font-size: 0.75em;
        }
        .table th {
            border-top: none;
            font-weight: 600;
        }
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
        }
        .alert-info {
            border-left: 4px solid #17a2b8;
        }
        .alert-success {
            border-left: 4px solid #28a745;
        }
        .text-primary {
            color: #007bff !important;
        }
        .text-success {
            color: #28a745 !important;
        }
        .text-warning {
            color: #ffc107 !important;
        }
        .text-info {
            color: #17a2b8 !important;
        }
        .history-operations {
            min-width: 200px;
        }
        .history-operations .badge {
            font-size: 0.75em;
        }
        .history-operations .btn {
            font-size: 0.8em;
            padding: 0.25rem 0.5rem;
        }
        
        /* بهبود استایل فرم ثبت دستی */
        #manual-register-form {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }

        #manual-register-form .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #manual-register-form .form-control,
        #manual-register-form .form-select {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 16px;
            transition: none;
            background: white;
        }

        #manual-register-form .form-control:focus,
        #manual-register-form .form-select:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
            background: #f8fff8;
        }

        #manual-register-form .input-group-text {
            background: #4CAF50;
            color: white;
            border: 2px solid #4CAF50;
            border-radius: 10px 0 0 10px;
            font-weight: 600;
        }

        #manual-register-form .input-group .form-control {
            border-radius: 0 10px 10px 0;
            border-right: none;
        }

        #manual-register-form .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: none;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        }

        #manual-register-form .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        #manual-register-form .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: none;
        }

        #manual-register-form .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* نمایش تشخیص خودکار پلتفرم */
        .auto-detect-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 5px;
            font-size: 14px;
            color: #1976d2;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* نشانگر پلتفرم */
        .platform-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }

        .platform-telegram { background: #0088cc; }
        .platform-bale { background: #00d4aa; }
        .platform-ita { background: #ff6b35; }

        /* بهبود آیکون‌ها */
        #manual-register-form .form-label i {
            color: #4CAF50;
            width: 16px;
        }

        /* انیمیشن لودینگ */
        .loading {
            display: none;
        }

        .loading.show {
            display: inline-block;
        }

        /* بهبود responsive */
        @media (max-width: 768px) {
            #manual-register-form {
                padding: 20px;
                margin: 10px;
            }
            
            #manual-register-form .d-flex {
                flex-direction: column;
                gap: 10px;
            }
            
            #manual-register-form .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-robot"></i> پنل مدیریت</h4>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="/dashboard#dashboard-section" data-section="dashboard-section">
                        <i class="fas fa-tachometer-alt"></i> داشبورد
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard#chats-section" data-section="chats-section">
                        <i class="fas fa-comments"></i> مدیریت چت‌ها
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard#broadcast-section" data-section="broadcast-section">
                        <i class="fas fa-paper-plane"></i> ارسال پیام
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard#history-section" data-section="history-section">
                        <i class="fas fa-history"></i> تاریخچه ارسال
                    </a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link" href="/dashboard#scheduler-section" data-section="scheduler-section">
                        <i class="fas fa-clock"></i> ارسال‌های زماندار
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard#admin-section" data-section="admin-section">
                        <i class="fas fa-user-shield"></i> مدیریت ادمین
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/users">
                        <i class="fas fa-users"></i> مدیریت کاربران
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard#reports-section" data-section="reports-section">
                        <i class="fas fa-chart-bar"></i> گزارش‌ها
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="content-wrapper">
            <header class="page-header">
                <h2 id="page-title">داشبورد</h2>
                <div>
                    <button class="btn btn-light border sidebar-toggle-btn d-lg-none me-2" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="btn btn-light border" onclick="toggleDarkMode()" id="darkModeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-light border ms-2" onclick="showKeyboardShortcuts()" title="راهنمای میانبرها">
                        <i class="fas fa-keyboard"></i>
                    </button>
                </div>
            </header>
        
            <!-- ======================= DASHBOARD SECTION ======================= -->
            <section id="dashboard-section" class="content-section active">
                <!-- پیام راهنما -->
                <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">📋 راهنمای شناسایی گروه‌ها و کانال‌ها</h5>
            <p class="mb-2">برای شناسایی گروه‌ها و کانال‌هایی که ربات در آن‌ها ادمین است:</p>
            <ul class="mb-2">
                <li><strong>تلگرام:</strong> در هر گروه/کانال دستور <code>/sync</code> را ارسال کنید</li>
                <li><strong>بله:</strong> در هر گروه/کانال دستور <code>/sync</code> را ارسال کنید</li>
                <li><strong>ایتا:</strong> در هر گروه/کانال دستور <code>/sync</code> را ارسال کنید</li>
            </ul>
            <p class="mb-0"><small>💡 پس از ارسال دستور /sync، چت‌ها در این پنل نمایش داده می‌شوند</small></p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- لیست ارسال‌های زماندار -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-clock"></i> لیست ارسال‌های زماندار</span>
                <small class="text-light">ارسال‌های برنامه‌ریزی شده برای آینده</small>
            </div>
            <div class="card-body">
                <!-- دکمه‌های عملیات -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-info" onclick="refreshScheduledList()">
                            <i class="fas fa-sync"></i> بروزرسانی لیست
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterScheduled('all')">همه</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterScheduled('pending')">در انتظار</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterScheduled('executed')">اجرا شده</button>
                        </div>
                    </div>
                </div>


                <!-- لیست ارسال‌های زماندار -->
                <div id="scheduled-list">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                        <p class="mt-2">در حال بارگذاری ارسال‌های زماندار...</p>
                    </div>
                </div>
                
                <!-- راهنمای ایجاد ارسال زماندار -->
                <div class="alert alert-info mt-3" id="scheduled-help" style="display: none;">
                    <h6><i class="fas fa-info-circle"></i> راهنمای ایجاد ارسال زماندار:</h6>
                    <ol class="mb-0">
                        <li>به زبانه <strong>"ارسال پیام"</strong> بروید</li>
                        <li>گزینه <strong>"ارسال زماندار"</strong> را فعال کنید</li>
                        <li>عنوان، تاریخ و زمان ارسال را مشخص کنید</li>
                        <li>پیام خود را تایپ کنید و ارسال کنید</li>
                    </ol>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" onclick="document.querySelector('[data-section=&quot;broadcast-section&quot;]').click()">
                            <i class="fas fa-paper-plane"></i> ایجاد ارسال زماندار
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- آمار کلی چت‌ها -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-chart-bar"></i> آمار کلی چت‌ها</span>
                <small class="text-light opacity-75 ms-2">(بدون احتساب ادمین‌ها)</small>
                <div>
                    <button class="btn btn-sm btn-light me-2" onclick="fetchStats()"><i class="fas fa-sync-alt"></i> بروزرسانی</button>
                    <button class="btn btn-sm btn-warning me-2" onclick="forceSync()"><i class="fas fa-sync"></i> سینک اجباری</button>
                    <button class="btn btn-sm btn-info me-2" onclick="restoreBackup()"><i class="fas fa-undo"></i> بازیابی از Backup</button>
                    <button class="btn btn-sm btn-danger me-2" onclick="clearCache()"><i class="fas fa-trash"></i> پاک کردن کش</button>
                    <button class="btn btn-sm btn-success me-2" onclick="generateComprehensiveReport()"><i class="fas fa-chart-line"></i> گزارش مختصر</button>
                    <button class="btn btn-sm btn-warning me-2" onclick="showTagManagement()"><i class="fas fa-tags"></i> مدیریت تگ‌ها</button>
                    <button class="btn btn-sm btn-primary me-2" onclick="showGrowthReports()"><i class="fas fa-chart-line"></i> گزارش‌های رشد</button>
                    <button class="btn btn-sm btn-info" onclick="downloadExcelReport()"><i class="fas fa-file-excel"></i> دانلود اکسلی</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h5><i class="fab fa-telegram text-primary"></i> تلگرام</h5>
                        <div class="card border-primary">
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👤 کاربران:</span>
                                        <span class="badge bg-primary"><span id="telegram-users">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="telegram-users-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👥 گروه‌ها:</span>
                                        <span class="badge bg-secondary"><span id="telegram-groups">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="telegram-groups-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">📢 کانال‌ها:</span>
                                        <span class="badge bg-info"><span id="telegram-channels">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="telegram-channels-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <hr class="my-2">
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small fw-bold">📊 مجموع چت‌ها:</span>
                                        <span class="badge bg-success"><span id="telegram-total">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small fw-bold">👥 مجموع اعضا:</span>
                                        <span class="badge bg-warning"><span id="telegram-total-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                
                                <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="triggerReport('telegram', event)">
                                    <i class="fas fa-file-excel"></i> گزارش اکسل
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <h5><i class="fas fa-envelope text-info"></i> بله</h5>
                        <div class="card border-info">
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👤 کاربران:</span>
                                        <span class="badge bg-primary"><span id="bale-users">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="bale-users-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👥 گروه‌ها:</span>
                                        <span class="badge bg-secondary"><span id="bale-groups">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="bale-groups-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">📢 کانال‌ها:</span>
                                        <span class="badge bg-info"><span id="bale-channels">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="bale-channels-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <hr class="my-2">
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small fw-bold">📊 مجموع چت‌ها:</span>
                                        <span class="badge bg-success"><span id="bale-total">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small fw-bold">👥 مجموع اعضا:</span>
                                        <span class="badge bg-warning"><span id="bale-total-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                
                                <button class="btn btn-outline-info btn-sm w-100 mt-2" onclick="triggerReport('bale', event)">
                                    <i class="fas fa-file-excel"></i> گزارش اکسل
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <h5><i class="fas fa-mobile-alt text-success"></i> ایتا</h5>
                        <div class="card border-success">
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👤 کاربران:</span>
                                        <span class="badge bg-primary"><span id="ita-users">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="ita-users-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👥 گروه‌ها:</span>
                                        <span class="badge bg-secondary"><span id="ita-groups">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="ita-groups-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">📢 کانال‌ها:</span>
                                        <span class="badge bg-info"><span id="ita-channels">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="ita-channels-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <hr class="my-2">
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small fw-bold">📊 مجموع چت‌ها:</span>
                                        <span class="badge bg-success"><span id="ita-total">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small fw-bold">👥 مجموع اعضا:</span>
                                        <span class="badge bg-warning"><span id="ita-total-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                
                                <button class="btn btn-outline-success btn-sm w-100 mt-2" onclick="triggerReport('ita', event)">
                                    <i class="fas fa-file-excel"></i> گزارش اکسل
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <h5><i class="fas fa-globe text-success"></i> مجموع کل</h5>
                        <div class="card border-success">
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👤 کل کاربران:</span>
                                        <span class="badge bg-primary"><span id="total-users">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="total-users-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">👥 کل گروه‌ها:</span>
                                        <span class="badge bg-secondary"><span id="total-groups">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="total-groups-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">📢 کل کانال‌ها:</span>
                                        <span class="badge bg-info"><span id="total-channels">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small text-muted">اعضا:</span>
                                        <span class="small text-muted"><span id="total-channels-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <hr class="my-2">
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small fw-bold">📊 کل چت‌ها:</span>
                                        <span class="badge bg-success"><span id="grand-total-chats">0</span> چت</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small fw-bold">👥 کل اعضا:</span>
                                        <span class="badge bg-warning"><span id="grand-total-members">0</span> نفر</span>
                                    </div>
                                </div>
                                
                                <!-- <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small fw-bold">🎯 اعضای یکتا:</span>
                                        <span class="badge bg-danger"><span id="unique-members">0</span> نفر</span>
                                    </div>
                                </div> -->
                                
                                <div class="alert alert-warning p-2 mt-2 mb-0">
                                    <small class="text-center d-block">
                                        <i class="fas fa-tools"></i> 
                                        <strong>آمار اعضای یکتا موقتاً غیرفعال است</strong>
                                    </small>
                                </div>
                                
                                <!-- <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-info btn-sm flex-fill" onclick="updateUniqueMemberStats()">
                                    <i class="fas fa-users"></i> به‌روزرسانی آمار یکتا
                                </button>
                                </div> -->
                                
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- بخش آمار اعضای یکتا - غیرفعال -->
                <!-- <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-users-cog"></i> آمار اعضای یکتا
                                </h5>
                            </div> -->
                
                <!-- پیام غیرفعال بودن آمار اعضای یکتا -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-1">آمار اعضای یکتا موقتاً غیرفعال است</h5>
                                    <p class="mb-0">این قابلیت در نسخه‌های آینده فعال خواهد شد و امکان ردیابی اعضای یکتا در تمام پلتفرم‌ها را فراهم خواهد کرد.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-users-cog"></i> آمار اعضای یکتا
                                </h5>
                            </div> -->
                            <!-- <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card border-primary h-100">
                                            <div class="card-header bg-primary text-white text-center">
                                                <h6 class="mb-0">
                                                    <i class="fab fa-telegram-plane"></i> تلگرام
                                                </h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div class="text-center">
                                                        <i class="fas fa-broadcast-tower text-info mb-1 d-block"></i>
                                                        <div class="small text-muted">کانال‌ها</div>
                                                        <div class="fw-bold text-info" id="telegram-unique-channels">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-users text-success mb-1 d-block"></i>
                                                        <div class="small text-muted">گروه‌ها</div>
                                                        <div class="fw-bold text-success" id="telegram-unique-groups">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-user text-warning mb-1 d-block"></i>
                                                        <div class="small text-muted">خصوصی</div>
                                                        <div class="fw-bold text-warning" id="telegram-unique-private">0</div>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <span class="badge bg-primary fs-6" id="telegram-unique-total">0 عضو یکتا</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card border-info h-100">
                                            <div class="card-header bg-info text-white text-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-envelope"></i> بله
                                                </h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div class="text-center">
                                                        <i class="fas fa-broadcast-tower text-info mb-1 d-block"></i>
                                                        <div class="small text-muted">کانال‌ها</div>
                                                        <div class="fw-bold text-info" id="bale-unique-channels">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-users text-success mb-1 d-block"></i>
                                                        <div class="small text-muted">گروه‌ها</div>
                                                        <div class="fw-bold text-success" id="bale-unique-groups">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-user text-warning mb-1 d-block"></i>
                                                        <div class="small text-muted">خصوصی</div>
                                                        <div class="fw-bold text-warning" id="bale-unique-private">0</div>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <span class="badge bg-info fs-6" id="bale-unique-total">0 عضو یکتا</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card border-success h-100">
                                            <div class="card-header bg-success text-white text-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-mobile-alt"></i> ایتا
                                                </h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div class="text-center">
                                                        <i class="fas fa-broadcast-tower text-info mb-1 d-block"></i>
                                                        <div class="small text-muted">کانال‌ها</div>
                                                        <div class="fw-bold text-info" id="ita-unique-channels">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-users text-success mb-1 d-block"></i>
                                                        <div class="small text-muted">گروه‌ها</div>
                                                        <div class="fw-bold text-success" id="ita-unique-groups">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-user text-warning mb-1 d-block"></i>
                                                        <div class="small text-muted">خصوصی</div>
                                                        <div class="fw-bold text-warning" id="ita-unique-private">0</div>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <span class="badge bg-success fs-6" id="ita-unique-total">0 عضو یکتا</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card border-warning h-100">
                                            <div class="card-header bg-warning text-dark text-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-globe"></i> مجموع کل
                                                </h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <div class="text-center">
                                                        <i class="fas fa-broadcast-tower text-info mb-1 d-block"></i>
                                                        <div class="small text-muted">کانال‌ها</div>
                                                        <div class="fw-bold text-info" id="total-unique-channels">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-users text-success mb-1 d-block"></i>
                                                        <div class="small text-muted">گروه‌ها</div>
                                                        <div class="fw-bold text-success" id="total-unique-groups">0</div>
                                                    </div>
                                                    <div class="text-center">
                                                        <i class="fas fa-user text-warning mb-1 d-block"></i>
                                                        <div class="small text-muted">خصوصی</div>
                                                        <div class="fw-bold text-warning" id="total-unique-private">0</div>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <span class="badge bg-warning text-dark fs-6" id="total-unique-total">0 عضو یکتا</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button class="btn btn-warning" onclick="updateUniqueMemberStats()">
                                        <i class="fas fa-sync-alt"></i> به‌روزرسانی آمار اعضای یکتا
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                
            </div>
        </div>
            </section>

            <!-- ======================= CHATS SECTION ======================= -->
            <section id="chats-section" class="content-section">
                <!-- بخش مدیریت چت‌ها -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0"><i class="fas fa-users-cog"></i> مدیریت چت‌ها و کانال‌ها</h6>
                            </div>
                            <div class="card-body py-2">
                                <!-- دکمه‌های عملیات -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="showBatchImportModal()">
                                                    <i class="fas fa-upload"></i> Import دسته‌ای
                                                </button>
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="backupChats()" title="Update backup database from main database">
                                                    <i class="fas fa-save"></i> Update Backup
                                                </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="restoreChats()" title="Restore main database from backup (use only if main DB is lost)">
                                                    <i class="fas fa-undo"></i> Restore
                                                </button>
                                        </div>
                                </div>
                                        </div>
                                
                                <!-- بخش تحلیل دستی شناسه چت -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-info">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-search text-white"></i> تحلیل هوشمند شناسه چت</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label for="analyze-chat-id" class="form-label">
                                                            <i class="fas fa-hashtag text-primary"></i> شناسه چت/کانال:
                                                        </label>
                                                        <input type="text" class="form-control" id="analyze-chat-id" 
                                                               placeholder="1234567890 یا username" dir="ltr" style="text-align: left;">
                                                        <div id="id-type-detection" class="form-text text-muted mt-1"></div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="analyze-platform" class="form-label">
                                                            <i class="fas fa-globe text-primary"></i> پلتفرم:
                                                        </label>
                                                        <select class="form-select" id="analyze-platform">
                                                            <option value="">انتخاب پلتفرم</option>
                                                            <option value="telegram">تلگرام</option>
                                                            <option value="bale">بله</option>
                                                            <option value="ita">ایتا</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <button type="button" class="btn btn-primary me-2" id="analyze-chat-btn">
                                                            <i class="fas fa-search"></i> تحلیل هوشمند
                                                        </button>
                                                        <button type="button" class="btn btn-success me-2" id="quick-analyze-btn">
                                                            <i class="fas fa-bolt"></i> تحلیل سریع
                                                        </button>
                                                        <button type="button" class="btn btn-info" id="auto-fill-btn" style="display: none;">
                                                            <i class="fas fa-magic"></i> پر کردن خودکار فرم
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="analysis-results" class="mt-3" style="display: none;">
                                                    <div class="alert alert-info">
                                                        <h6><i class="fas fa-info-circle"></i> نتایج تحلیل:</h6>
                                                        <div id="analysis-details"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- فرم ثبت چت -->
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="mb-2"><i class="fas fa-plus-circle text-success"></i> ثبت/ویرایش چت/کانال</h6>
                                
                                <!-- Container برای نمایش پیام‌ها -->
                                <div id="form-alert-container"></div>
                                
                                <form id="manual-register-form">
                                    <input type="hidden" id="edit-mode" value="false">
                                    <input type="hidden" id="original-chat-id">
                                    <input type="hidden" id="original-platform">
                                    
                                            <!-- خط اول -->
                                            <div class="row mb-2">
                                                <div class="col-md-4">
                                                    <label for="chat-id" class="form-label small">
                                                        <i class="fas fa-hashtag text-success"></i> شناسه چت/کانال:
                                        </label>
                                                    <input type="text" class="form-control form-control-sm" id="chat-id" required 
                                                           placeholder="1234567890" dir="ltr" style="text-align: left;">
                                        </div>
                                                <div class="col-md-2">
                                                    <label for="platform" class="form-label small">
                                                        <i class="fas fa-globe text-success"></i> پلتفرم:
                                        </label>
                                                    <select class="form-select form-select-sm" id="platform" required>
                                                        <option value="">انتخاب</option>
                                                        <option value="telegram">تلگرام</option>
                                                        <option value="bale">بله</option>
                                                        <option value="ita">ایتا</option>
                                        </select>
                                    </div>
                                                <div class="col-md-2">
                                                    <label for="chat-type" class="form-label small">
                                                        <i class="fas fa-layer-group text-success"></i> نوع:
                                        </label>
                                                    <select class="form-select form-select-sm" id="chat-type" required>
                                            <option value="channel">کانال</option>
                                            <option value="group">گروه</option>
                                            <option value="private">خصوصی</option>
                                        </select>
                                    </div>
                                                <div class="col-md-2">
                                                    <label for="chat-name" class="form-label small">
                                                        <i class="fas fa-tag text-success"></i> نام:
                                        </label>
                                                    <input type="text" class="form-control form-control-sm" id="chat-name" placeholder="نام چت">
                                    </div>
                                                <div class="col-md-2">
                                                    <label for="chat-username" class="form-label small">
                                                        <i class="fas fa-at text-success"></i> یوزرنیم:
                                        </label>
                                                    <input type="text" class="form-control form-control-sm" id="chat-username" placeholder="@username" dir="ltr" style="text-align: left;">
                                        </div>
                                    </div>
                                    
                                    <!-- خط دوم - تعداد اعضا -->
                                    <div class="row mb-2">
                                        <div class="col-md-3">
                                            <label for="chat-member-count" class="form-label small">
                                                <i class="fas fa-users text-info"></i> تعداد اعضا:
                                        </label>
                                            <input type="number" class="form-control form-control-sm" id="chat-member-count" placeholder="0" min="0" dir="ltr" style="text-align: left;">
                                            <small class="text-muted">تعداد اعضای کانال/گروه</small>
                                        </div>
                                        <div class="col-md-9">
                                            <label class="form-label small">
                                                <i class="fas fa-info-circle text-info"></i> راهنما:
                                        </label>
                                            <div class="alert alert-info py-2 mb-0">
                                                <small>
                                                    <i class="fas fa-lightbulb"></i> 
                                                    تعداد اعضا به صورت خودکار از API دریافت می‌شود. در صورت نیاز می‌توانید آن را به صورت دستی ویرایش کنید.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- خط دوم - تگ‌ها -->
                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <label for="chat-tags" class="form-label small">
                                                <i class="fas fa-tags text-warning"></i> تگ‌ها:
                                        </label>
                                            <input type="text" class="form-control form-control-sm" id="chat-tags" placeholder="تگ1, تگ2, تگ3" dir="rtl">
                                            <small class="text-muted">تگ‌ها را با کاما جدا کنید</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">
                                                <i class="fas fa-tag text-warning"></i> تگ‌های موجود:
                                        </label>
                                            <div id="available-tags" class="d-flex flex-wrap gap-1">
                                                <!-- تگ‌های موجود اینجا نمایش داده می‌شوند -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                            <!-- خط دوم - دکمه‌ها -->
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="d-flex gap-2">
                                                        <button type="button" class="btn btn-secondary btn-sm" id="cancel-edit" style="display: none;">
                                                            <i class="fas fa-times"></i> لغو ویرایش
                                        </button>
                                                        <button type="submit" class="btn btn-primary btn-sm" id="submit-button">
                                            <span class="loading spinner-border spinner-border-sm" role="status"></span>
                                            <i class="fas fa-save"></i> ثبت چت
                                        </button>
                                                        <button type="button" class="btn btn-success btn-sm" id="register-from-message-button" onclick="showRegisterFromMessageModal()">
                                            <i class="fas fa-paper-plane"></i> ثبت از پیام ارسالی
                                        </button>
                                    </div>
                                    </div>
                                        </div>
                                        </form>
                                                        </div>
                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> راهنمای استفاده:</h6>
                            <ul class="mb-0">
                                <li><strong>ثبت دستی:</strong> برای اضافه کردن کانال‌ها و گروه‌هایی که ربات در آن‌ها ادمین است</li>
                                <li><strong>سینک اجباری:</strong> برای شناسایی مجدد چت‌ها و کانال‌ها</li>
                                <li><strong>پاک کردن کش:</strong> برای حل مشکلات کش و وب‌هوک</li>
                                <li><strong>گزارش اکسل:</strong> دریافت لیست کامل چت‌ها با جزئیات</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="report-response" class="mt-3 alert d-none" role="alert"></div>

                <!-- چت‌های ثبت شده -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list text-info"></i> چت‌های ثبت شده</h5>
                    <div class="d-flex gap-1 flex-wrap">
                        <!-- دکمه‌های اصلی -->
                        <button class="btn btn-sm btn-outline-primary" onclick="loadRegisteredChats()" id="refresh-btn">
                            <i class="fas fa-sync-alt"></i> به‌روزرسانی
                        </button>
                        
                        <button class="btn btn-sm btn-outline-warning" onclick="syncAllMemberCounts()" id="sync-members-btn">
                            <i class="fas fa-users"></i> همگام‌سازی تعداد اعضا
                        </button>
                        
                        <!-- Auto Refresh Controls -->
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-success" onclick="toggleAutoRefresh()" id="auto-refresh-btn">
                                <i class="fas fa-play"></i> Auto
                            </button>
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="refresh-interval-btn">
                                <i class="fas fa-clock"></i> 30s
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(10000)"><i class="fas fa-bolt"></i> 10s</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(30000)"><i class="fas fa-clock"></i> 30s</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(60000)"><i class="fas fa-hourglass-half"></i> 1m</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(300000)"><i class="fas fa-hourglass"></i> 5m</a></li>
                            </ul>
                        </div>
                        
                        <!-- دکمه‌های کمکی -->
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cog"></i> تنظیمات
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showAutoRefreshStats()"><i class="fas fa-chart-line"></i> آمار</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showAutoRefreshHelp()"><i class="fas fa-question-circle"></i> راهنما</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showRealTimeStatus()"><i class="fas fa-pulse"></i> وضعیت</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showAdvancedSettings()"><i class="fas fa-cogs"></i> پیشرفته</a></li>
                            </ul>
                        </div>
                        
                        <!-- دکمه حذف گروهی -->
                        <button class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDeleteChats()" style="display: none;">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
                <div class="alert alert-info alert-sm mt-2 mb-0">
                    <i class="fas fa-info-circle"></i> 
                    <strong>راهنما:</strong> برای مدیریت تگ‌های کاربران، از ستون "تگ‌ها" در جدول زیر استفاده کنید. 
                    کاربران خصوصی (private) را می‌توانید تگ‌گذاری کنید.
                </div>
                <div class="alert alert-success alert-sm mt-2 mb-0" id="auto-refresh-status" style="display: none;">
                    <i class="fas fa-sync-alt fa-spin"></i> 
                    <strong>Auto Refresh فعال:</strong> لیست چت‌ها هر <span id="refresh-interval-display">30</span> ثانیه به‌روزرسانی می‌شود.
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="toggleAutoRefresh()">متوقف کردن</button>
                </div>
                <div class="alert alert-light alert-sm mt-2 mb-0" id="last-refresh-info" style="display: none;">
                    <i class="fas fa-clock"></i> 
                    <strong>آخرین به‌روزرسانی:</strong> <span id="last-refresh-time">-</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="resetRefreshCounter()" title="Reset counter">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- نمایش پارامترهای فیلتر فعلی -->
                <div class="alert alert-light border mb-3" id="current-filters-display">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>پلتفرم:</strong> <span id="current-platform-filter" class="badge bg-primary">همه</span>
                        </div>
                        <div class="col-md-4">
                            <strong>نوع:</strong> <span id="current-type-filter" class="badge bg-info">همه</span>
                        </div>
                        <div class="col-md-4">
                            <strong>جستجو:</strong> <span id="current-search-filter" class="badge bg-secondary">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="card mb-3">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-filter"></i> فیلترها</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="chat-search" 
                                           placeholder="جستجو در چت‌ها..." dir="rtl">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="filter-platform">
                                    <option value="all">همه پلتفرم‌ها</option>
                                    <option value="telegram">تلگرام</option>
                                    <option value="bale">بله</option>
                                    <option value="ita">ایتا</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="filter-type">
                                    <option value="all">همه انواع</option>
                                    <option value="channel">کانال</option>
                                    <option value="group">گروه</option>
                                    <option value="private">خصوصی</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chats Table -->
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        برای مشاهده تمام ستون‌ها، جدول را به صورت افقی اسکرول کنید
                    </small>
                </div>
                <div class="table-responsive" style="max-height: 600px; overflow-x: auto; overflow-y: auto;">
                    <table class="table table-hover table-striped table-sm" id="chats-table" style="min-width: 800px;">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all-chats" onchange="toggleSelectAll()">
                                </th>
                                <th style="width: 100px;">پلتفرم</th>
                                <th style="width: 80px;">نوع</th>
                                <th style="width: 150px;">شناسه</th>
                                <th style="width: 200px;">نام</th>
                                <th style="width: 150px;">یوزرنیم</th>
                                <th style="width: 100px;">تعداد اعضا</th>
                                <th style="width: 150px;">تگ‌ها</th>
                                <th style="width: 120px;">تاریخ ثبت</th>
                                <th style="width: 100px;">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="registered-chats">
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">در حال بارگذاری...</span>
                                    </div>
                                    <p class="mt-2 text-muted">در حال بارگذاری لیست چت‌ها</p>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="10" class="text-center small text-muted py-2">
                                    تعداد کل: <span id="total-chats">0</span> چت
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Pagination Container -->
                <div id="pagination-container" class="mt-3"></div>
                
                <!-- No Results Message (initially hidden) -->
                <div id="no-chats-message" class="text-center py-5 d-none">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">چتی یافت نشد</h5>
                    <p class="text-muted small">برای شروع، یک چت جدید اضافه کنید.</p>
                </div>
            </div>
        </div>
            </section>

            <!-- ======================= BROADCAST SECTION ======================= -->
            <section id="broadcast-section" class="content-section">
                <!-- ارسال پیام انبوه -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-paper-plane"></i> ارسال پیام انبوه</span>
                <small class="text-light">پشتیبانی از متن، عکس، ویدیو، فایل و فوروارد</small>
            </div>
            <div class="card-body">
                <form id="broadcast-form">
                    <div class="mb-3">
                        <label for="platform-checkboxes" class="form-label">
                            <i class="fas fa-globe"></i> انتخاب پلتفرم (چندگانه):
                        </label>
                        <div class="platform-checkboxes">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="platform-telegram" value="telegram">
                                <label class="form-check-label" for="platform-telegram">
                                    <i class="fab fa-telegram"></i> تلگرام
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="platform-bale" value="bale">
                                <label class="form-check-label" for="platform-bale">
                                    <i class="fas fa-envelope"></i> بله
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="platform-ita" value="ita">
                                <label class="form-check-label" for="platform-ita">
                                    <i class="fas fa-mobile-alt"></i> ایتا
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="platform-all" value="all">
                                <label class="form-check-label" for="platform-all">
                                    <i class="fas fa-layer-group"></i> همه پلتفرم‌ها
                                </label>
                            </div>
                        </div>
                        <small class="form-text text-muted">انتخاب "همه پلتفرم‌ها" برای ارسال همزمان به تلگرام، بله و ایتا</small>
                        <div class="alert alert-info mt-2">
                            <small><i class="fas fa-info-circle"></i> <strong>نکته:</strong> فایل‌ها به صورت خودکار بین پلتفرم‌ها منتقل می‌شوند و نام اصلی فایل حفظ می‌شود.</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scope-select" class="form-label">
                            <i class="fas fa-bullseye"></i> مقصد ارسال (چندگانه):
                        </label>
                        <div class="d-flex flex-wrap platform-checkboxes">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="scope-private" value="private">
                                <label class="form-check-label" for="scope-private">
                                    <i class="fas fa-user"></i> کاربران
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="scope-group" value="group">
                                <label class="form-check-label" for="scope-group">
                                    <i class="fas fa-users"></i> گروه‌ها
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="scope-channel" value="channel">
                                <label class="form-check-label" for="scope-channel">
                                    <i class="fas fa-broadcast-tower"></i> کانال‌ها
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="scope-all" value="all">
                                <label class="form-check-label" for="scope-all">
                                    <i class="fas fa-check-double"></i> همه
                                </label>
                            </div>
                        </div>
                        <small class="form-text text-muted">انتخاب "همه" برای ارسال به تمام انواع چت‌ها</small>
                    </div>

                    <!-- گزینه ارسال زماندار - بخشی از ارسال انبوه -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduled-send">
                            <label class="form-check-label" for="scheduled-send">
                                <i class="fas fa-clock me-1"></i>ارسال زماندار (بخشی از ارسال انبوه)
                            </label>
                        </div>
                        <small class="text-muted">برای ارسال پیام در زمان مشخص - این گزینه بخشی از فرآیند ارسال انبوه است</small>
                        
                        <!-- تنظیمات زمان ارسال -->
                        <div id="scheduled-settings" class="scheduled-settings d-none mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> <strong>نکته:</strong> این ارسال زماندار بخشی از فرآیند ارسال انبوه است و به تمام پلتفرم‌ها و مقاصد انتخاب شده ارسال خواهد شد.
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="scheduled-title" class="form-label">
                                        <i class="fas fa-tag"></i> عنوان ارسال زماندار:
                                    </label>
                                    <input type="text" class="form-control" id="scheduled-title" 
                                           placeholder="مثال: اطلاعیه مهم">
                                </div>
                                <div class="col-md-6">
                                    <label for="scheduled-date" class="form-label">
                                        <i class="fas fa-calendar"></i> تاریخ شمسی:
                                    </label>
                                    <input type="text" class="form-control" id="scheduled-date" 
                                           placeholder="1403/07/15" dir="ltr" value="">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label for="scheduled-time" class="form-label">
                                        <i class="fas fa-clock"></i> ساعت (تهران - 24 ساعته):
                                    </label>
                                    <input type="time" class="form-control" id="scheduled-time" value="">
                                </div>
                                <div class="col-md-6">
                                    <label for="scheduled-repeat" class="form-label">
                                        <i class="fas fa-redo"></i> تعداد دفعات تکرار:
                                    </label>
                                    <select class="form-select" id="scheduled-repeat">
                                        <option value="1">یک بار</option>
                                        <option value="2">دو بار</option>
                                        <option value="3">سه بار</option>
                                        <option value="5">پنج بار</option>
                                        <option value="10">ده بار</option>
                                        <option value="0">نامحدود</option>
                                    </select>
                                    <small class="text-muted">تعداد دفعات ارسال پیام</small>
                                </div>
                            </div>

                            <!-- گزینه ارسال به چت‌های تگ‌دار برای ارسال زماندار -->
                            <div class="mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="scheduled-send-to-tagged" onchange="toggleScheduledTagSelector()">
                                    <label class="form-check-label" for="scheduled-send-to-tagged">
                                        <i class="fas fa-tags text-warning"></i> ارسال به چت‌های دارای تگ خاص
                                    </label>
                                </div>

                                <div id="scheduled-tag-selector" class="mt-2 d-none">
                                    <label for="scheduled-selected-tag" class="form-label small">
                                        انتخاب تگ برای ارسال زماندار:
                                    </label>
                                    <select id="scheduled-selected-tag" class="form-select form-select-sm" multiple size="4">
                                        <option value="">-- انتخاب تگ --</option>
                                    </select>
                                    <small class="text-muted">برای انتخاب چندین تگ، Ctrl را نگه دارید و کلیک کنید</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 content-input-group">
                        <h6><i class="fas fa-edit"></i> محتوای پیام:</h6>
                        <div class="mb-3">
                            <label for="message-content" class="form-label">
                                <i class="fas fa-text-width"></i> متن پیام یا کپشن فایل:
                            </label>
                            <textarea class="form-control" id="message-content" rows="3" 
                                placeholder="پیام متنی یا کپشن برای فایل را اینجا وارد کنید..."></textarea>
                            <small class="form-text text-muted">برای پیام متنی خالی، فقط متن وارد کنید. برای فایل، این فیلد به عنوان کپشن استفاده می‌شود.</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <label for="file-image" class="form-label">
                                    <i class="fas fa-image text-primary"></i> تصویر:
                                </label>
                                <input type="file" class="form-control" id="file-image" accept="image/*">
                                <small class="form-text text-muted">JPG, PNG, GIF</small>
                            </div>
                            <div class="col-md-4">
                                <label for="file-video" class="form-label">
                                    <i class="fas fa-video text-success"></i> ویدئو:
                                </label>
                                <input type="file" class="form-control" id="file-video" accept="video/*">
                                <small class="form-text text-muted">MP4, AVI, MOV</small>
                            </div>
                            <div class="col-md-4">
                                <label for="file-document" class="form-label">
                                    <i class="fas fa-file text-warning"></i> فایل:
                                </label>
                                <input type="file" class="form-control" id="file-document">
                                <small class="form-text text-muted">PDF, DOC, MP3, ZIP, WAV, OGG</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pin-message">
                                <label class="form-check-label" for="pin-message">
                                    <i class="fas fa-thumbtack me-1"></i>سنجاق کردن پیام در کانال‌ها
                                </label>
                            </div>
                            <small class="text-muted">پیام در کانال‌ها سنجاق خواهد شد (فقط برای کانال‌ها)</small>
                        </div>

                        
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle"></i> راهنمای ارسال:</h6>
                            <ul class="mb-0">
                                <li><strong>متن ساده:</strong> فقط متن وارد کنید</li>
                                <li><strong>فایل + کپشن:</strong> فایل انتخاب کنید و کپشن بنویسید</li>
                                <li><strong>فوروارد:</strong> از طریق ربات‌ها پیام را فوروارد کنید</li>
                                <li><strong>Cross-platform:</strong> فایل‌ها بین تلگرام و بله منتقل می‌شوند</li>
                            </ul>
                        </div>

                        <!-- دکمه مدیریت ارسال‌های زماندار انبوه -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="showScheduledBroadcasts()">
                                <i class="fas fa-clock"></i> مدیریت ارسال‌های زماندار انبوه
                            </button>
                            <small class="text-muted ms-2">مشاهده و حذف ارسال‌های انبوه زمان‌بندی شده آینده</small>
                        </div>

                        <!-- گزینه ارسال به چت‌های تگ‌دار -->
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="send-to-tagged" onchange="toggleTagSelector()">
                            <label class="form-check-label" for="send-to-tagged">
                                <i class="fas fa-tags text-warning"></i> ارسال به چت‌های دارای تگ خاص
                            </label>
                        </div>

                        <div id="tag-selector" class="mt-2 d-none">
                            <label for="selected-tag" class="form-label small">
                                انتخاب تگ برای ارسال:
                            </label>
                            <select id="selected-tag" class="form-select form-select-sm" multiple size="4">
                                <option value="">-- انتخاب تگ --</option>
                            </select>
                            <small class="text-muted">برای انتخاب چندین تگ، Ctrl را نگه دارید و کلیک کنید</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="broadcast-button">
                            <span id="broadcast-spinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                            <i class="fas fa-paper-plane me-2"></i>
                            <span id="broadcast-button-text">ارسال پیام انبوه</span>
                        </button>
                        <small class="text-muted text-center">
                            <i class="fas fa-shield-alt"></i> 
                            ارسال ایمن با کنترل نرخ و مدیریت خطا
                        </small>
                    </div>
                </form>
                <div id="broadcast-response" class="mt-3 alert d-none" role="alert"></div>
            </div>
        </div>

        <!-- Modal برای نمایش ارسال‌های زماندار -->
        <div class="modal fade" id="scheduledBroadcastsModal" tabindex="-1" aria-labelledby="scheduledBroadcastsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduledBroadcastsModalLabel">
                            <i class="fas fa-clock"></i> مدیریت ارسال‌های زماندار انبوه
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-sm btn-primary" onclick="loadScheduledBroadcasts()">
                                        <i class="fas fa-sync"></i> به‌روزرسانی
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select form-select-sm" id="scheduled-filter" onchange="filterScheduledBroadcasts()">
                                        <option value="all">همه ارسال‌های آینده</option>
                                        <option value="pending">در انتظار ارسال</option>
                                        <option value="running">در حال ارسال</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="scheduled-broadcasts-list">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> در حال بارگذاری...
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>
                </div>
            </div>
        </div>
            </section>

            <!-- ======================= HISTORY SECTION ======================= -->
            <section id="history-section" class="content-section">
                <!-- تاریخچه ارسال -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-history"></i> تاریخچه ارسال‌ها</span>
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <select class="form-select form-select-sm" id="historyLimit" onchange="changeHistoryLimit()" style="width: auto;">
                            <option value="10">۱۰ مورد اخیر</option>
                            <option value="20" selected>۲۰ مورد اخیر</option>
                            <option value="50">۵۰ مورد اخیر</option>
                            <option value="100">۱۰۰ مورد اخیر</option>
                        </select>
                        <button class="btn btn-sm btn-light" onclick="fetchHistory()">
                            <i class="fas fa-sync-alt"></i> بروزرسانی
                        </button>
                        <span class="badge bg-info">Auto-refresh: 10s</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllHistory()">
                                <i class="fas fa-check-square"></i> انتخاب همه
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllHistory()">
                                <i class="fas fa-square"></i> لغو انتخاب
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedHistory()" id="deleteSelectedHistoryBtn" disabled>
                                <i class="fas fa-trash"></i> حذف انتخاب شده‌ها
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllHistoryCheckbox" onchange="toggleSelectAllHistory()">
                                </th>
                                <th><i class="fas fa-globe"></i> پلتفرم</th>
                                <th><i class="fas fa-bullseye"></i> مقصد</th>
                                <th><i class="fas fa-file-alt"></i> محتوا</th>
                                <th><i class="fas fa-clock"></i> زمان</th>
                                <th><i class="fas fa-cogs"></i> عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="history-list">
                            <tr>
                                <td colspan="6" class="text-center text-muted" id="loading-history">
                                    <i class="fas fa-spinner fa-spin"></i> در حال بارگذاری...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="history-pagination" class="d-flex justify-content-center mt-3">
                    <!-- Pagination will be added here -->
                </div>
            </div>
        </div>
            </section>

            <!-- ======================= SCHEDULER SECTION ======================= -->
            <section id="scheduler-section" class="content-section">
                <!-- لیست ارسال‌های زماندار -->
        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-server"></i> وضعیت سیستم</span>
                <span class="badge bg-success">آنلاین</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-robot text-primary"></i> ربات‌ها</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fab fa-telegram"></i> تلگرام</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-envelope"></i> بله</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-mobile-alt"></i> ایتا</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cogs text-info"></i> امکانات</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-paper-plane"></i> ارسال انبوه</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-share"></i> فوروارد</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-exchange-alt"></i> Cross-platform</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-file-excel"></i> گزارش‌گیری</span>
                                <span class="badge bg-success">فعال</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="alert alert-success mt-3">
                    <h6><i class="fas fa-check-circle"></i> سیستم آماده</h6>
                    <p class="mb-0">تمام سرویس‌ها در حال اجرا هستند و آماده دریافت درخواست‌ها می‌باشند.</p>
                </div>
            </div>
        </div>
    </div>
            </section>

            <!-- ======================= ADMIN MANAGEMENT SECTION ======================= -->
            <section id="admin-section" class="content-section">
                <div class="alert alert-info" role="alert">
                    <h5 class="alert-heading"><i class="fas fa-info-circle"></i> مدیریت ادمین‌ها</h5>
                    <p class="mb-2">در این بخش می‌توانید عملیات مدیریتی چت‌ها را انجام دهید:</p>
                    <ul class="mb-0">
                        <li>ارتقای کاربران به ادمین</li>
                        <li>تنزل ادمین‌ها</li>
                        <li>سنجاق/برداشتن سنجاق پیام‌ها</li>
                        <li>ویرایش پیام‌ها</li>
                        <li>ارسال نظرسنجی</li>
                        <li>مشاهده لیست ادمین‌های چت</li>
                    </ul>
                </div>

                <!-- تب‌های عملیات -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#promoteTab">
                                    <i class="fas fa-user-plus"></i> ارتقای کاربر
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#demoteTab">
                                    <i class="fas fa-user-minus"></i> تنزل ادمین
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#pinTab">
                                    <i class="fas fa-thumbtack"></i> سنجاق پیام
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#editTab">
                                    <i class="fas fa-edit"></i> ویرایش پیام
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#pollTab">
                                    <i class="fas fa-poll"></i> نظرسنجی
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#adminsListTab">
                                    <i class="fas fa-users-cog"></i> لیست ادمین‌ها
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <!-- ارتقای کاربر -->
                            <div class="tab-pane fade show active" id="promoteTab">
                                <form id="promoteForm" onsubmit="promoteMember(event); return false;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">پلتفرم</label>
                                            <select class="form-select" id="promotePlatform" required>
                                                <option value="">-- انتخاب کنید --</option>
                                                <option value="telegram">تلگرام</option>
                                                <option value="bale">بله</option>
                                                <option value="ita">ایتا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">شناسه چت</label>
                                            <input type="text" class="form-control" id="promoteChatId" placeholder="-1001234567890" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">شناسه کاربر</label>
                                            <input type="number" class="form-control" id="promoteUserId" placeholder="123456789" required>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <label class="form-label">دسترسی‌ها</label>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="promoteChangeInfo" checked>
                                                        <label class="form-check-label" for="promoteChangeInfo">
                                                            تغییر اطلاعات چت
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="promoteDeleteMessages" checked>
                                                        <label class="form-check-label" for="promoteDeleteMessages">
                                                            حذف پیام‌ها
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="promoteInviteUsers" checked>
                                                        <label class="form-check-label" for="promoteInviteUsers">
                                                            دعوت کاربران
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="promoteRestrictMembers" checked>
                                                        <label class="form-check-label" for="promoteRestrictMembers">
                                                            محدودسازی اعضا
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="promotePinMessages" checked>
                                                        <label class="form-check-label" for="promotePinMessages">
                                                            سنجاق پیام
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="promotePromoteMembers">
                                                        <label class="form-check-label" for="promotePromoteMembers">
                                                            ارتقای سایر ادمین‌ها
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">
                                        <i class="fas fa-user-plus"></i> ارتقای کاربر
                                    </button>
                                </form>
                            </div>

                            <!-- تنزل ادمین -->
                            <div class="tab-pane fade" id="demoteTab">
                                <form id="demoteForm" onsubmit="demoteMember(event); return false;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">پلتفرم</label>
                                            <select class="form-select" id="demotePlatform" required>
                                                <option value="">-- انتخاب کنید --</option>
                                                <option value="telegram">تلگرام</option>
                                                <option value="bale">بله</option>
                                                <option value="ita">ایتا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">شناسه چت</label>
                                            <input type="text" class="form-control" id="demoteChatId" placeholder="-1001234567890" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">شناسه کاربر</label>
                                            <input type="number" class="form-control" id="demoteUserId" placeholder="123456789" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-warning mt-3">
                                        <i class="fas fa-user-minus"></i> تنزل ادمین
                                    </button>
                                </form>
                            </div>

                            <!-- سنجاق پیام -->
                            <div class="tab-pane fade" id="pinTab">
                                <div class="alert alert-warning">
                                    <i class="fas fa-info-circle"></i> می‌توانید پیام‌ها را سنجاق یا از حالت سنجاق خارج کنید.
                                </div>
                                <form id="pinForm" onsubmit="pinUnpinMessage(event); return false;">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">عمل</label>
                                            <select class="form-select" id="pinAction" required>
                                                <option value="pin">سنجاق</option>
                                                <option value="unpin">برداشتن سنجاق</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">پلتفرم</label>
                                            <select class="form-select" id="pinPlatform" required>
                                                <option value="">-- انتخاب کنید --</option>
                                                <option value="telegram">تلگرام</option>
                                                <option value="bale">بله</option>
                                                <option value="ita">ایتا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">شناسه چت</label>
                                            <input type="text" class="form-control" id="pinChatId" placeholder="-1001234567890" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">شناسه پیام</label>
                                            <input type="number" class="form-control" id="pinMessageId" placeholder="123" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-info mt-3">
                                        <i class="fas fa-thumbtack"></i> انجام عملیات
                                    </button>
                                </form>
                            </div>

                            <!-- ویرایش پیام -->
                            <div class="tab-pane fade" id="editTab">
                                <form id="editForm" onsubmit="editMessage(event); return false;">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">پلتفرم</label>
                                            <select class="form-select" id="editPlatform" required>
                                                <option value="">-- انتخاب کنید --</option>
                                                <option value="telegram">تلگرام</option>
                                                <option value="bale">بله</option>
                                                <option value="ita">ایتا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">شناسه چت</label>
                                            <input type="text" class="form-control" id="editChatId" placeholder="-1001234567890" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">شناسه پیام</label>
                                            <input type="number" class="form-control" id="editMessageId" placeholder="123" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Parse Mode</label>
                                            <select class="form-select" id="editParseMode">
                                                <option value="HTML">HTML</option>
                                                <option value="Markdown">Markdown</option>
                                                <option value="MarkdownV2">Markdown V2</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="form-label">متن جدید</label>
                                        <textarea class="form-control" id="editText" rows="5" placeholder="متن جدید پیام" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success mt-3">
                                        <i class="fas fa-edit"></i> ویرایش پیام
                                    </button>
                                </form>
                            </div>

                            <!-- نظرسنجی -->
                            <div class="tab-pane fade" id="pollTab">
                                <form id="pollForm" onsubmit="sendPoll(event); return false;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">پلتفرم</label>
                                            <select class="form-select" id="pollPlatform" required>
                                                <option value="">-- انتخاب کنید --</option>
                                                <option value="telegram">تلگرام</option>
                                                <option value="bale">بله</option>
                                                <option value="ita">ایتا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">شناسه چت</label>
                                            <input type="text" class="form-control" id="pollChatId" placeholder="-1001234567890" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">نوع نظرسنجی</label>
                                            <select class="form-select" id="pollType">
                                                <option value="regular">عادی</option>
                                                <option value="quiz">کویز</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="form-label">سوال</label>
                                        <input type="text" class="form-control" id="pollQuestion" placeholder="سوال نظرسنجی" required>
                                    </div>
                                    <div class="mt-3">
                                        <label class="form-label">گزینه‌ها (هر خط یک گزینه)</label>
                                        <textarea class="form-control" id="pollOptions" rows="4" placeholder="گزینه 1&#10;گزینه 2&#10;گزینه 3" required></textarea>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pollAnonymous" checked>
                                                <label class="form-check-label" for="pollAnonymous">
                                                    ناشناس
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="pollMultipleAnswers">
                                                <label class="form-check-label" for="pollMultipleAnswers">
                                                    انتخاب چندگانه
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-info mt-3">
                                        <i class="fas fa-poll"></i> ارسال نظرسنجی
                                    </button>
                                </form>
                            </div>

                            <!-- لیست ادمین‌ها -->
                            <div class="tab-pane fade" id="adminsListTab">
                                <form id="adminsListForm" onsubmit="loadChatAdministrators(event); return false;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">پلتفرم</label>
                                            <select class="form-select" id="adminsListPlatform" required>
                                                <option value="">-- انتخاب کنید --</option>
                                                <option value="telegram">تلگرام</option>
                                                <option value="bale">بله</option>
                                                <option value="ita">ایتا</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">شناسه چت</label>
                                            <input type="text" class="form-control" id="adminsListChatId" placeholder="-1001234567890" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-users-cog"></i> بارگذاری لیست
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <div id="adminsListResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ======================= REPORTS SECTION ======================= -->
            <section id="reports-section" class="content-section">
                <div class="alert alert-success" role="alert">
                    <h5 class="alert-heading"><i class="fas fa-chart-line"></i> گزارش‌گیری جامع</h5>
                    <p class="mb-0">در این بخش می‌توانید انواع گزارش‌های آماری را دریافت کنید.</p>
                </div>

                <!-- کارت‌های گزارش‌ها -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">گزارش جامع</h5>
                                <p class="card-text">دریافت گزارش کامل آمار چت‌ها، اعضا و فعالیت‌ها</p>
                                <button class="btn btn-primary" onclick="generateComprehensiveReport()">
                                    <i class="fas fa-download"></i> دریافت گزارش
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                <h5 class="card-title">گزارش اکسل</h5>
                                <p class="card-text">دانلود گزارش کامل به صورت فایل Excel</p>
                                <button class="btn btn-success" onclick="downloadExcelReport()">
                                    <i class="fas fa-file-excel"></i> دانلود Excel
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-chart-line fa-3x text-info mb-3"></i>
                                <h5 class="card-title">گزارش رشد</h5>
                                <p class="card-text">مشاهده آمار رشد روزانه، هفتگی و ماهانه</p>
                                <button class="btn btn-info" onclick="showGrowthReports()">
                                    <i class="fas fa-chart-line"></i> نمایش گزارش
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-tags fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">مدیریت تگ‌ها</h5>
                                <p class="card-text">مدیریت و دسته‌بندی چت‌ها با تگ‌ها</p>
                                <button class="btn btn-warning" onclick="showTagManagement()">
                                    <i class="fas fa-tags"></i> مدیریت
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-clock fa-3x text-danger mb-3"></i>
                                <h5 class="card-title">آمار روزانه</h5>
                                <p class="card-text">دریافت آمار روزانه تمام پلتفرم‌ها</p>
                                <button class="btn btn-danger" onclick="showDailyStats()">
                                    <i class="fas fa-calendar-day"></i> مشاهده آمار
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-database fa-3x text-secondary mb-3"></i>
                                <h5 class="card-title">سینک و Backup</h5>
                                <p class="card-text">همگام‌سازی و پشتیبان‌گیری داده‌ها</p>
                                <div class="btn-group w-100">
                                    <button class="btn btn-secondary" onclick="forceSync()">
                                        <i class="fas fa-sync"></i> سینک
                                    </button>
                                    <button class="btn btn-secondary" onclick="backupChats()">
                                        <i class="fas fa-save"></i> Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ناحیه نمایش نتایج -->
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="fas fa-clipboard-list"></i> نتایج گزارش‌گیری
                    </div>
                    <div class="card-body" id="reportsResults">
                        <p class="text-muted text-center">
                            <i class="fas fa-info-circle"></i> نتایج گزارش‌گیری در اینجا نمایش داده می‌شوند
                        </p>
                    </div>
                </div>
            </section>

    <footer class="footer">
        <p>&copy; 2025 پنل مدیریت بات‌های ترکیبی. تمامی حقوق محفوظ است.</p>
        <p><small>نسخه 2.0 - پشتیبانی کامل از تلگرام و بله با امکانات پیشرفته</small></p>
    </footer>

    <!-- Batch Import Modal -->
    <div class="modal fade" id="batchImportModal" tabindex="-1" aria-labelledby="batchImportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchImportModalLabel">
                        <i class="fas fa-upload"></i> Import دسته‌ای شناسه‌ها
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>راهنمای استفاده:</strong>
                        <ul class="mb-0 mt-2">
                            <li>هر خط یک شناسه چت</li>
                            <li>فرمت: <code>شناسه,پلتفرم,نوع,نام,یوزرنیم</code></li>
                            <li>پلتفرم: telegram, bale, ita</li>
                            <li>نوع: channel, group, private</li>
                            <li>نام و یوزرنیم اختیاری هستند</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchImportText" class="form-label">شناسه‌های چت:</label>
                        <textarea class="form-control" id="batchImportText" rows="10" 
                                  placeholder="مثال:
-1001234567890,telegram,channel,کانال تست,test_channel
-1001234567891,bale,group,گروه تست,test_group
1234567890,ita,private,کاربر تست,test_user"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchImportPlatform" class="form-label">پلتفرم پیش‌فرض:</label>
                        <select class="form-select" id="batchImportPlatform">
                            <option value="">-- انتخاب کنید --</option>
                            <option value="telegram">تلگرام</option>
                            <option value="bale">بله</option>
                            <option value="ita">ایتا</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchImportType" class="form-label">نوع پیش‌فرض:</label>
                        <select class="form-select" id="batchImportType">
                            <option value="channel">کانال</option>
                            <option value="group">گروه</option>
                            <option value="private">خصوصی</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="button" class="btn btn-primary" onclick="processBatchImport()">
                        <i class="fas fa-upload"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ======================= NAVIGATION & LAYOUT SCRIPT =======================
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('page-title');
            
            // Handle hash changes for section navigation
            function showSection(sectionId) {
                // Update nav link active state
                navLinks.forEach(l => l.classList.remove('active'));
                const link = document.querySelector(`[data-section="${sectionId}"]`);
                if (link) link.classList.add('active');
                
                // Show/Hide content sections
                contentSections.forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active');
                });
                
                const activeSection = document.getElementById(sectionId);
                if(activeSection) {
                    activeSection.style.display = 'block';
                    setTimeout(() => activeSection.classList.add('active'), 10);
                }
                
                // Update page title
                if (link && pageTitle) {
                    pageTitle.textContent = link.textContent.trim();
                }
                
                // Close sidebar on mobile after click
                if (window.innerWidth < 992) {
                    document.body.classList.remove('sidebar-toggled');
                }
            }
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const sectionId = link.getAttribute('data-section');
                    
                    // For /admin/users, let browser navigate normally
                    if (link.href && link.href.includes('/admin/users')) {
                        return;
                    }
                    
                    // For hash links, prevent default and show section
                    e.preventDefault();
                    
                    // Update URL hash
                    if (sectionId) {
                        window.location.hash = sectionId;
                    }
                    
                    showSection(sectionId);
                });
            });
            
            // Handle hash changes
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    showSection(hash);
                }
            });
            
            // Show initial section based on hash
            if (window.location.hash) {
                showSection(window.location.hash.substring(1));
            } else {
                // Default to dashboard-section if no hash
                showSection('dashboard-section');
            }

            // Initial data load
            fetchStats();
            fetchHistory();
            loadRegisteredChats();
            refreshScheduledList();
            setupChatForm();
            setupChatListFilters();
        });

        function toggleSidebar() {
            document.body.classList.toggle('sidebar-toggled');
        }
        
        function toggleDarkMode() {
            const body = document.body;
            const toggleIcon = document.querySelector('#darkModeToggle i');
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
                localStorage.setItem('darkMode', 'true');
            } else {
                toggleIcon.classList.remove('fa-sun');
                toggleIcon.classList.add('fa-moon');
                localStorage.setItem('darkMode', 'false');
            }
        }
        
        function loadDarkModePreference() {
             if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                const toggleIcon = document.querySelector('#darkModeToggle i');
                toggleIcon.classList.remove('fa-moon');
                toggleIcon.classList.add('fa-sun');
            }
        }
        loadDarkModePreference();
        
        // Keyboard shortcuts function
        function showKeyboardShortcuts() {
            const shortcuts = [
                'Ctrl + 1: داشبورد',
                'Ctrl + 2: مدیریت چت‌ها', 
                'Ctrl + 3: ارسال پیام',
                'Ctrl + 4: تاریخچه ارسال',
                'Ctrl + 5: ارسال‌های زماندار',
                'Ctrl + 6: مدیریت ادمین',
                'Ctrl + 7: گزارش‌ها',
                'Ctrl + D: تغییر تم (تاریک/روشن)',
                'Ctrl + M: باز/بسته کردن منو (موبایل)'
            ];
            
            alert('میانبرهای صفحه کلید:\n\n' + shortcuts.join('\n'));
        }
        
        // Keyboard shortcuts handler
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        document.querySelector('[data-section="dashboard-section"]').click();
                        break;
                    case '2':
                        e.preventDefault();
                        document.querySelector('[data-section="chats-section"]').click();
                        break;
                    case '3':
                        e.preventDefault();
                        document.querySelector('[data-section="broadcast-section"]').click();
                        break;
                    case '4':
                        e.preventDefault();
                        document.querySelector('[data-section="history-section"]').click();
                        break;
                    case '5':
                        e.preventDefault();
                        document.querySelector('[data-section="scheduler-section"]').click();
                        break;
                    case '6':
                        e.preventDefault();
                        document.querySelector('[data-section="admin-section"]').click();
                        break;
                    case '7':
                        e.preventDefault();
                        document.querySelector('[data-section="reports-section"]').click();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleDarkMode();
                        break;
                    case 'm':
                        e.preventDefault();
                        if (window.innerWidth < 992) {
                            toggleSidebar();
                        }
                        break;
                }
            }
        });

        // Global error handler for extension errors
        window.addEventListener('error', function(event) {
            // Filter out extension-related errors
            if (event.message && event.message.includes('listener indicated an asynchronous response')) {
                console.warn('Extension error suppressed:', event.message);
                event.preventDefault();
                return false;
            }
        });

        // Handle unhandled promise rejections (extension errors)
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                event.reason.message.includes('listener indicated an asynchronous response')) {
                console.warn('Extension promise rejection suppressed:', event.reason.message);
                event.preventDefault();
                return false;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchStats();
            fetchHistory();
            
            // Setup chat analysis functionality
            setupChatAnalysis();

            // Auto-refresh for stats
            setInterval(fetchStats, 15000); // Refresh stats every 15 seconds

            // مدیریت checkbox ارسال زماندار
            const scheduledSendCheckbox = document.getElementById('scheduled-send');
            const scheduledSettings = document.getElementById('scheduled-settings');
            
            if (scheduledSendCheckbox && scheduledSettings) {
                scheduledSendCheckbox.addEventListener('change', function() {
                    const buttonText = document.getElementById('broadcast-button-text');
                    if (this.checked) {
                        scheduledSettings.classList.remove('d-none');
                        if (buttonText) {
                            buttonText.textContent = 'زمان‌بندی ارسال انبوه';
                        }
                        // تنظیم مقادیر پیش‌فرض (همیشه به‌روزرسانی شود)
                        setTimeout(() => {
                            setDefaultDateTime();
                        }, 200);
                    } else {
                        scheduledSettings.classList.add('d-none');
                        if (buttonText) {
                            buttonText.textContent = 'ارسال پیام انبوه';
                        }
                    }
                });
            }

            // Logic for "Select All" scopes
            const scopeAllCheckbox = document.getElementById('scope-all');
            const individualScopeCheckboxes = [
                document.getElementById('scope-private'),
                document.getElementById('scope-group'),
                document.getElementById('scope-channel')
            ];

            function updateIndividualScopesFromAll(checked) {
                individualScopeCheckboxes.forEach(cb => {
                    cb.checked = checked;
                    cb.disabled = checked; // Disable individual checkboxes when "All" is checked
                });
            }

            scopeAllCheckbox.addEventListener('change', () => {
                updateIndividualScopesFromAll(scopeAllCheckbox.checked);
            });

            individualScopeCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    // If any individual is unchecked, and "All" was checked, uncheck "All" and re-enable individuals
                    if (!cb.checked && scopeAllCheckbox.checked) {
                         scopeAllCheckbox.checked = false;
                         individualScopeCheckboxes.forEach(c => c.disabled = false); 
                    } else if (individualScopeCheckboxes.every(c => c.checked) && !scopeAllCheckbox.checked) {
                        // If all individuals are checked, and "All" is not, check "All"
                        scopeAllCheckbox.checked = true;
                        individualScopeCheckboxes.forEach(c => c.disabled = true);
                    }
                });
            });

            // Initial state check for scopes (e.g., if "All" was pre-checked by browser)
            updateIndividualScopesFromAll(scopeAllCheckbox.checked);


            // Logic for "Select All" platforms
            const platformAllCheckbox = document.getElementById('platform-all');
            const individualPlatformCheckboxes = [
                document.getElementById('platform-telegram'),
                document.getElementById('platform-bale'),
                document.getElementById('platform-ita')
            ];

            function updateIndividualPlatformsFromAll(checked) {
                individualPlatformCheckboxes.forEach(cb => {
                    cb.checked = checked;
                });
            }

            platformAllCheckbox.addEventListener('change', () => {
                updateIndividualPlatformsFromAll(platformAllCheckbox.checked);
            });

            individualPlatformCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    platformAllCheckbox.checked = individualPlatformCheckboxes.every(c => c.checked);
                });
            });


            // Clear content inputs logic (message text vs. file uploads)
            const messageContentInput = document.getElementById('message-content');
            const imageFileInput = document.getElementById('file-image');
            const videoFileInput = document.getElementById('file-video');
            const documentFileInput = document.getElementById('file-document');
            // 'message-content' is now used for both pure text and caption.

            function clearAllFileInputs() {
                imageFileInput.value = '';
                videoFileInput.value = '';
                documentFileInput.value = '';
            }

            // Handler for file input changes to clear other file inputs and message content
            [imageFileInput, videoFileInput, documentFileInput].forEach(input => {
                input.addEventListener('change', () => {
                    const currentInputHasFile = input.files.length > 0;
                    if (currentInputHasFile) {
                        // Clear other file inputs
                        [imageFileInput, videoFileInput, documentFileInput].forEach(otherInput => {
                            if (otherInput !== input) {
                                otherInput.value = '';
                            }
                        });
                        // User will use messageContentInput as caption. Don't clear it.
                    } else {
                        // If a file is unselected, we don't automatically clear messageContentInput.
                        // User might be editing caption or preparing to send text.
                    }
                });
            });
            // Handler for messageContentInput to clear file inputs if user starts typing text
            messageContentInput.addEventListener('input', () => {
                if (messageContentInput.value.trim() !== '' && (imageFileInput.files.length > 0 || videoFileInput.files.length > 0 || documentFileInput.files.length > 0)) {
                    // If user types text AND a file is already selected, this text is a caption.
                    // No action needed for clearing.
                } else if (messageContentInput.value.trim() !== '') {
                    // If user types text and NO file is selected, assume it's a pure text message.
                    // Clear all file inputs.
                    clearAllFileInputs();
                }
            });



            document.getElementById('broadcast-form').addEventListener('submit', async (event) => {
                event.preventDefault();

                // بررسی ارسال زماندار
                const isScheduled = scheduledSendCheckbox.checked;
                if (isScheduled) {
                    const title = document.getElementById('scheduled-title').value.trim();
                    const date = document.getElementById('scheduled-date').value.trim();
                    const time = document.getElementById('scheduled-time').value.trim();
                    
                    if (!title || !date || !time) {
                        alert('لطفاً تمام فیلدهای ارسال زماندار را پر کنید');
                        return;
                    }
                    
                    // تبدیل تاریخ شمسی به میلادی
                    const scheduledDateTime = convertPersianToGregorian(date, time);
                    if (scheduledDateTime < new Date()) {
                        alert('زمان ارسال باید در آینده باشد');
                        return;
                    }
                }

                let platforms = [];
                if (platformAllCheckbox.checked) {
                    platforms = ['telegram', 'bale', 'ita'];
                } else {
                    if (document.getElementById('platform-telegram').checked) platforms.push('telegram');
                    if (document.getElementById('platform-bale').checked) platforms.push('bale');
                    if (document.getElementById('platform-ita').checked) platforms.push('ita');
                }

                let scopes = [];
                if (scopeAllCheckbox.checked) {
                    scopes = ['private', 'group', 'channel'];
                } else {
                    if (document.getElementById('scope-private').checked) scopes.push('private');
                    if (document.getElementById('scope-group').checked) scopes.push('group');
                    if (document.getElementById('scope-channel').checked) scopes.push('channel');
                }

                const messageTextOrCaption = messageContentInput.value.trim(); // This input is now for both message and caption
                const imageFile = imageFileInput.files[0];
                const videoFile = videoFileInput.files[0];
                const documentFile = documentFileInput.files[0];

                // Determine the true content type and validate against the single content rule
                let hasPureTextMessage = false;
                let hasMediaFile = false; // True if any file is selected

                if (messageTextOrCaption && !imageFile && !videoFile && !documentFile) {
                    hasPureTextMessage = true;
                }
                if (imageFile || videoFile || documentFile) {
                    hasMediaFile = true;
                }

                if (platforms.length === 0) { alert('لطفاً حداقل یک پلتفرم را انتخاب کنید.'); return; }
                if (scopes.length === 0) { alert('لطفاً حداقل یک مقصد برای ارسال انتخاب کنید.'); return; }
                if (!hasPureTextMessage && !hasMediaFile) { alert('لطفاً محتوای پیام (متن یا فایل) را وارد کنید.'); return; }
                // This condition is now key: we allow messageTextOrCaption with a media file.
                // The previous check selectedMainContentTypesCount > 1 was too strict.
                // Now, if hasPureTextMessage is true AND hasMediaFile is true, it's an error.
                if (hasPureTextMessage && hasMediaFile) {
                    alert('خطا: شما نمی‌توانید هم یک پیام متنی جداگانه و هم یک فایل آپلود کنید. لطفاً یکی را انتخاب کنید یا از فیلد متن برای کپشن فایل استفاده کنید.');
                    return;
                }
                
                const broadcastButton = document.getElementById('broadcast-button');
                const broadcastSpinner = document.getElementById('broadcast-spinner');
                const broadcastButtonText = document.getElementById('broadcast-button-text');
                const broadcastResponse = document.getElementById('broadcast-response');

                broadcastButton.disabled = true;
                broadcastSpinner.classList.remove('d-none');
                broadcastButtonText.textContent = 'در حال ارسال...';
                broadcastResponse.classList.add('d-none');

                let allSuccess = true;
                let responseHtml = '';

                // اگر ارسال زماندار است، از API جداگانه استفاده کن
                if (isScheduled) {
                    const title = document.getElementById('scheduled-title').value.trim();
                    const date = document.getElementById('scheduled-date').value.trim();
                    const time = document.getElementById('scheduled-time').value.trim();
                    const repeatCount = document.getElementById('scheduled-repeat').value;
                    
                    const scheduledDateTime = convertPersianToGregorian(date, time);
                    
                    const formData = new FormData();
                    formData.append('title', title);
                    formData.append('platforms', JSON.stringify(platforms));
                    formData.append('scopes', JSON.stringify(scopes));
                    formData.append('scheduled_time', scheduledDateTime.toISOString());
                    formData.append('solar_date', date);
                    formData.append('repeat_count', repeatCount);
                    
                    // اضافه کردن گزینه سنجاق
                    const pinMessage = document.getElementById('pin-message').checked;
                    formData.append('pin_message', pinMessage);
                    
                    // اضافه کردن گزینه ارسال به چت‌های تگ‌دار برای ارسال زماندار
                    const scheduledSendToTagged = document.getElementById('scheduled-send-to-tagged').checked;
                    const scheduledSelectedTagElement = document.getElementById('scheduled-selected-tag');
                    let scheduledSelectedTags = [];
                    
                    if (scheduledSendToTagged) {
                        // پشتیبانی از انتخاب چندگانه
                        for (let option of scheduledSelectedTagElement.options) {
                            if (option.selected && option.value) {
                                scheduledSelectedTags.push(option.value);
                            }
                        }
                    }
                    
                    formData.append('send_to_tagged', scheduledSendToTagged);
                    formData.append('tag_filter', scheduledSelectedTags.join(','));
                    
                    if (hasPureTextMessage) {
                        formData.append('message', messageTextOrCaption);
                    } else if (hasMediaFile) {
                        if (imageFile) formData.append('image', imageFile);
                        if (videoFile) formData.append('video', videoFile);
                        if (documentFile) formData.append('document', documentFile);
                        if (messageTextOrCaption) formData.append('caption', messageTextOrCaption);
                    }
                    
                    try {
                        const response = await fetch('/api/schedule_broadcast', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            responseHtml += `<div class="alert alert-success"><i class="fas fa-check-circle"></i> ارسال زماندار "${title}" برای ${result.platforms} برنامه‌ریزی شد</div>`;
                        } else {
                            responseHtml += `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> خطا در برنامه‌ریزی ارسال: ${result.error}</div>`;
                            allSuccess = false;
                        }
                    } catch (error) {
                        responseHtml += `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> خطا در ارسال زماندار: ${error.message}</div>`;
                        allSuccess = false;
                    }
                } else {
                    // ارسال فوری - یک درخواست واحد برای تمام پلتفرم‌ها
                    const formData = new FormData();
                    formData.append('platforms', JSON.stringify(platforms)); // ارسال تمام پلتفرم‌ها در یک درخواست
                    formData.append('scopes', JSON.stringify(scopes));
                        
                    // اضافه کردن گزینه سنجاق
                    const pinMessage = document.getElementById('pin-message').checked;
                    formData.append('pin_message', pinMessage);

                    if (hasPureTextMessage) {
                        formData.append('message', messageTextOrCaption); // Pure text message
                    } else if (hasMediaFile) { // If there's a file, messageTextOrCaption is the caption
                        if (imageFile) {
                            formData.append('image', imageFile);
                            // Add original file info for cross-platform compatibility
                            if (imageFile.name) formData.append('original_media_name', imageFile.name);
                            console.log(`Sending image: ${imageFile.name} (${(imageFile.size / 1024).toFixed(1)} KB)`);
                        }
                        if (videoFile) {
                            formData.append('video', videoFile);
                            if (videoFile.name) formData.append('original_media_name', videoFile.name);
                            console.log(`Sending video: ${videoFile.name} (${(videoFile.size / 1024 / 1024).toFixed(1)} MB)`);
                        }
                        if (documentFile) {
                            formData.append('document', documentFile);
                            if (documentFile.name) formData.append('original_media_name', documentFile.name);
                            console.log(`Sending document: ${documentFile.name} (${(documentFile.size / 1024).toFixed(1)} KB)`);
                        }
                        if (messageTextOrCaption) formData.append('caption', messageTextOrCaption); // Add caption if present
                    }

                    // اضافه کردن گزینه ارسال به چت‌های تگ‌دار
                    const sendToTagged = document.getElementById('send-to-tagged').checked;
                    const selectedTagElement = document.getElementById('selected-tag');
                    let selectedTags = [];
                    
                    if (sendToTagged) {
                        // پشتیبانی از انتخاب چندگانه
                        for (let option of selectedTagElement.options) {
                            if (option.selected && option.value) {
                                selectedTags.push(option.value);
                            }
                        }
                    }
                    
                    formData.append('send_to_tagged', sendToTagged);
                    formData.append('tag_filter', selectedTags.join(','));

                    try {
                        const response = await fetch('/api/broadcast', {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) { // Handle HTTP errors from Flask
                            const errorText = await response.text();
                            console.error(`HTTP error response from /api/broadcast:`, errorText);
                            throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                        }
                        const data = await response.json(); // Parse successful JSON response

                        if (data.error) { // Check for application-level errors in the JSON response
                             allSuccess = false;
                             responseHtml += `<p class="text-danger">❌ خطای ارسال: ${data.error}</p>`;
                        } else if (data.skipped) {
                            // پلتفرم رد شده (هیچ چتی با تگ مورد نظر یافت نشد) - این خطا نیست
                            responseHtml += `<p class="text-warning">⚠️ ${data.content_preview}</p>`;
                            // allSuccess را تغییر نمی‌دهیم چون این خطا نیست
                        } else {
                            // Handle multi-platform results
                            if (data.platform_results && data.platform_results.length > 0) {
                                // Multi-platform response
                                const successRate = data.sent > 0 ? ((data.sent / (data.sent + data.failed)) * 100).toFixed(1) : 0;
                                responseHtml += `<p class="text-success">✅ ارسال چندپلتفرمی تکمیل شد. موفق: <strong>${data.sent}</strong>، ناموفق: <strong>${data.failed}</strong> (نرخ موفقیت: ${successRate}%)</p>`;
                                
                                // Show results for each platform
                                data.platform_results.forEach(platformResult => {
                                    const platformName = platformResult.platform === 'telegram' ? 'تلگرام' : platformResult.platform === 'bale' ? 'بله' : 'ایتا';
                                    if (platformResult.error) {
                                        responseHtml += `<p class="text-danger ms-3">❌ ${platformName}: ${platformResult.error}</p>`;
                                    } else if (platformResult.skipped) {
                                        responseHtml += `<p class="text-warning ms-3">⚠️ ${platformName}: ${platformResult.content_preview}</p>`;
                                    } else {
                                        const platformSuccessRate = platformResult.sent > 0 ? ((platformResult.sent / (platformResult.sent + platformResult.failed)) * 100).toFixed(1) : 0;
                                        responseHtml += `<p class="text-success ms-3">✅ ${platformName}: موفق ${platformResult.sent}، ناموفق ${platformResult.failed} (${platformSuccessRate}%)</p>`;
                                    }
                                });
                            } else {
                                // Single platform response (fallback)
                                const successRate = data.sent > 0 ? ((data.sent / (data.sent + data.failed)) * 100).toFixed(1) : 0;
                                responseHtml += `<p class="text-success">✅ پیام با موفقیت ارسال شد. موفق: <strong>${data.sent}</strong>، ناموفق: <strong>${data.failed}</strong> (نرخ موفقیت: ${successRate}%)</p>`;
                                
                                // Show detailed results if available
                                if (data.detailed_results) {
                                    responseHtml += `<div class="ms-3 text-muted small">`;
                                    Object.entries(data.detailed_results).forEach(([scope, result]) => {
                                        const scopeName = scope === 'private' ? 'کاربران' : scope === 'group' ? 'گروه‌ها' : 'کانال‌ها';
                                        if (result.sent > 0 || result.failed > 0) {
                                            responseHtml += `<span class="me-3">${scopeName}: ✅${result.sent} ❌${result.failed}</span>`;
                                        }
                                    });
                                    responseHtml += `</div>`;
                                }
                            }
                        }
                    } catch (error) {
                        allSuccess = false;
                        responseHtml += `<p class="text-danger">❌ خطای شبکه: ${error.message}</p>`;
                    }
                }

                if (allSuccess) {
                    broadcastResponse.classList.remove('d-none', 'alert-danger');
                    broadcastResponse.classList.add('alert-success');
                    responseHtml = `<h4>وضعیت ارسال کلی: موفق</h4>` + responseHtml;
                    // Clear inputs if successful
                    messageContentInput.value = '';
                    imageFileInput.value = '';
                    videoFileInput.value = '';
                    documentFileInput.value = '';
                    // Uncheck all scopes and platforms
                    individualScopeCheckboxes.forEach(cb => { cb.checked = false; cb.disabled = false; }); // Re-enable
                    scopeAllCheckbox.checked = false;
                    individualPlatformCheckboxes.forEach(cb => cb.checked = false);
                    platformAllCheckbox.checked = false;
                    fetchHistory(); // Refresh history
                } else {
                    broadcastResponse.classList.remove('d-none', 'alert-success');
                    broadcastResponse.classList.add('alert-danger');
                    responseHtml = `<h4>وضعیت ارسال کلی: ناموفق یا دارای خطا</h4>` + responseHtml;
                }
                broadcastResponse.innerHTML = responseHtml;

                // Always reset button state here, outside of try/catch to ensure it runs
                broadcastButton.disabled = false;
                broadcastSpinner.classList.add('d-none');
                broadcastButtonText.textContent = 'ارسال پیام انبوه';
            });
        });

        // FIX: Add auto-refresh for stats
        setInterval(fetchStats, 15000); // Refresh stats every 15 seconds

        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error response (stats):', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                const data = await response.json();
                console.log("Fetched stats data from API:", data); 

                // Update individual counts
                document.getElementById('telegram-users').textContent = data.telegram.users;
                document.getElementById('telegram-groups').textContent = data.telegram.groups;
                document.getElementById('telegram-channels').textContent = data.telegram.channels;
                document.getElementById('bale-users').textContent = data.bale.users;
                document.getElementById('bale-groups').textContent = data.bale.groups;
                document.getElementById('bale-channels').textContent = data.bale.channels || 0;
                document.getElementById('ita-users').textContent = data.ita?.users || 0;
                document.getElementById('ita-groups').textContent = data.ita?.groups || 0;
                document.getElementById('ita-channels').textContent = data.ita?.channels || 0;

                // Update member counts
                document.getElementById('telegram-users-members').textContent = data.telegram.users_members || 0;
                document.getElementById('telegram-groups-members').textContent = data.telegram.groups_members || 0;
                document.getElementById('telegram-channels-members').textContent = data.telegram.channels_members || 0;
                document.getElementById('bale-users-members').textContent = data.bale.users_members || 0;
                document.getElementById('bale-groups-members').textContent = data.bale.groups_members || 0;
                document.getElementById('bale-channels-members').textContent = data.bale.channels_members || 0;
                document.getElementById('ita-users-members').textContent = data.ita?.users_members || 0;
                document.getElementById('ita-groups-members').textContent = data.ita?.groups_members || 0;
                document.getElementById('ita-channels-members').textContent = data.ita?.channels_members || 0;

                // Calculate and update totals
                const telegramTotal = data.telegram.users + data.telegram.groups + data.telegram.channels;
                const baleTotal = data.bale.users + data.bale.groups + (data.bale.channels || 0);
                const itaTotal = (data.ita?.users || 0) + (data.ita?.groups || 0) + (data.ita?.channels || 0);
                
                document.getElementById('telegram-total').textContent = telegramTotal;
                document.getElementById('bale-total').textContent = baleTotal;
                document.getElementById('ita-total').textContent = itaTotal;
                document.getElementById('telegram-total-members').textContent = data.telegram.total_members || 0;
                document.getElementById('bale-total-members').textContent = data.bale.total_members || 0;
                document.getElementById('ita-total-members').textContent = data.ita?.total_members || 0;

                // Calculate and update grand totals
                const totalUsers = data.telegram.users + data.bale.users + (data.ita?.users || 0);
                const totalGroups = data.telegram.groups + data.bale.groups + (data.ita?.groups || 0);
                const totalChannels = data.telegram.channels + (data.bale.channels || 0) + (data.ita?.channels || 0);
                const totalUsersMembers = (data.telegram.users_members || 0) + (data.bale.users_members || 0) + (data.ita?.users_members || 0);
                const totalGroupsMembers = (data.telegram.groups_members || 0) + (data.bale.groups_members || 0) + (data.ita?.groups_members || 0);
                const totalChannelsMembers = (data.telegram.channels_members || 0) + (data.bale.channels_members || 0) + (data.ita?.channels_members || 0);
                const grandTotalChats = telegramTotal + baleTotal + itaTotal;
                const grandTotalMembers = (data.telegram.total_members || 0) + (data.bale.total_members || 0) + (data.ita?.total_members || 0);

                // Update grand total elements
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('total-groups').textContent = totalGroups;
                document.getElementById('total-channels').textContent = totalChannels;
                document.getElementById('total-users-members').textContent = totalUsersMembers;
                document.getElementById('total-groups-members').textContent = totalGroupsMembers;
                document.getElementById('total-channels-members').textContent = totalChannelsMembers;
                document.getElementById('grand-total-chats').textContent = grandTotalChats;
                document.getElementById('grand-total-members').textContent = grandTotalMembers;
                
                // دریافت آمار اعضای یکتا - غیرفعال
                // await fetchUniqueMemberStats();

            } catch (error) {
                console.error('Error fetching stats:', error);
                document.getElementById('telegram-users').textContent = 'Error';
                document.getElementById('telegram-groups').textContent = 'Error';
                document.getElementById('telegram-channels').textContent = 'Error';
                document.getElementById('bale-users').textContent = 'Error';
                document.getElementById('bale-groups').textContent = 'Error';
                document.getElementById('bale-channels').textContent = 'Error';
                document.getElementById('telegram-total').textContent = 'Error';
                document.getElementById('bale-total').textContent = 'Error';
                document.getElementById('telegram-total-members').textContent = 'Error';
                document.getElementById('bale-total-members').textContent = 'Error';
                document.getElementById('telegram-users-members').textContent = 'Error';
                document.getElementById('telegram-groups-members').textContent = 'Error';
                document.getElementById('telegram-channels-members').textContent = 'Error';
                document.getElementById('bale-users-members').textContent = 'Error';
                document.getElementById('bale-groups-members').textContent = 'Error';
                document.getElementById('bale-channels-members').textContent = 'Error';
                document.getElementById('total-users').textContent = 'Error';
                document.getElementById('total-groups').textContent = 'Error';
                document.getElementById('total-channels').textContent = 'Error';
                document.getElementById('total-users-members').textContent = 'Error';
                document.getElementById('total-groups-members').textContent = 'Error';
                document.getElementById('total-channels-members').textContent = 'Error';
                document.getElementById('grand-total-chats').textContent = 'Error';
                document.getElementById('grand-total-members').textContent = 'Error';
                document.getElementById('unique-members').textContent = 'Error';
            }
        }
        
        async function fetchUniqueMemberStats() {
            try {
                const response = await fetch('/api/unique_member_stats');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error response (unique member stats):', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                const data = await response.json();
                console.log("Fetched unique member stats from API:", data);

                if (data.success) {
                    displayUniqueMemberStats(data.stats);
                } else {
                    console.error('Error fetching unique member stats:', data.error);
                    document.getElementById('unique-members').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error fetching unique member stats:', error);
                document.getElementById('unique-members').textContent = 'Error';
            }
        }
        
        function displayUniqueMemberStats(stats) {
            try {
                // نمایش تعداد کل اعضای یکتا
                document.getElementById('unique-members').textContent = stats.total_unique_members || 0;
                
                // نمایش آمار تفصیلی در کنسول برای debug
                console.log('Unique Member Stats:', stats);
                
                // نمایش آمار در کارت‌های جدید
                displayUniqueMemberCards(stats);
                
            } catch (error) {
                console.error('Error displaying unique member stats:', error);
                document.getElementById('unique-members').textContent = 'Error';
            }
        }
        
        function displayUniqueMemberCards(stats) {
            try {
                console.log('Displaying unique member cards with stats:', stats);
                
                const platformStats = stats.platform_stats || {};
                const detailedStats = stats.detailed_stats || {};
                
                // آمار تلگرام
                const telegramTotal = platformStats.telegram || 0;
                const telegramDetailed = detailedStats.telegram || {};
                
                document.getElementById('telegram-unique-channels').textContent = (telegramDetailed.channel || 0).toLocaleString();
                document.getElementById('telegram-unique-groups').textContent = (telegramDetailed.group || 0).toLocaleString();
                document.getElementById('telegram-unique-private').textContent = (telegramDetailed.private || 0).toLocaleString();
                document.getElementById('telegram-unique-total').textContent = `${telegramTotal.toLocaleString()} عضو یکتا`;
                
                // آمار بله
                const baleTotal = platformStats.bale || 0;
                const baleDetailed = detailedStats.bale || {};
                
                document.getElementById('bale-unique-channels').textContent = (baleDetailed.channel || 0).toLocaleString();
                document.getElementById('bale-unique-groups').textContent = (baleDetailed.group || 0).toLocaleString();
                document.getElementById('bale-unique-private').textContent = (baleDetailed.private || 0).toLocaleString();
                document.getElementById('bale-unique-total').textContent = `${baleTotal.toLocaleString()} عضو یکتا`;
                
                // آمار ایتا
                const itaTotal = platformStats.ita || 0;
                const itaDetailed = detailedStats.ita || {};
                
                document.getElementById('ita-unique-channels').textContent = (itaDetailed.channel || 0).toLocaleString();
                document.getElementById('ita-unique-groups').textContent = (itaDetailed.group || 0).toLocaleString();
                document.getElementById('ita-unique-private').textContent = (itaDetailed.private || 0).toLocaleString();
                document.getElementById('ita-unique-total').textContent = `${itaTotal.toLocaleString()} عضو یکتا`;
                
                // آمار مجموع کل
                const totalChannels = (telegramDetailed.channel || 0) + (baleDetailed.channel || 0) + (itaDetailed.channel || 0);
                const totalGroups = (telegramDetailed.group || 0) + (baleDetailed.group || 0) + (itaDetailed.group || 0);
                const totalPrivate = (telegramDetailed.private || 0) + (baleDetailed.private || 0) + (itaDetailed.private || 0);
                const totalUnique = telegramTotal + baleTotal + itaTotal;
                
                document.getElementById('total-unique-channels').textContent = totalChannels.toLocaleString();
                document.getElementById('total-unique-groups').textContent = totalGroups.toLocaleString();
                document.getElementById('total-unique-private').textContent = totalPrivate.toLocaleString();
                document.getElementById('total-unique-total').textContent = `${totalUnique.toLocaleString()} عضو یکتا`;
                
                console.log('Unique member cards updated successfully');
                
            } catch (error) {
                console.error('Error displaying unique member cards:', error);
            }
        }
        
        
        async function updateUniqueMemberStats() {
            try {
                // نمایش loading
                document.getElementById('unique-members').textContent = '...';
                
                // دریافت آمار اعضای یکتا - غیرفعال
                // await fetchUniqueMemberStats();
                
                // نمایش پیام موفقیت
                console.log('✅ آمار اعضای یکتا به‌روزرسانی شد');
                
                
            } catch (error) {
                console.error('Error updating unique member stats:', error);
                document.getElementById('unique-members').textContent = 'Error';
            }
        }

        // متغیرهای global برای تاریخچه
        let currentHistoryPage = 1;
        let historyLimit = 20;
        let totalHistoryPages = 1;

        async function fetchHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<tr><td colspan="6" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> در حال بارگذاری...</td></tr>';
            try {
                const response = await fetch(`/api/history?limit=${historyLimit}&page=${currentHistoryPage}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error response (history):', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                const data = await response.json();
                historyList.innerHTML = ''; // Clear loading
                
                // بررسی ساختار داده (قدیمی یا جدید)
                const historyData = data.history || data; // اگر data.history وجود دارد استفاده کن، وگرنه خود data را استفاده کن
                
                if (historyData && historyData.length === 0) {
                    historyList.innerHTML = '<tr><td colspan="6" class="text-center text-muted">هیچ ارسالی یافت نشد.</td></tr>';
                } else {
                    for (const item of historyData) {
                        const row = document.createElement('tr');
                        
                        let contentPreview = item.content_preview; 
                        if (!contentPreview || contentPreview.trim() === '') {
                             contentPreview = 'محتوای فایل (بدون پیش‌نمایش)';
                        }
                        // Shorten content preview if too long for display
                        if (contentPreview.length > 50) { 
                            contentPreview = contentPreview.substring(0, 47) + '...';
                        }

                        const platformIcon = item.platform === 'telegram' ? 'fab fa-telegram text-primary' : 
                                            item.platform === 'bale' ? 'fas fa-envelope text-info' : 
                                            'fas fa-mobile-alt text-success';
                        const platformName = item.platform === 'telegram' ? 'تلگرام' : 
                                            item.platform === 'bale' ? 'بله' : 'ایتا';
                        const scopeBadge = getScopeBadge(item.scope);

                        const successRate = item.sent > 0 ? ((item.sent / (item.sent + item.failed)) * 100).toFixed(1) : 0;
                        row.innerHTML = `
                            <td>
                                <input type="checkbox" class="history-checkbox" value="${item.id}" onchange="updateDeleteHistoryButton()">
                            </td>
                            <td>
                                <i class="${platformIcon} me-2"></i>
                                <strong>${platformName}</strong>
                                <br><small class="text-muted">Batch #${item.batch_id}</small>
                            </td>
                            <td>${scopeBadge}</td>
                            <td>
                                <small class="text-muted">${contentPreview}</small>
                            </td>
                            <td>
                                <small class="text-muted">${item.timestamp}</small>
                            </td>
                            <td class="history-operations">
                                <div class="d-flex flex-column align-items-start">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge bg-success me-1">✅ ${item.sent}</span>
                                        <span class="badge bg-danger me-2">❌ ${item.failed}</span>
                                        <span class="badge bg-info">${successRate}%</span>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-outline-info btn-sm" onclick="viewPostStats(${item.batch_id})" title="مشاهده بازدید">
                                            <i class="fas fa-eye"></i> بازدید
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteBatch(${item.id}, event)" title="حذف ارسال">
                                            <i class="fas fa-trash-alt"></i> حذف
                                        </button>
                                    </div>
                                </div>
                            </td>
                        `;
                        historyList.appendChild(row);
                    }
                    
                    // Update pagination
                    totalHistoryPages = data.total_pages || 1;
                    updateHistoryPagination();
                }
            } catch (error) {
                console.error('Error fetching history:', error);
                historyList.innerHTML = '<tr><td colspan="6" class="text-center text-danger">❌ خطایی در بارگذاری تاریخچه رخ داد.</td></tr>';
            }
        }

        function getScopeBadge(scope) {
            const badges = {
                'private': '<span class="badge bg-primary"><i class="fas fa-user"></i> کاربران</span>',
                'group': '<span class="badge bg-secondary"><i class="fas fa-users"></i> گروه‌ها</span>',
                'channel': '<span class="badge bg-info"><i class="fas fa-broadcast-tower"></i> کانال‌ها</span>'
            };
            return badges[scope] || `<span class="badge bg-light text-dark">${scope}</span>`;
        }

        async function deleteBatch(batchId, event) {
            if (!confirm('آیا مطمئن هستید که می‌خواهید این ارسال را حذف کنید؟ این عمل غیرقابل بازگشت است.')) {
                return;
            }
            
            const deleteButton = event.target;
            const originalButtonText = deleteButton.innerHTML;
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال حذف...';

            try {
                const response = await fetch(`/api/delete_broadcast_batch/${batchId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const errorData = await response.json(); // Try to parse error JSON
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json(); // Should be success JSON

                alert(`✅ حذف موفق: ${data.deleted_from_platform} پیام حذف شد. (${data.failed_on_platform} ناموفق)`);
                fetchHistory(); // Refresh the list
                
            } catch (error) {
                console.error('Error deleting batch:', error);
                alert(`❌ خطای حذف: ${error.message}`);
            } finally {
                deleteButton.disabled = false;
                deleteButton.innerHTML = originalButtonText; // Restore original button text
            }
        }

        async function triggerReport(platform, event) {
            const reportButton = event.target;
            const originalButtonText = reportButton.innerHTML;
            reportButton.disabled = true;
            reportButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال ساخت...';

            // IMPORTANT: In a real scenario, you would dynamically get the current admin's ID.
            // For this project, it's hardcoded based on your OWNER_ID/BALE_OWNER_ID constants.
            // For a Flask app, user authentication is needed to get the current admin's ID.
            // Here, we assume a static admin ID for the current demonstration.
            let adminId;
            if (platform === 'telegram') {
                adminId = "0"; // TODO: Replace with actual Telegram admin ID from config
            } else if (platform === 'bale') {
                adminId = "0"; // TODO: Replace with actual Bale admin ID from config
            } else { // platform === 'ita'
                adminId = "YOUR_ITA_USER_ID_HERE"; // Replace with a mechanism to get actual Ita admin ID
            }


            const reportResponseDiv = document.getElementById('report-response');
            reportResponseDiv.classList.add('d-none'); // Hide previous responses

            try {
                const formData = new FormData();
                formData.append('user_id', adminId);

                const response = await fetch(`/api/trigger_report/${platform}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                reportResponseDiv.classList.remove('d-none', 'alert-danger');
                reportResponseDiv.classList.add('alert-success');
                reportResponseDiv.innerHTML = `✅ ${data.message}`;

            } catch (error) {
                reportResponseDiv.classList.remove('d-none', 'alert-success');
                reportResponseDiv.classList.add('alert-danger');
                reportResponseDiv.innerHTML = `❌ خطای ساخت گزارش: ${error.message}`;
                console.error('Error triggering report:', error);
            } finally {
                reportButton.disabled = false;
                reportButton.innerHTML = originalButtonText;
            }
        }

        // =================================================================
        // --- New JavaScript Functions for Segmentation and Scheduler ---
        // =================================================================

        // Segmentation Functions
        async function filterChats() {
            const platform = document.getElementById('filter-platform').value;
            const chatType = document.getElementById('filter-chat-type').value;
            const tags = document.getElementById('filter-tags').value;
            const isActive = document.getElementById('filter-active').value;
            
            const params = new URLSearchParams();
            if (platform) params.append('platform', platform);
            if (chatType) params.append('chat_type', chatType);
            if (tags) params.append('tags', tags);
            if (isActive) params.append('is_active', isActive);
            
            try {
                const response = await fetch(`/api/segmentation/chats?${params}`);
                if (!response.ok) throw new Error('خطا در دریافت داده‌ها');
                
                const chats = await response.json();
                displayFilteredChats(chats);
                updateChatSelect(chats);
            } catch (error) {
                console.error('Error filtering chats:', error);
                alert('خطا در فیلتر کردن چت‌ها: ' + error.message);
            }
        }

        function displayFilteredChats(chats) {
            const tbody = document.getElementById('filtered-chats');
            
            if (chats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">هیچ چتی یافت نشد</td></tr>';
                return;
            }
            
            tbody.innerHTML = chats.map(chat => `
                <tr>
                    <td>${chat.name || chat.chat_id}</td>
                    <td><span class="badge ${chat.platform === 'telegram' ? 'bg-primary' : 'bg-info'}">${chat.platform}</span></td>
                    <td>${getChatTypeDisplay(chat.chat_type)}</td>
                    <td>${chat.tags || '-'}</td>
                    <td>${formatDate(chat.last_active)}</td>
                    <td><span class="badge ${chat.is_active ? 'bg-success' : 'bg-secondary'}">${chat.is_active ? 'فعال' : 'غیرفعال'}</span></td>
                </tr>
            `).join('');
        }

        function updateChatSelect(chats) {
            const select = document.getElementById('selected-chat');
            select.innerHTML = '<option value="">انتخاب کنید...</option>';
            
            chats.forEach(chat => {
                const option = document.createElement('option');
                option.value = `${chat.chat_id}|${chat.platform}`;
                option.textContent = `${chat.name || chat.chat_id} (${chat.platform})`;
                select.appendChild(option);
            });
        }

        async function updateChatTags() {
            const selectedChat = document.getElementById('selected-chat').value;
            const tags = document.getElementById('chat-tags').value;
            
            if (!selectedChat) {
                alert('لطفاً یک چت انتخاب کنید');
                return;
            }
            
            const [chatId, platform] = selectedChat.split('|');
            
            try {
                const response = await fetch('/api/segmentation/update_tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        platform: platform,
                        tags: tags
                    })
                });
                
                if (!response.ok) throw new Error('خطا در به‌روزرسانی تگ‌ها');
                
                alert('تگ‌ها با موفقیت به‌روزرسانی شدند');
                filterChats(); // Refresh the list
            } catch (error) {
                console.error('Error updating tags:', error);
                alert('خطا در به‌روزرسانی تگ‌ها: ' + error.message);
            }
        }

        // Scheduler Functions
        const scheduleRecurring = document.getElementById('schedule-recurring');
        if (scheduleRecurring) {
            scheduleRecurring.addEventListener('change', function() {
            const patternDiv = document.getElementById('recurring-pattern');
                if (patternDiv) {
            patternDiv.style.display = this.checked ? 'block' : 'none';
                }
        });
        }

        const scheduleForm = document.getElementById('schedule-form');
        if (scheduleForm) {
            scheduleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const platform = document.getElementById('schedule-platform').value;
            const scopes = [];
            if (document.getElementById('schedule-private').checked) scopes.push('private');
            if (document.getElementById('schedule-group').checked) scopes.push('group');
            if (document.getElementById('schedule-channel').checked) scopes.push('channel');
            
            const scheduledTime = document.getElementById('schedule-datetime').value;
            const message = document.getElementById('schedule-message').value;
            const scheduleRecurringEl = document.getElementById('schedule-recurring');
            const isRecurring = scheduleRecurringEl ? scheduleRecurringEl.checked : false;
            const pattern = document.getElementById('schedule-pattern').value;
            
            if (!platform || scopes.length === 0 || !scheduledTime || !message) {
                alert('لطفاً تمام فیلدهای الزامی را پر کنید');
                return;
            }
            
            try {
                const response = await fetch('/api/scheduler/schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        platform: platform,
                        scopes: scopes,
                        scheduled_time: scheduledTime,
                        content_text: message,
                        is_recurring: isRecurring,
                        recurring_pattern: isRecurring ? pattern : null
                    })
                });
                
                if (!response.ok) throw new Error('خطا در زمان‌بندی ارسال');
                
                const data = await response.json();
                alert(`ارسال با موفقیت زمان‌بندی شد. شناسه: ${data.broadcast_id}`);
                
                // Reset form
                this.reset();
                document.getElementById('recurring-pattern').style.display = 'none';
                
                // Refresh scheduled broadcasts list
                loadScheduledBroadcasts();
            } catch (error) {
                console.error('Error scheduling broadcast:', error);
                alert('خطا در زمان‌بندی ارسال: ' + error.message);
            }
        });
        }

        async function loadScheduledBroadcasts() {
            try {
                console.log('Loading scheduled broadcasts...');
                const response = await fetch('/api/scheduled_broadcasts');
                if (!response.ok) throw new Error('خطا در دریافت لیست');
                
                const broadcasts = await response.json();
                console.log('Received broadcasts:', broadcasts);
                displayScheduledBroadcasts(broadcasts);
            } catch (error) {
                console.error('Error loading scheduled broadcasts:', error);
                const scheduledBroadcastsEl = document.getElementById('scheduled-broadcasts');
                if (scheduledBroadcastsEl) {
                    scheduledBroadcastsEl.innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">خطا در بارگذاری</td></tr>';
                }
            }
        }

        function displayScheduledBroadcasts(broadcasts) {
            const tbody = document.getElementById('scheduled-broadcasts');
            
            if (!tbody) {
                console.log('Element scheduled-broadcasts not found');
                return;
            }
            
            console.log('Displaying broadcasts:', broadcasts);
            
            if (broadcasts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">هیچ ارسال زمان‌بندی شده‌ای وجود ندارد</td></tr>';
                return;
            }
            
            tbody.innerHTML = broadcasts.map(broadcast => {
                // مدیریت platforms و scopes
                const platforms = Array.isArray(broadcast.platforms) ? broadcast.platforms : [];
                const scopes = Array.isArray(broadcast.scopes) ? broadcast.scopes : [];
                
                // نمایش platforms
                const platformBadges = platforms.map(platform => 
                    `<span class="badge ${platform === 'telegram' ? 'bg-primary' : platform === 'bale' ? 'bg-info' : 'bg-success'}">${platform}</span>`
                ).join(' ');
                
                // نمایش scopes
                const scopeText = scopes.join(', ');
                
                return `
                    <tr>
                        <td>${formatDate(broadcast.scheduled_time)}</td>
                        <td>${platformBadges}</td>
                        <td>${scopeText}</td>
                        <td><span class="badge ${getStatusBadgeClass(broadcast.status)}">${getStatusDisplay(broadcast.status)}</span></td>
                        <td>
                            ${broadcast.status === 'pending' ? 
                                `<button class="btn btn-sm btn-danger" onclick="cancelScheduledBroadcast(${broadcast.id})">لغو</button>` : 
                                '-'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function cancelScheduledBroadcast(broadcastId) {
            if (!confirm('آیا مطمئن هستید که می‌خواهید این ارسال را لغو کنید؟')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/scheduler/cancel/${broadcastId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('خطا در لغو ارسال');
                
                alert('ارسال با موفقیت لغو شد');
                loadScheduledBroadcasts();
            } catch (error) {
                console.error('Error cancelling broadcast:', error);
                alert('خطا در لغو ارسال: ' + error.message);
            }
        }

        // Helper Functions
        function getChatTypeDisplay(type) {
            const types = {
                'private': 'کاربران',
                'group': 'گروه‌ها',
                'channel': 'کانال‌ها'
            };
            return types[type] || type;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('fa-IR');
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'pending': 'bg-warning',
                'executing': 'bg-info',
                'completed': 'bg-success',
                'failed': 'bg-danger',
                'cancelled': 'bg-secondary'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusDisplay(status) {
            const displays = {
                'pending': 'در انتظار',
                'executing': 'در حال اجرا',
                'completed': 'تکمیل شده',
                'failed': 'ناموفق',
                'cancelled': 'لغو شده'
            };
            return displays[status] || status;
        }

        // Force Sync and Clear Cache Functions
        async function forceSync() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال سینک...';

            try {
                const response = await fetch('/api/force-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                alert(`✅ سینک اجباری با موفقیت انجام شد: ${data.message}`);
                fetchStats(); // Refresh stats after sync

            } catch (error) {
                console.error('Error in force sync:', error);
                alert(`❌ خطا در سینک اجباری: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function restoreBackup() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال بازیابی...';

            try {
                const response = await fetch('/api/restore-backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                alert(`✅ بازیابی از backup با موفقیت انجام شد: ${data.message}`);
                fetchStats(); // Refresh stats after restore

            } catch (error) {
                console.error('Error in restore backup:', error);
                alert(`❌ خطا در بازیابی از backup: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function clearCache() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال پاک کردن...';

            try {
                const response = await fetch('/api/clear-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                alert(`✅ کش با موفقیت پاک شد: ${data.message}`);
                fetchStats(); // Refresh stats after cache clear

            } catch (error) {
                console.error('Error in clear cache:', error);
                alert(`❌ خطا در پاک کردن کش: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Comprehensive Report Function
        async function generateComprehensiveReport() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال تولید...';

            try {
                const response = await fetch('/api/comprehensive_report', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // نمایش گزارش در یک modal یا alert
                displayComprehensiveReport(data);

            } catch (error) {
                console.error('Error generating comprehensive report:', error);
                alert(`❌ خطا در تولید گزارش مختصر: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Excel Report Download Function
        async function downloadExcelReport() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال تولید...';

            try {
                // انتخاب پلتفرم‌ها
                const platforms = ['telegram', 'bale', 'ita'];
                
                const response = await fetch('/api/generate_excel_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        platforms: platforms
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // دریافت فایل
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `گزارش_جامع_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                alert('✅ گزارش اکسلی با موفقیت دانلود شد!');

            } catch (error) {
                console.error('Error downloading Excel report:', error);
                alert(`❌ خطا در دانلود گزارش اکسلی: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function displayComprehensiveReport(data) {
            // ساخت محتوای گزارش
            let reportContent = `
                <div class="comprehensive-report">
                    <h4><i class="fas fa-chart-line"></i> گزارش مختصر سیستم</h4>
                    <p><strong>تاریخ تولید:</strong> ${data.report_generated_at}</p>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5><i class="fab fa-telegram text-primary"></i> تلگرام</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>👤 کاربران:</span>
                                    <span>${data.summary.telegram.users} چت (${data.summary.telegram.users_members} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>👥 گروه‌ها:</span>
                                    <span>${data.summary.telegram.groups} چت (${data.summary.telegram.groups_members} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>📢 کانال‌ها:</span>
                                    <span>${data.summary.telegram.channels} چت (${data.summary.telegram.channels_members} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>📊 مجموع:</strong></span>
                                    <span><strong>${data.summary.telegram.total_chats} چت (${data.summary.telegram.total_members} عضو)</strong></span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h5><i class="fas fa-envelope text-info"></i> بله</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>👤 کاربران:</span>
                                    <span>${data.summary.bale.users} چت (${data.summary.bale.users_members} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>👥 گروه‌ها:</span>
                                    <span>${data.summary.bale.groups} چت (${data.summary.bale.groups_members} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>📢 کانال‌ها:</span>
                                    <span>${data.summary.bale.channels} چت (${data.summary.bale.channels_members} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>📊 مجموع:</strong></span>
                                    <span><strong>${data.summary.bale.total_chats} چت (${data.summary.bale.total_members} عضو)</strong></span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h5><i class="fas fa-mobile-alt text-success"></i> ایتا</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>👤 کاربران:</span>
                                    <span>${data.summary.ita?.users || 0} چت (${data.summary.ita?.users_members || 0} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>👥 گروه‌ها:</span>
                                    <span>${data.summary.ita?.groups || 0} چت (${data.summary.ita?.groups_members || 0} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>📢 کانال‌ها:</span>
                                    <span>${data.summary.ita?.channels || 0} چت (${data.summary.ita?.channels_members || 0} عضو)</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span><strong>📊 مجموع:</strong></span>
                                    <span><strong>${data.summary.ita?.total_chats || 0} چت (${data.summary.ita?.total_members || 0} عضو)</strong></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-globe text-success"></i> آمار کلی سیستم</h5>
                            <div class="alert alert-success">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <h6>📊 کل چت‌ها</h6>
                                        <h4>${data.summary.grand_totals.total_chats}</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h6>👥 کل اعضا</h6>
                                        <h4>${data.summary.grand_totals.total_members}</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h6>👤 کل کاربران</h6>
                                        <h4>${data.summary.grand_totals.total_users}</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h6>👥 کل گروه‌ها</h6>
                                        <h4>${data.summary.grand_totals.total_groups}</h4>
                                    </div>
                                    <div class="col-md-3">
                                        <h6>📢 کل کانال‌ها</h6>
                                        <h4>${data.summary.grand_totals.total_channels}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-paper-plane text-warning"></i> آمار ارسال‌ها (30 روز اخیر)</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>پلتفرم</th>
                                            <th>تعداد ارسال‌ها</th>
                                            <th>موفق</th>
                                            <th>ناموفق</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            // اضافه کردن آمار ارسال‌ها
            for (const [platform, stats] of Object.entries(data.broadcast_statistics)) {
                const platformName = platform === 'telegram' ? 'تلگرام' : 
                                    platform === 'bale' ? 'بله' : 'ایتا';
                const platformIcon = platform === 'telegram' ? 'fab fa-telegram text-primary' : 
                                    platform === 'bale' ? 'fas fa-envelope text-info' : 
                                    'fas fa-mobile-alt text-success';
                reportContent += `
                    <tr>
                        <td><i class="${platformIcon}"></i> ${platformName}</td>
                        <td>${stats.total_broadcasts}</td>
                        <td class="text-success">${stats.total_sent}</td>
                        <td class="text-danger">${stats.total_failed}</td>
                    </tr>
                `;
            }
            
            reportContent += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5><i class="fas fa-list text-secondary"></i> لیست کامل چت‌ها (${data.detailed_chats.length} مورد)</h5>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>نام</th>
                                            <th>پلتفرم</th>
                                            <th>نوع</th>
                                            <th>اعضا</th>
                                            <th>آخرین بروزرسانی</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            // اضافه کردن لیست چت‌ها
            data.detailed_chats.forEach(chat => {
                const platformIcon = chat.platform === 'telegram' ? 'fab fa-telegram text-primary' : 
                                    chat.platform === 'bale' ? 'fas fa-envelope text-info' : 
                                    'fas fa-mobile-alt text-success';
                const chatTypeIcon = chat.chat_type === 'private' ? '👤' : chat.chat_type === 'group' ? '👥' : '📢';
                const chatTypeName = chat.chat_type === 'private' ? 'کاربر' : chat.chat_type === 'group' ? 'گروه' : 'کانال';
                
                reportContent += `
                    <tr>
                        <td>${chat.name || chat.chat_id}</td>
                        <td><i class="${platformIcon}"></i> ${chat.platform}</td>
                        <td>${chatTypeIcon} ${chatTypeName}</td>
                        <td>${chat.current_members}</td>
                        <td>${chat.last_metrics_update || '-'}</td>
                    </tr>
                `;
            });
            
            reportContent += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // نمایش در modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-chart-line"></i> گزارش مختصر سیستم</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${reportContent}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                            <button type="button" class="btn btn-primary" onclick="downloadReport()">
                                <i class="fas fa-download"></i> دانلود JSON
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // ذخیره داده‌ها برای دانلود
            window.currentReportData = data;
            
            // حذف modal بعد از بسته شدن
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        function downloadReport() {
            if (window.currentReportData) {
                const dataStr = JSON.stringify(window.currentReportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `comprehensive_report_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }

        // Load available tags
        async function loadAvailableTags() {
            try {
                const response = await fetch('/api/get-all-tags');
                if (response.ok) {
                    const responseData = await response.json();
                    const tags = responseData.tags || responseData; // پشتیبانی از هر دو فرمت
                    const availableTagsDiv = document.getElementById('available-tags');
                    if (availableTagsDiv && tags && tags.length > 0) {
                        availableTagsDiv.innerHTML = tags.map(tag => 
                            `<span class="badge bg-light text-dark me-1 mb-1" style="cursor: pointer;" onclick="addTagToInput('${tag}')">${tag}</span>`
                        ).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }
        
        // Add tag to input
        function addTagToInput(tag) {
            const tagsInput = document.getElementById('chat-tags');
            const currentTags = tagsInput.value.trim();
            if (currentTags) {
                const tags = currentTags.split(',').map(t => t.trim());
                if (!tags.includes(tag)) {
                    tagsInput.value = currentTags + ', ' + tag;
                }
            } else {
                tagsInput.value = tag;
            }
        }

        // Initialize new features on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadScheduledBroadcasts();
            loadRegisteredChats(); // Force refresh to get latest data
            setupChatForm();
            setupChatListFilters();
            loadAvailableTags();
        });

        // تابع بارگذاری تگ‌ها برای انتخاب در ارسال انبوه
        async function loadTagOptions() {
            try {
                const response = await fetch('/api/get-all-tags');
                if (response.ok) {
                    const data = await response.json();
                    const tags = data.tags || [];
                    const select = document.getElementById('selected-tag');
                    select.innerHTML = '';
                    tags.forEach(tag => {
                        const opt = document.createElement('option');
                        opt.value = tag;
                        opt.textContent = tag;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Error loading tags:', e);
            }
        }

        // تابع نمایش/مخفی کردن انتخابگر تگ
        function toggleTagSelector() {
            const isChecked = document.getElementById('send-to-tagged').checked;
            const selector = document.getElementById('tag-selector');
            if (isChecked) {
                selector.classList.remove('d-none');
                loadTagOptions();
            } else {
                selector.classList.add('d-none');
            }
        }

        // تابع نمایش/مخفی کردن انتخابگر تگ برای ارسال زماندار
        function toggleScheduledTagSelector() {
            const isChecked = document.getElementById('scheduled-send-to-tagged').checked;
            const selector = document.getElementById('scheduled-tag-selector');
            if (isChecked) {
                selector.classList.remove('d-none');
                loadScheduledTagOptions();
            } else {
                selector.classList.add('d-none');
            }
        }

        // تابع بارگذاری تگ‌ها برای انتخاب در ارسال زماندار
        async function loadScheduledTagOptions() {
            try {
                const response = await fetch('/api/get-all-tags');
                if (response.ok) {
                    const data = await response.json();
                    const tags = data.tags || [];
                    const select = document.getElementById('scheduled-selected-tag');
                    select.innerHTML = '';
                    tags.forEach(tag => {
                        const opt = document.createElement('option');
                        opt.value = tag;
                        opt.textContent = tag;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Error loading tags for scheduled broadcast:', e);
            }
        }

        // تابع نمایش پیام
        function showFormAlert(message, type = 'info') {
            const alertContainer = document.getElementById('form-alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // حذف خودکار بعد از 5 ثانیه
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Smart Chat ID Analysis Functions
        function detectIdType(chatId) {
            if (!chatId) return null;
            
            // Remove @ symbol if present
            const cleanId = chatId.replace(/^@/, '');
            
            if (/^\d+$/.test(cleanId)) {
                return 'numeric';
            } else if (/^[a-zA-Z0-9_]+$/.test(cleanId)) {
                return 'username';
            } else {
                return 'unknown';
            }
        }

        function updateIdTypeDetection(chatId) {
            const detectionDiv = document.getElementById('id-type-detection');
            if (!detectionDiv) return;
            
            if (!chatId) {
                detectionDiv.textContent = '';
                detectionDiv.className = 'form-text text-muted mt-1';
                return;
            }
            
            const idType = detectIdType(chatId);
            
            switch (idType) {
                case 'numeric':
                    detectionDiv.innerHTML = '<i class="fas fa-hashtag text-primary"></i> شناسه عددی تشخیص داده شد - استفاده از API';
                    detectionDiv.className = 'form-text text-primary mt-1';
                    break;
                case 'username':
                    detectionDiv.innerHTML = '<i class="fas fa-user text-success"></i> نام کاربری تشخیص داده شد - استفاده از Kit';
                    detectionDiv.className = 'form-text text-success mt-1';
                    break;
                default:
                    detectionDiv.innerHTML = '<i class="fas fa-question text-warning"></i> نوع شناسه نامشخص';
                    detectionDiv.className = 'form-text text-warning mt-1';
            }
        }

        async function analyzeChatId(chatId, platform, quickMode = false) {
            if (!chatId) {
                showFormAlert('لطفاً شناسه چت را وارد کنید', 'danger');
                return null;
            }
            
            if (!platform) {
                showFormAlert('لطفاً پلتفرم را انتخاب کنید', 'danger');
                return null;
            }
            
            try {
                const response = await fetch('/api/analyze_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        platform: platform,
                        quick_mode: quickMode
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('Analysis error:', error);
                showFormAlert('خطا در تحلیل: ' + error.message, 'danger');
                return null;
            }
        }

        function displayAnalysisResults(result) {
            const resultsDiv = document.getElementById('analysis-results');
            const detailsDiv = document.getElementById('analysis-details');
            const autoFillBtn = document.getElementById('auto-fill-btn');
            
            if (!result || !result.success) {
                detailsDiv.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> تحلیل ناموفق: ' + (result?.error || 'خطای نامشخص') + '</div>';
                resultsDiv.style.display = 'block';
                autoFillBtn.style.display = 'none';
                return;
            }
            
            const data = result.data;
            let html = '<div class="row">';
            
            // Basic info
            html += '<div class="col-md-6">';
            html += '<h6><i class="fas fa-info-circle text-primary"></i> اطلاعات پایه:</h6>';
            html += '<ul class="list-unstyled">';
            html += `<li><strong>شناسه:</strong> ${data.id || 'نامشخص'}</li>`;
            html += `<li><strong>نام:</strong> ${data.name || 'نامشخص'}</li>`;
            html += `<li><strong>نام کاربری:</strong> ${data.username || 'ندارد'}</li>`;
            html += `<li><strong>نوع:</strong> ${data.type || 'نامشخص'}</li>`;
            html += '</ul>';
            html += '</div>';
            
            // Additional info
            html += '<div class="col-md-6">';
            html += '<h6><i class="fas fa-chart-bar text-success"></i> جزئیات:</h6>';
            html += '<ul class="list-unstyled">';
            html += `<li><strong>تعداد اعضا:</strong> ${data.users || 'نامشخص'}</li>`;
            html += `<li><strong>خصوصی:</strong> ${data.is_private ? 'بله' : 'خیر'}</li>`;
            html += `<li><strong>کانال:</strong> ${data.is_channel ? 'بله' : 'خیر'}</li>`;
            html += `<li><strong>گروه:</strong> ${data.is_group ? 'بله' : 'خیر'}</li>`;
            html += `<li><strong>روش تحلیل:</strong> ${data.method || 'نامشخص'}</li>`;
            html += '</ul>';
            html += '</div>';
            
            html += '</div>';
            
            if (data.description && data.description !== 'None') {
                html += '<div class="mt-2">';
                html += '<h6><i class="fas fa-align-right text-info"></i> توضیحات:</h6>';
                html += `<p class="text-muted">${data.description}</p>`;
                html += '</div>';
            }
            
            detailsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            autoFillBtn.style.display = 'inline-block';
            
            // Store analysis result for auto-fill
            window.lastAnalysisResult = result;
        }

        function autoFillFormFromAnalysis() {
            if (!window.lastAnalysisResult || !window.lastAnalysisResult.success) {
                showFormAlert('هیچ نتیجه تحلیلی برای پر کردن فرم وجود ندارد', 'warning');
                return;
            }
            
            const data = window.lastAnalysisResult.data;
            
            // Fill the registration form
            const chatIdInput = document.getElementById('chat-id');
            const platformSelect = document.getElementById('platform');
            const chatNameInput = document.getElementById('chat-name');
            const chatUsernameInput = document.getElementById('chat-username');
            const chatTypeSelect = document.getElementById('chat-type');
            
            if (chatIdInput) chatIdInput.value = data.id || '';
            if (chatNameInput) chatNameInput.value = data.name || '';
            if (chatUsernameInput) chatUsernameInput.value = data.username ? data.username.replace('@', '') : '';
            
            // Set platform based on analysis
            if (platformSelect) {
                const analyzePlatform = document.getElementById('analyze-platform').value;
                if (analyzePlatform) {
                    platformSelect.value = analyzePlatform;
                }
            }
            
            // Set chat type based on analysis
            if (chatTypeSelect && data.type) {
                if (data.is_channel) {
                    chatTypeSelect.value = 'channel';
                } else if (data.is_group) {
                    chatTypeSelect.value = 'group';
                } else {
                    chatTypeSelect.value = 'private';
                }
            }
            
            showFormAlert('فرم با اطلاعات تحلیل شده پر شد', 'success');
        }

        function setupChatAnalysis() {
            const analyzeChatIdInput = document.getElementById('analyze-chat-id');
            const analyzePlatformSelect = document.getElementById('analyze-platform');
            const analyzeBtn = document.getElementById('analyze-chat-btn');
            const quickAnalyzeBtn = document.getElementById('quick-analyze-btn');
            const autoFillBtn = document.getElementById('auto-fill-btn');
            
            // ID type detection on input
            if (analyzeChatIdInput) {
                analyzeChatIdInput.addEventListener('input', function() {
                    updateIdTypeDetection(this.value);
                });
            }
            
            // Smart analysis button
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', async function() {
                    const chatId = analyzeChatIdInput?.value?.trim();
                    const platform = analyzePlatformSelect?.value;
                    
                    if (!chatId || !platform) {
                        showFormAlert('لطفاً شناسه چت و پلتفرم را وارد کنید', 'danger');
                        return;
                    }
                    
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال تحلیل...';
                    
                    try {
                        const result = await analyzeChatId(chatId, platform, false);
                        displayAnalysisResults(result);
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-search"></i> تحلیل هوشمند';
                    }
                });
            }
            
            // Quick analysis button
            if (quickAnalyzeBtn) {
                quickAnalyzeBtn.addEventListener('click', async function() {
                    const chatId = analyzeChatIdInput?.value?.trim();
                    const platform = analyzePlatformSelect?.value;
                    
                    if (!chatId || !platform) {
                        showFormAlert('لطفاً شناسه چت و پلتفرم را وارد کنید', 'danger');
                        return;
                    }
                    
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> تحلیل سریع...';
                    
                    try {
                        const result = await analyzeChatId(chatId, platform, true);
                        displayAnalysisResults(result);
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-bolt"></i> تحلیل سریع';
                    }
                });
            }
            
            // Auto-fill button
            if (autoFillBtn) {
                autoFillBtn.addEventListener('click', autoFillFormFromAnalysis);
            }
        }

        // Setup chat registration form
        function setupChatForm() {
            console.log('🔧 Setting up chat form...');
            const form = document.getElementById('manual-register-form');
            console.log('📋 Form element found:', form);
            const chatIdInput = document.getElementById('chat-id');
            const platformSelect = document.getElementById('platform');
            const chatTypeSelect = document.getElementById('chat-type');
            const chatNameInput = document.getElementById('chat-name');
            const chatUsernameInput = document.getElementById('chat-username');
            const chatMemberCountInput = document.getElementById('chat-member-count');
            const chatTagsInput = document.getElementById('chat-tags');
            
            console.log('🔍 Form elements found:', {
                form: !!form,
                chatIdInput: !!chatIdInput,
                platformSelect: !!platformSelect,
                chatTypeSelect: !!chatTypeSelect,
                chatNameInput: !!chatNameInput,
                chatUsernameInput: !!chatUsernameInput,
                chatMemberCountInput: !!chatMemberCountInput,
                chatTagsInput: !!chatTagsInput
            });
            const submitButton = document.getElementById('submit-button');
            const cancelEditButton = document.getElementById('cancel-edit');
            const editModeInput = document.getElementById('edit-mode');
            const originalChatIdInput = document.getElementById('original-chat-id');
            const originalPlatformInput = document.getElementById('original-platform');
            // const autoDetectInfo = document.getElementById('auto-detect-info'); // Element not found in HTML
            // const detectedPlatform = document.getElementById('detected-platform'); // Element not found in HTML

            // Input validation for chat ID only
            chatIdInput.addEventListener('blur', function() {
                let chatId = this.value.trim();
                if (!chatId) {
                    return;
                }
                
                // Remove any non-numeric characters except minus
                chatId = chatId.replace(/[^\d-]/g, '');
                this.value = chatId;
                
                // Auto-detect info removed (element not found in HTML)
            });
            
            // Ensure chat ID is numeric
            chatIdInput.addEventListener('input', function() {
                let value = this.value;
                // Allow only numbers and minus sign
                this.value = value.replace(/[^\d-]/g, '');
            });

            // Handle form submission
            console.log('📝 Adding form submit event listener...');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('🚀 Form submit event triggered');
                
                const chatId = chatIdInput.value.trim();
                const platform = platformSelect.value;
                const chatType = chatTypeSelect.value;
                const chatName = chatNameInput.value.trim();
                const chatUsername = (chatUsernameInput.value || '').replace('@', '').trim();
                const chatMemberCount = parseInt(chatMemberCountInput.value) || 0;
                const chatTags = chatTagsInput.value.trim();
                const isEditMode = editModeInput.value === 'true';

                console.log('📝 Form data:', {
                    chatId, platform, chatType, chatName, chatUsername, chatMemberCount, chatTags, isEditMode
                });

                // Validation
                console.log('🔍 Starting validation...');
                if (!chatId) {
                    console.log('❌ Validation failed: No chat ID');
                    showFormAlert('لطفاً شناسه عددی را وارد کنید', 'danger');
                    chatIdInput.focus();
                    return;
                }
                if (!platform) {
                    console.log('❌ Validation failed: No platform');
                    showFormAlert('لطفاً پلتفرم را انتخاب کنید', 'danger');
                    platformSelect.focus();
                    return;
                }
                console.log('✅ Validation passed');

                // Check if chat already exists
                console.log('🔍 Checking if chat exists...');
                try {
                    const checkData = { chat_id: chatId, platform: platform };
                    console.log('📤 Sending check request:', checkData);
                    
                    const checkResponse = await fetch('/api/check_chat_exists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(checkData)
                    });
                    
                    console.log('📥 Check response status:', checkResponse.status);
                    
                    if (checkResponse.ok) {
                        const checkResult = await checkResponse.json();
                        console.log('📥 Check result:', checkResult);
                        if (checkResult.exists && !isEditMode) {
                            console.log('⚠️ Chat already exists, showing warning');
                            showFormAlert('این چت قبلاً ثبت شده است. برای ویرایش از دکمه ویرایش استفاده کنید.', 'warning');
                            return;
                        }
                    } else {
                        console.log('❌ Check request failed:', checkResponse.status);
                    }
                } catch (err) {
                    console.warn('❌ Could not check for existing chat:', err);
                }

                // Show loading
                console.log('⏳ Showing loading state...');
                submitButton.disabled = true;
                submitButton.querySelector('.loading').classList.add('show');
                submitButton.querySelector('i').style.display = 'none';

                const chatData = {
                    chat_id: chatId,
                    chat_type: chatType,
                    platform: platform,
                    name: chatName || null,
                    username: chatUsername || null,
                    member_count: chatMemberCount,
                    tags: chatTags || null
                };
                
                console.log('📦 Prepared chat data:', chatData);

                try {
                    console.log('🚀 Starting API request...');
                    let response;
                    if (isEditMode) {
                        console.log('✏️ Edit mode detected');
                        // In edit mode, we need to delete the old record if chat_id or platform changed
                        const originalChatId = originalChatIdInput.value;
                        const originalPlatform = originalPlatformInput.value;
                        
                        if (chatId !== originalChatId || platform !== originalPlatform) {
                            console.log('🔄 Chat ID or platform changed, deleting old record');
                            // Delete old record
                            await fetch(`/api/delete_chat`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    chat_id: originalChatId,
                                    platform: originalPlatform
                                })
                            });
                        }
                        
                        // Update chat
                        console.log('📤 Sending update request...');
                        response = await fetch('/api/update_chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(chatData)
                        });
                    } else {
                        console.log('➕ Create mode detected');
                        // Create new chat
                        console.log('📤 Sending create request...');
                        response = await fetch('/api/manual_register_chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(chatData)
                        });
                    }
                    
                    console.log('📥 Response received, status:', response.status);

                    const result = await response.json();
                    console.log('📥 Response result:', result);
                    
                    if (result.success) {
                        console.log('✅ Success! Chat registered');
                        showFormAlert(result.message || '✅ چت با موفقیت ثبت شد', 'success');
                        resetForm();
                        loadRegisteredChats();
                    } else {
                        console.log('❌ Failed! Error:', result.error || result.message);
                        showFormAlert('❌ ' + (result.error || result.message || 'خطا در ثبت چت'), 'danger');
                    }
                } catch (error) {
                    console.error('❌ Exception in form submission:', error);
                    showFormAlert('❌ خطا در اتصال به سرور: ' + error.message, 'danger');
                } finally {
                    console.log('🔄 Hiding loading state...');
                    // Hide loading
                    submitButton.disabled = false;
                    submitButton.querySelector('.loading').classList.remove('show');
                    submitButton.querySelector('i').style.display = 'inline';
                }
            });

            // Handle cancel edit
            cancelEditButton.addEventListener('click', resetForm);

            // Reset form to add new chat
            function resetForm() {
                form.reset();
                editModeInput.value = 'false';
                originalChatIdInput.value = '';
                originalPlatformInput.value = '';
                cancelEditButton.style.display = 'none';
                submitButton.innerHTML = '<span class="loading spinner-border spinner-border-sm" role="status"></span><i class="fas fa-save"></i> ثبت چت';
            }

            // Set form to edit mode
            window.editChat = function(chatId, platform, chatType, name, username, tags, memberCount) {
                chatIdInput.value = chatId;
                platformSelect.value = platform;
                chatTypeSelect.value = chatType || 'channel';
                chatNameInput.value = name || '';
                chatUsernameInput.value = username || '';
                chatMemberCountInput.value = memberCount || 0;
                chatTagsInput.value = tags || '';
                
                editModeInput.value = 'true';
                originalChatIdInput.value = chatId;
                originalPlatformInput.value = platform;
                
                submitButton.innerHTML = '<span class="loading spinner-border spinner-border-sm" role="status"></span><i class="fas fa-save"></i> ذخیره تغییرات';
                submitButton.classList.remove('btn-primary');
                submitButton.classList.add('btn-warning');
                cancelEditButton.style.display = 'block';
                
                // Scroll to form
                form.scrollIntoView({ behavior: 'smooth' });
            };
        }

        // Update current filters display
        function updateCurrentFiltersDisplay() {
            const filterPlatform = document.getElementById('filter-platform')?.value || 'all';
            const filterType = document.getElementById('filter-type')?.value || 'all';
            const searchQuery = document.getElementById('chat-search')?.value.trim() || '';
            
            // Update platform filter display
            const platformElement = document.getElementById('current-platform-filter');
            if (platformElement) {
                const platformText = filterPlatform === 'all' ? 'همه' : 
                    filterPlatform === 'telegram' ? 'تلگرام' :
                    filterPlatform === 'bale' ? 'بله' :
                    filterPlatform === 'ita' ? 'ایتا' : filterPlatform;
                platformElement.textContent = platformText;
                platformElement.className = `badge ${filterPlatform === 'all' ? 'bg-secondary' : 'bg-primary'}`;
            }
            
            // Update type filter display
            const typeElement = document.getElementById('current-type-filter');
            if (typeElement) {
                const typeText = filterType === 'all' ? 'همه' :
                    filterType === 'channel' ? 'کانال' :
                    filterType === 'group' ? 'گروه' :
                    filterType === 'private' ? 'خصوصی' : filterType;
                typeElement.textContent = typeText;
                typeElement.className = `badge ${filterType === 'all' ? 'bg-secondary' : 'bg-info'}`;
            }
            
            // Update search filter display
            const searchElement = document.getElementById('current-search-filter');
            if (searchElement) {
                if (searchQuery) {
                    searchElement.textContent = `"${searchQuery}"`;
                    searchElement.className = 'badge bg-warning text-dark';
                } else {
                    searchElement.textContent = '-';
                    searchElement.className = 'badge bg-secondary';
                }
            }
        }

        // Setup chat list filters
        function setupChatListFilters() {
            const filterPlatform = document.getElementById('filter-platform');
            const filterType = document.getElementById('filter-type');
            const searchInput = document.getElementById('chat-search');
            
            console.log('🔧 Setting up filters:', { filterPlatform, filterType, searchInput });
            
            [filterPlatform, filterType, searchInput].forEach(element => {
                if (element) {
                    console.log('✅ Adding change listener to:', element.id);
                    element.addEventListener('change', function() {
                        console.log('🔄 Filter changed:', element.id, 'value:', element.value);
                        updateCurrentFiltersDisplay();
                        loadRegisteredChats();
                    });
                } else {
                    console.warn('❌ Element not found:', element);
                }
            });
            
            if (searchInput) {
                console.log('✅ Adding input listener to search');
                // Debounced search
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        console.log('🔍 Search input changed:', searchInput.value);
                        updateCurrentFiltersDisplay();
                        loadRegisteredChats();
                    }, 300); // 300ms delay
                });
            }
            
            // Initialize filters display
            updateCurrentFiltersDisplay();
        }

        // Load registered chats with filters
        // Pagination variables
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalChats = 0;
        let allChats = [];
        
        // Auto-refresh variables
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;
        let autoRefreshIntervalTime = 45000; // 45 seconds
        let refreshCount = 0;

        async function loadRegisteredChats(page = 1) {
            currentPage = page;
            const filterPlatform = document.getElementById('filter-platform')?.value || 'all';
            const filterType = document.getElementById('filter-type')?.value || 'all';
            const searchQuery = document.getElementById('chat-search')?.value.trim() || '';
            
            console.log('🔍 Filter values:', { filterPlatform, filterType, searchQuery });
            
            // Show loading state
            const tbody = document.querySelector('#chats-table tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">در حال بارگذاری...</span>
                            </div>
                            <p class="mt-2 text-muted">در حال بارگذاری لیست چت‌ها</p>
                        </td>
                    </tr>
                `;
            }
            
            try {
                const url = `/api/list_chats_v2?platform=${filterPlatform}&type=${filterType}&q=${encodeURIComponent(searchQuery)}&_t=${Date.now()}`;
                console.log('🌐 Fetching URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const chats = await response.json();
                console.log('📥 API Response:', chats);
                
                // Update total count
                const totalCountElement = document.getElementById('total-chats');
                if (totalCountElement) {
                    totalCountElement.textContent = chats.length.toLocaleString('fa-IR');
                }
                
                // Show/hide no results message
                const noResultsElement = document.getElementById('no-chats-message');
                if (noResultsElement) {
                    if (chats.length === 0) {
                        noResultsElement.classList.remove('d-none');
                    } else {
                        noResultsElement.classList.add('d-none');
                    }
                }
                
                displayRegisteredChats(chats);
                
                // Update last refresh time
                updateLastRefreshTime();
            } catch (error) {
                console.error('Error loading chats:', error);
                showAlert('خطا در بارگذاری لیست چت‌ها', 'danger');
                
                // Show error state in table
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4 text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p class="mt-2">خطا در بارگذاری لیست چت‌ها</p>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadRegisteredChats()">
                                    <i class="fas fa-sync"></i> تلاش مجدد
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Display registered chats in the table with pagination
        function displayRegisteredChats(chats) {
            const tbody = document.querySelector('#chats-table tbody');
            if (!tbody) return;
            
            // Store all chats for pagination
            allChats = chats;
            totalChats = chats.length;
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedChats = chats.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            if (!paginatedChats || paginatedChats.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="9" class="text-center py-4">موردی یافت نشد</td>';
                tbody.appendChild(tr);
                updatePagination();
                return;
            }
            
            paginatedChats.forEach(chat => {
                const tr = document.createElement('tr');
                
                // Platform icon
                let platformIcon = '';
                let platformName = '';
                switch(chat.platform) {
                    case 'telegram':
                        platformIcon = '<i class="fab fa-telegram text-primary"></i>';
                        platformName = 'تلگرام';
                        break;
                    case 'bale':
                        platformIcon = '<i class="fas fa-envelope text-info"></i>';
                        platformName = 'بله';
                        break;
                    case 'ita':
                        platformIcon = '<i class="fas fa-mobile-alt text-success"></i>';
                        platformName = 'ایتا';
                        break;
                    default:
                        platformIcon = '<i class="fas fa-question-circle"></i>';
                        platformName = chat.platform || 'نامشخص';
                }
                
                // Chat type
                let typeBadge = '';
                switch(chat.chat_type) {
                    case 'channel':
                        typeBadge = '<span class="badge bg-primary">کانال</span>';
                        break;
                    case 'group':
                        typeBadge = '<span class="badge bg-success">گروه</span>';
                        break;
                    case 'private':
                        typeBadge = '<span class="badge bg-secondary">خصوصی</span>';
                        break;
                    default:
                        typeBadge = `<span class="badge bg-light text-dark">${chat.chat_type || 'نامشخص'}</span>`;
                }
                
                // Last active
                const lastActive = chat.last_active ? new Date(chat.last_active).toLocaleString('fa-IR') : 'نامشخص';
                
                // Member count
                const memberCount = chat.member_count || chat.members_count || 0;
                const memberCountDisplay = memberCount > 0 ? 
                    `<span class="badge bg-info">${memberCount.toLocaleString('fa-IR')}</span>` : 
                    '<span class="text-muted">نامشخص</span>';
                
                // Tags display
                let tagsDisplay = '<span class="text-muted">-</span>';
                if (chat.tags && chat.tags.trim()) {
                    const tags = chat.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                    if (tags.length > 0) {
                        tagsDisplay = tags.map(tag => `<span class="badge bg-warning text-dark me-1">${escapeHtml(tag)}</span>`).join('');
                    }
                }
                
                // Action buttons
                const editButton = `<button class="btn btn-sm btn-outline-primary" 
                    onclick="editChat('${chat.chat_id}', '${chat.platform}', '${chat.chat_type}', '${escapeHtml(chat.name || '')}', '${escapeHtml(chat.username || '')}', '${escapeHtml(chat.tags || '')}', ${memberCount})">
                    <i class="fas fa-edit"></i>
                </button>`;
                
                const deleteButton = `<button class="btn btn-sm btn-outline-danger" 
                    onclick="deleteChat('${chat.chat_id}', '${chat.platform}')">
                    <i class="fas fa-trash"></i>
                </button>`;
                
                const editMemberCountButton = `<button class="btn btn-sm btn-outline-warning" 
                    onclick="editMemberCount('${chat.chat_id}', '${chat.platform}', ${memberCount})" title="ویرایش تعداد اعضا">
                    <i class="fas fa-users"></i>
                </button>`;
                
                // Format created date
                const createdDate = chat.created_at ? new Date(chat.created_at).toLocaleDateString('fa-IR') : 'نامشخص';
                
                tr.innerHTML = `
                    <td style="width: 40px;">
                        <input type="checkbox" class="chat-checkbox" data-chat-id="${chat.chat_id}" data-platform="${chat.platform}" onchange="updateBulkDeleteButton()">
                    </td>
                    <td style="width: 100px;">${platformIcon} ${platformName}</td>
                    <td style="width: 80px;">${typeBadge}</td>
                    <td style="width: 150px;"><code class="text-primary" style="font-size: 0.8rem;">${chat.chat_id}</code></td>
                    <td style="width: 200px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(chat.name || 'بدون نام')}">${escapeHtml(chat.name || 'بدون نام')}</td>
                    <td style="width: 150px;">${chat.username ? '<span class="text-info">@' + escapeHtml(chat.username) + '</span>' : '<span class="text-muted">-</span>'}</td>
                    <td style="width: 100px;">${memberCountDisplay}</td>
                    <td style="width: 150px;">${tagsDisplay}</td>
                    <td style="width: 120px;"><small class="text-muted">${createdDate}</small></td>
                    <td style="width: 100px;">
                        <div class="btn-group btn-group-sm">
                            ${editButton}
                            ${editMemberCountButton}
                            ${deleteButton}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Update total count
            const totalChatsElement = document.getElementById('total-chats');
            if (totalChatsElement) {
                totalChatsElement.textContent = chats.length;
            }
            
            // Update pagination
            updatePagination();
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(totalChats / itemsPerPage);
            const paginationContainer = document.getElementById('pagination-container');
            
            if (!paginationContainer) return;
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<nav aria-label="Page navigation"><ul class="pagination justify-content-center">';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadRegisteredChats(${currentPage - 1})">قبلی</a></li>`;
            } else {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">قبلی</span></li>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadRegisteredChats(${i})">${i}</a></li>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadRegisteredChats(${currentPage + 1})">بعدی</a></li>`;
            } else {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">بعدی</span></li>`;
            }
            
            paginationHTML += '</ul></nav>';
            
            // Add page info
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalChats);
            paginationHTML += `<div class="text-center text-muted mt-2">نمایش ${startItem} تا ${endItem} از ${totalChats} چت</div>`;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        // Edit member count function
        async function editMemberCount(chatId, platform, currentCount) {
            const newCount = prompt(`ویرایش تعداد اعضا برای چت ${chatId}:\n\nتعداد فعلی: ${currentCount}\nتعداد جدید:`, currentCount);
            
            if (newCount === null) return; // User cancelled
            
            const memberCount = parseInt(newCount);
            if (isNaN(memberCount) || memberCount < 0) {
                alert('❌ تعداد اعضا باید یک عدد مثبت باشد');
                return;
            }
            
            try {
                const response = await fetch('/api/update_chat_member_count', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        platform: platform,
                        member_count: memberCount
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ تعداد اعضا با موفقیت به‌روزرسانی شد');
                    loadRegisteredChats(); // Refresh the list
                } else {
                    alert('❌ خطا در به‌روزرسانی تعداد اعضا: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating member count:', error);
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }

        // Sync all member counts
        async function syncAllMemberCounts() {
            const button = document.getElementById('sync-members-btn');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال همگام‌سازی...';
            
            try {
                const response = await fetch('/api/sync_all_member_counts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ همگام‌سازی تکمیل شد!\n\nتعداد به‌روزرسانی شده: ${result.updated_count}\nتعداد ناموفق: ${result.failed_count}\nکل چت‌ها: ${result.total_chats}`);
                    loadRegisteredChats(); // Refresh the list
                } else {
                    alert('❌ خطا در همگام‌سازی: ' + result.error);
                }
            } catch (error) {
                console.error('Error syncing member counts:', error);
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            } finally {
                // Reset button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Show register from message modal
        function showRegisterFromMessageModal() {
            const modal = new bootstrap.Modal(document.getElementById('registerFromMessageModal'));
            modal.show();
        }

        // Submit register from message
        async function submitRegisterFromMessage() {
            const messageResponseText = document.getElementById('message-response').value.trim();
            const chatType = document.getElementById('message-chat-type').value;
            const chatName = document.getElementById('message-chat-name').value.trim();
            const chatUsername = document.getElementById('message-chat-username').value.trim();
            
            if (!messageResponseText) {
                alert('❌ لطفاً پاسخ API پیام ارسالی را وارد کنید');
                return;
            }
            
            try {
                // Parse JSON to validate
                const messageResponse = JSON.parse(messageResponseText);
                
                if (!messageResponse.ok) {
                    alert('❌ پیام با موفقیت ارسال نشده است');
                    return;
                }
                
                if (!messageResponse.result || !messageResponse.result.chat) {
                    alert('❌ اطلاعات چت در پاسخ API موجود نیست');
                    return;
                }
                
                // Show loading
                const submitButton = event.target;
                const originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال ثبت...';
                
                // Send request
                const response = await fetch('/api/register_ita_from_sent_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_response: messageResponse,
                        chat_type: chatType,
                        name: chatName || undefined,
                        username: chatUsername || undefined
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ چت با موفقیت از پیام ارسالی ثبت شد');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('registerFromMessageModal'));
                    modal.hide();
                    // Refresh chat list
                    loadRegisteredChats();
                } else {
                    alert('❌ خطا در ثبت چت: ' + result.error);
                }
                
            } catch (error) {
                if (error instanceof SyntaxError) {
                    alert('❌ فرمت JSON نامعتبر است');
                } else {
                    console.error('Error registering from message:', error);
                    alert('❌ خطا در اتصال به سرور: ' + error.message);
                }
            } finally {
                // Reset button
                const submitButton = event.target;
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i>ثبت چت';
            }
        }

        // Delete chat
        async function deleteChat(chatId, platform) {
            if (!confirm('آیا از حذف این چت اطمینان دارید؟ این عمل قابل بازگشت نیست.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete_chat?_t=${Date.now()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, platform: platform })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFormAlert('✅ چت با موفقیت حذف شد', 'success');
                    loadRegisteredChats();
                } else {
                    if (result.error && result.error.includes('Chat not found')) {
                        showFormAlert('⚠️ این چت در دیتابیس یافت نشد. لیست چت‌ها به‌روزرسانی می‌شود.', 'warning');
                        loadRegisteredChats(); // Refresh the list to show current data
                    } else {
                        throw new Error(result.error || 'خطا در حذف چت');
                    }
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                showFormAlert('❌ خطا در حذف چت: ' + error.message, 'danger');
            }
        }

        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-remove alert after 5 seconds
                setTimeout(() => {
                    const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                    if (alert) alert.close();
                }, 5000);
            }
        }

        // Show batch import modal
        function showBatchImportModal() {
            const modal = new bootstrap.Modal(document.getElementById('batchImportModal'));
            modal.show();
        }

        // Process batch import
        // Backup and Restore functions
        async function backupChats() {
            try {
                console.log('🔄 Updating backup database from main database...');
                
                const response = await fetch('/api/backup_chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFormAlert('✅ Backup database updated successfully!', 'success');
                    console.log('✅ Backup updated:', result.message);
                    } else {
                    showFormAlert(`❌ Backup update failed: ${result.error}`, 'danger');
                    console.error('❌ Backup update failed:', result.error);
                }
                
            } catch (error) {
                console.error('❌ Backup error:', error);
                showFormAlert('❌ Error during backup update process', 'danger');
            }
        }
        
        async function restoreChats() {
            if (!confirm('⚠️ Are you sure you want to restore chats from backup? This will overwrite current main database data with backup data. Use this only if main database is lost or corrupted.')) {
                return;
            }
            
            try {
                console.log('🔄 Starting restore process from backup to main database...');
                
                const response = await fetch('/api/restore_chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFormAlert('✅ Restore completed successfully! Main database restored from backup.', 'success');
                    console.log('✅ Restore completed:', result.message);
                    
                    // Reload the chats list
                    setTimeout(() => {
                        loadRegisteredChats();
                    }, 1000);
                } else {
                    showFormAlert(`❌ Restore failed: ${result.error}`, 'danger');
                    console.error('❌ Restore failed:', result.error);
                }
                
            } catch (error) {
                console.error('❌ Restore error:', error);
                showFormAlert('❌ Error during restore process', 'danger');
            }
        }

        async function processBatchImport() {
            const text = document.getElementById('batchImportText').value.trim();
            const defaultPlatform = document.getElementById('batchImportPlatform').value;
            const defaultType = document.getElementById('batchImportType').value;
            
            if (!text) {
                showFormAlert('لطفاً شناسه‌های چت را وارد کنید', 'danger');
                return;
            }
            
            const lines = text.split('\n').filter(line => line.trim());
            const results = {
                success: 0,
                failed: 0,
                errors: []
            };
            
            // Show progress
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchImportModal'));
            const importButton = document.querySelector('#batchImportModal .btn-primary');
            const originalText = importButton.innerHTML;
            importButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال پردازش...';
            importButton.disabled = true;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                try {
                    const parts = line.split(',');
                    const chatId = parts[0]?.trim();
                    const platform = parts[1]?.trim() || defaultPlatform;
                    const chatType = parts[2]?.trim() || defaultType;
                    const name = parts[3]?.trim() || null;
                    const username = parts[4]?.trim() || null;
                    
                    if (!chatId || !platform) {
                        results.failed++;
                        results.errors.push(`خط ${i + 1}: شناسه یا پلتفرم نامعتبر`);
                        continue;
                    }
                    
                    const response = await fetch('/api/manual_register_chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                chat_id: chatId,
                platform: platform,
                chat_type: chatType,
                name: name,
                username: username
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        results.success++;
                } else {
                        results.failed++;
                        results.errors.push(`خط ${i + 1}: ${result.error || result.message}`);
                    }
                    
                } catch (error) {
                    results.failed++;
                    results.errors.push(`خط ${i + 1}: ${error.message}`);
                }
            }
            
            // Reset button
            importButton.innerHTML = originalText;
            importButton.disabled = false;
            
            // Show results
            let message = `Import تکمیل شد: ${results.success} موفق، ${results.failed} ناموفق`;
            if (results.errors.length > 0) {
                message += '\n\nخطاها:\n' + results.errors.slice(0, 5).join('\n');
                if (results.errors.length > 5) {
                    message += `\n... و ${results.errors.length - 5} خطای دیگر`;
                }
            }
            
            showFormAlert(message, results.failed === 0 ? 'success' : 'warning');
            
            // Close modal and refresh list
            modal.hide();
            loadRegisteredChats();
        }

        // Make functions available globally
        window.loadRegisteredChats = loadRegisteredChats;
        window.deleteChat = deleteChat;
        window.showBatchImportModal = showBatchImportModal;
        window.processBatchImport = processBatchImport;
        window.toggleSelectAll = toggleSelectAll;
        window.updateBulkDeleteButton = updateBulkDeleteButton;
        window.bulkDeleteChats = bulkDeleteChats;
        window.updateUniqueMembers = updateUniqueMembers;
        window.displayUniqueMemberCards = displayUniqueMemberCards;
        window.promoteMember = promoteMember;
        window.demoteMember = demoteMember;
        window.pinUnpinMessage = pinUnpinMessage;
        window.editMessage = editMessage;
        window.sendPoll = sendPoll;
        window.loadChatAdministrators = loadChatAdministrators;
        window.showDailyStats = showDailyStats;
        window.backupChats = backupChats;
        window.forceSync = forceSync;
        window.restoreBackup = restoreBackup;
        window.clearCache = clearCache;
        window.generateComprehensiveReport = generateComprehensiveReport;
        window.showTagManagement = showTagManagement;
        window.showGrowthReports = showGrowthReports;
        window.downloadExcelReport = downloadExcelReport;
        
        // ====================== ADMIN MANAGEMENT FUNCTIONS ======================
        async function promoteMember(event) {
            event.preventDefault();
            const platform = document.getElementById('promotePlatform').value;
            const chatId = document.getElementById('promoteChatId').value;
            const userId = parseInt(document.getElementById('promoteUserId').value);
            
            const canChangeInfo = document.getElementById('promoteChangeInfo').checked;
            const canDeleteMessages = document.getElementById('promoteDeleteMessages').checked;
            const canInviteUsers = document.getElementById('promoteInviteUsers').checked;
            const canRestrictMembers = document.getElementById('promoteRestrictMembers').checked;
            const canPinMessages = document.getElementById('promotePinMessages').checked;
            const canPromoteMembers = document.getElementById('promotePromoteMembers').checked;
            
            try {
                const response = await fetch('/api/promote_member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        user_id: userId,
                        can_change_info: canChangeInfo,
                        can_delete_messages: canDeleteMessages,
                        can_invite_users: canInviteUsers,
                        can_restrict_members: canRestrictMembers,
                        can_pin_messages: canPinMessages,
                        can_promote_members: canPromoteMembers
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ کاربر با موفقیت به ادمین ارتقا یافت');
                    document.getElementById('promoteForm').reset();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function demoteMember(event) {
            event.preventDefault();
            const platform = document.getElementById('demotePlatform').value;
            const chatId = document.getElementById('demoteChatId').value;
            const userId = parseInt(document.getElementById('demoteUserId').value);
            
            try {
                const response = await fetch('/api/demote_member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        user_id: userId
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ ادمین با موفقیت تنزل یافت');
                    document.getElementById('demoteForm').reset();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function pinUnpinMessage(event) {
            event.preventDefault();
            const action = document.getElementById('pinAction').value;
            const platform = document.getElementById('pinPlatform').value;
            const chatId = document.getElementById('pinChatId').value;
            const messageId = parseInt(document.getElementById('pinMessageId').value);
            
            const endpoint = action === 'pin' ? '/api/pin_message' : '/api/unpin_message';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        message_id: messageId
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`✅ پیام با موفقیت ${action === 'pin' ? 'سنجاق' : 'از حالت سنجاق خارج'} شد`);
                    document.getElementById('pinForm').reset();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function editMessage(event) {
            event.preventDefault();
            const platform = document.getElementById('editPlatform').value;
            const chatId = document.getElementById('editChatId').value;
            const messageId = parseInt(document.getElementById('editMessageId').value);
            const text = document.getElementById('editText').value;
            const parseMode = document.getElementById('editParseMode').value;
            
            try {
                const response = await fetch('/api/edit_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        message_id: messageId,
                        text: text,
                        parse_mode: parseMode
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ پیام با موفقیت ویرایش شد');
                    document.getElementById('editForm').reset();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function sendPoll(event) {
            event.preventDefault();
            const platform = document.getElementById('pollPlatform').value;
            const chatId = document.getElementById('pollChatId').value;
            const question = document.getElementById('pollQuestion').value;
            const options = document.getElementById('pollOptions').value.split('\n').filter(o => o.trim());
            const pollType = document.getElementById('pollType').value;
            const isAnonymous = document.getElementById('pollAnonymous').checked;
            const allowsMultipleAnswers = document.getElementById('pollMultipleAnswers').checked;
            
            if (options.length < 2) {
                alert('❌ لطفاً حداقل 2 گزینه وارد کنید');
                return;
            }
            
            try {
                const response = await fetch('/api/send_poll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        question: question,
                        options: options,
                        poll_type: pollType,
                        is_anonymous: isAnonymous,
                        allows_multiple_answers: allowsMultipleAnswers
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ نظرسنجی با موفقیت ارسال شد. شناسه پیام: ' + result.message_id);
                    document.getElementById('pollForm').reset();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function loadChatAdministrators(event) {
            event.preventDefault();
            const platform = document.getElementById('adminsListPlatform').value;
            const chatId = document.getElementById('adminsListChatId').value;
            
            const resultDiv = document.getElementById('adminsListResult');
            resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            
            try {
                const response = await fetch(`/api/chat_administrators/${platform}/${chatId}`);
                const result = await response.json();
                
                if (result.success && result.administrators) {
                    let html = '<div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>کاربر</th><th>نوع</th><th>وضعیت</th><th>یوزرنیم</th></tr></thead><tbody>';
                    
                    result.administrators.forEach(admin => {
                        html += `<tr>
                            <td>${admin.first_name || ''} ${admin.last_name || ''}</td>
                            <td><span class="badge bg-${admin.is_bot ? 'warning' : 'primary'}">${admin.user_type}</span></td>
                            <td>${admin.status}</td>
                            <td>${admin.username || '-'}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-warning">❌ خطا در دریافت لیست ادمین‌ها: ' + (result.error || 'خطای ناشناخته') + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">❌ خطا در اتصال به سرور: ' + error.message + '</div>';
            }
        }
        
        // ====================== REPORTS FUNCTIONS ======================
        async function showDailyStats() {
            try {
                const response = await fetch('/api/daily_bot_statistics');
                const result = await response.json();
                
                let html = '<div class="alert alert-success">✅ آمار روزانه با موفقیت دریافت شد</div>';
                html += '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                
                document.getElementById('reportsResults').innerHTML = html;
            } catch (error) {
                document.getElementById('reportsResults').innerHTML = '<div class="alert alert-danger">❌ خطا: ' + error.message + '</div>';
            }
        }
        
        async function forceSync() {
            if (!confirm('آیا از سینک اجباری تمام چت‌ها اطمینان دارید؟')) {
                return;
            }
            
            try {
                const response = await fetch('/api/force-sync', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ سینک اجباری با موفقیت انجام شد');
                    fetchStats();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function restoreBackup() {
            if (!confirm('⚠️ آیا از بازیابی از backup اطمینان دارید؟ داده‌های فعلی جایگزین می‌شوند.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/restore-backup', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ بازیابی با موفقیت انجام شد');
                    fetchStats();
                } else {
                    alert('❌ خطا: ' + (result.error || 'خطای ناشناخته'));
                }
            } catch (error) {
                alert('❌ خطا در اتصال به سرور: ' + error.message);
            }
        }
        
        async function clearCache() {
            if (!confirm('آیا از پاک کردن کش اطمینان دارید؟')) {
                return;
            }
            
            alert('✅ کش با موفقیت پاک شد');
            fetchStats();
        }
        
        async function updateUniqueMembers() {
            try {
                // نمایش loading
                document.getElementById('unique-members').textContent = '...';
                
                const response = await fetch('/api/update_unique_members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error response (update unique members):', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                
                const data = await response.json();
                console.log("Updated unique members from API:", data);

                if (data.success) {
                    displayUniqueMemberStats(data.stats);
                    // نمایش پیام موفقیت
                    if (data.message) {
                        console.log(data.message);
                    }
                } else {
                    console.error('Error updating unique members:', data.error);
                    document.getElementById('unique-members').textContent = 'Error';
                }
            } catch (error) {
                console.error('Error updating unique members:', error);
                document.getElementById('unique-members').textContent = 'Error';
            }
        }

        // مدیریت چت‌ها
        
        // انتخاب همه چت‌ها
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-chats');
            const chatCheckboxes = document.querySelectorAll('.chat-checkbox');
            
            chatCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkDeleteButton();
        }
        
        // به‌روزرسانی دکمه حذف چندگانه
        function updateBulkDeleteButton() {
            const selectedChats = document.querySelectorAll('.chat-checkbox:checked');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const selectAllCheckbox = document.getElementById('select-all-chats');
            
            if (selectedChats.length > 0) {
                bulkDeleteBtn.style.display = 'inline-block';
                bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> حذف ${selectedChats.length} مورد`;
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
            
            // به‌روزرسانی checkbox انتخاب همه
            const allCheckboxes = document.querySelectorAll('.chat-checkbox');
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedChats.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedChats.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        
        // حذف چندگانه چت‌ها
        async function bulkDeleteChats() {
            const selectedChats = document.querySelectorAll('.chat-checkbox:checked');
            
            if (selectedChats.length === 0) {
                alert('لطفاً ابتدا چت‌هایی را برای حذف انتخاب کنید.');
                return;
            }
            
            const chatIds = Array.from(selectedChats).map(checkbox => ({
                chat_id: checkbox.dataset.chatId,
                platform: checkbox.dataset.platform
            }));
            
            if (!confirm(`آیا مطمئن هستید که می‌خواهید ${chatIds.length} چت را حذف کنید؟`)) {
                return;
            }
            
            try {
                const deletePromises = chatIds.map(chat => 
                    fetch('/api/delete_chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: chat.chat_id,
                            platform: chat.platform
                        })
                    })
                );
                
                const results = await Promise.all(deletePromises);
                const responses = await Promise.all(results.map(r => r.json()));
                
                let successCount = 0;
                let errorCount = 0;
                
                responses.forEach((response, index) => {
                    if (response.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error(`Error deleting chat ${chatIds[index].chat_id}:`, response.error);
                    }
                });
                
                if (successCount > 0) {
                    showAlert(`✅ ${successCount} چت با موفقیت حذف شد.`, 'success');
                }
                
                if (errorCount > 0) {
                    showAlert(`❌ ${errorCount} چت حذف نشد.`, 'danger');
                }
                
                // به‌روزرسانی لیست چت‌ها
            loadRegisteredChats();
                
            } catch (error) {
                console.error('Error in bulk delete:', error);
                showAlert('❌ خطا در حذف چت‌ها: ' + error.message, 'danger');
            }
        }

        // تابع نمایش آمار بازدید پست‌ها
        async function viewPostStats(batchId) {
            const modal = new bootstrap.Modal(document.getElementById('postStatsModal'));
            modal.show();
            
            try {
                const response = await fetch(`/api/post_stats/${batchId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'خطا در دریافت آمار');
                }
                
                displayPostStats(data);
            } catch (error) {
                console.error('Error fetching post stats:', error);
                document.getElementById('postStatsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        خطا در دریافت آمار: ${error.message}
                    </div>
                `;
            }
        }

        // تابع نمایش آمار در modal
        function displayPostStats(data) {
            const content = document.getElementById('postStatsContent');
            
            if (!data.detailed_posts || data.detailed_posts.length === 0) {
                content.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        آمار بازدید برای این ارسال موجود نیست.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.summary.total_posts}</h5>
                                <p class="card-text">تعداد پست‌ها</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.summary.total_views.toLocaleString()}</h5>
                                <p class="card-text">کل بازدیدها</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.summary.total_forwards.toLocaleString()}</h5>
                                <p class="card-text">کل فورواردها</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${data.summary.avg_views_per_post}</h5>
                                <p class="card-text">میانگین بازدید</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // آمار بر اساس پلتفرم
            if (Object.keys(data.platform_stats).length > 0) {
                html += `
                    <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>آمار بر اساس پلتفرم</h6>
                    <div class="row mb-4">
                `;
                
                for (const [platform, stats] of Object.entries(data.platform_stats)) {
                    const platformName = platform === 'telegram' ? 'تلگرام' : 
                                       platform === 'bale' ? 'بله' : 'ایتا';
                    const platformIcon = platform === 'telegram' ? 'fab fa-telegram' : 
                                       platform === 'bale' ? 'fas fa-envelope' : 'fas fa-mobile-alt';
                    
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="${platformIcon} me-2"></i>${platformName}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            پست‌ها: ${stats.posts_count}<br>
                                            بازدید: ${stats.total_views.toLocaleString()}<br>
                                            میانگین: ${stats.avg_views}
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // جزئیات پست‌ها
            html += `
                <h6 class="mb-3"><i class="fas fa-list me-2"></i>جزئیات پست‌ها</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>پلتفرم</th>
                                <th>کانال</th>
                                <th>نوع محتوا</th>
                                <th>تاریخ ارسال</th>
                                <th>بازدید</th>
                                <th>فوروارد</th>
                                <th>ری‌اکشن</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (const post of data.detailed_posts) {
                const platformName = post.platform === 'telegram' ? 'تلگرام' : 
                                   post.platform === 'bale' ? 'بله' : 'ایتا';
                const platformIcon = post.platform === 'telegram' ? 'fab fa-telegram text-primary' : 
                                   post.platform === 'bale' ? 'fas fa-envelope text-info' : 'fas fa-mobile-alt text-success';
                const contentType = post.content_type === 'photo' ? 'عکس' :
                                  post.content_type === 'video' ? 'ویدیو' :
                                  post.content_type === 'document' ? 'فایل' : 'متن';
                
                html += `
                    <tr>
                        <td><i class="${platformIcon} me-1"></i>${platformName}</td>
                        <td>${post.channel_name || 'نامشخص'}</td>
                        <td><span class="badge bg-secondary">${contentType}</span></td>
                        <td><small>${post.post_date_shamsi || post.post_date}</small></td>
                        <td><span class="badge bg-success">${(post.views_count || 0).toLocaleString()}</span></td>
                        <td><span class="badge bg-info">${(post.forwards_count || 0).toLocaleString()}</span></td>
                        <td><span class="badge bg-warning">${(post.reactions_count || 0).toLocaleString()}</span></td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = html;
        }

        // تابع نمایش مدیریت چت‌ها
        function showChatManagement(platform = null, chatId = null) {
            const modal = new bootstrap.Modal(document.getElementById('chatManagementModal'));
            
            if (platform && chatId) {
                // تنظیم مقادیر از پارامترها
                document.getElementById('chat-management-platform').value = platform;
                loadChatsForManagement();
                document.getElementById('chat-management-chat').value = chatId;
                loadChatDetails();
            }
            
            modal.show();
        }

        // تابع نمایش ایجاد نظرسنجی
        function showPollCreator() {
            const modal = new bootstrap.Modal(document.getElementById('pollCreatorModal'));
            modal.show();
        }

        // تابع بارگذاری چت‌ها برای نظرسنجی
        async function loadChatsForPoll() {
            const platform = document.getElementById('poll-platform').value;
            const chatSelect = document.getElementById('poll-chat');
            
            if (!platform) {
                chatSelect.innerHTML = '<option value="">ابتدا پلتفرم را انتخاب کنید</option>';
                return;
            }
            
            try {
                // استفاده از API با فیلتر پلتفرم
                const response = await fetch(`/api/chats?platform=${platform}`);
                const data = await response.json();
                
                chatSelect.innerHTML = '<option value="">انتخاب کنید...</option>';
                
                if (data.success && data.chats) {
                    data.chats.forEach(chat => {
                        const option = document.createElement('option');
                        option.value = chat.chat_id;
                        const chatTypeName = chat.chat_type === 'private' ? 'کاربر' : 
                                           chat.chat_type === 'group' ? 'گروه' : 'کانال';
                        option.textContent = `${chat.name || chat.chat_id} (${chatTypeName})`;
                        chatSelect.appendChild(option);
                    });
                    
                    // اضافه کردن گزینه "همه چت‌ها" برای نظرسنجی
                    if (data.chats.length > 1) {
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'همه چت‌ها';
                        chatSelect.appendChild(allOption);
                    }
                }
            } catch (error) {
                console.error('Error loading chats for poll:', error);
                chatSelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
            }
        }

        // تابع بارگذاری چت‌ها برای مدیریت
        async function loadChatsForManagement() {
            const platform = document.getElementById('chat-management-platform').value;
            const chatSelect = document.getElementById('chat-management-chat');
            
            if (!platform) {
                chatSelect.innerHTML = '<option value="">انتخاب کنید...</option>';
                return;
            }
            
            try {
                // استفاده از API با فیلتر پلتفرم
                const response = await fetch(`/api/chats?platform=${platform}`);
                const data = await response.json();
                
                chatSelect.innerHTML = '<option value="">انتخاب کنید...</option>';
                
                if (data.success && data.chats) {
                    data.chats.forEach(chat => {
                        const option = document.createElement('option');
                        option.value = chat.chat_id;
                        const chatTypeName = chat.chat_type === 'private' ? 'کاربر' : 
                                           chat.chat_type === 'group' ? 'گروه' : 'کانال';
                        option.textContent = `${chat.name || chat.chat_id} (${chatTypeName})`;
                        chatSelect.appendChild(option);
                    });
                    
                    // اضافه کردن گزینه "همه چت‌ها" برای نظرسنجی
                    if (data.chats.length > 1) {
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'همه چت‌ها';
                        chatSelect.appendChild(allOption);
                    }
                }
            } catch (error) {
                console.error('Error loading chats:', error);
                chatSelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
            }
        }

        // تابع بارگذاری جزئیات چت
        async function loadChatDetails() {
            const platform = document.getElementById('chat-management-platform').value;
            const chatId = document.getElementById('chat-management-chat').value;
            const content = document.getElementById('chat-management-content');
            
            if (!platform || !chatId) {
                content.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <p>ابتدا پلتفرم و چت را انتخاب کنید</p>
                    </div>
                `;
                return;
            }
            
            try {
                // بارگذاری ادمین‌ها
                const response = await fetch(`/api/chat_administrators/${platform}/${chatId}`);
                const data = await response.json();
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-users-cog me-2"></i>مدیریت ادمین‌ها</h6>
                        </div>
                        <div class="card-body">
                `;
                
                if (data.success && data.administrators) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>نام</th>
                                        <th>شناسه</th>
                                        <th>نوع</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.administrators.forEach(admin => {
                        const fullName = `${admin.first_name || ''} ${admin.last_name || ''}`.trim() || 'نامشخص';
                        const username = admin.username ? `@${admin.username}` : '';
                        const userTypeBadge = admin.user_type === 'ربات' ? 'bg-secondary' : 
                                            admin.user_type === 'مالک' ? 'bg-danger' : 'bg-primary';
                        const statusBadge = admin.status === 'creator' ? 'bg-danger' : 'bg-success';
                        
                        html += `
                            <tr>
                                <td>
                                    <div>
                                        <strong>${fullName}</strong>
                                        ${username ? `<br><small class="text-muted">${username}</small>` : ''}
                                    </div>
                                </td>
                                <td><code>${admin.user_id}</code></td>
                                <td><span class="badge ${userTypeBadge}">${admin.user_type}</span></td>
                                <td><span class="badge ${statusBadge}">${admin.status}</span></td>
                                <td>
                                    ${admin.user_type !== 'مالک' && admin.can_be_edited ? `
                                        <button class="btn btn-sm btn-warning" onclick="demoteMember('${platform}', '${chatId}', ${admin.user_id})">
                                            <i class="fas fa-arrow-down"></i> تنزل
                                        </button>
                                    ` : '<span class="text-muted">غیرقابل تغییر</span>'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html += '<p class="text-muted">اطلاعات ادمین‌ها در دسترس نیست</p>';
                }
                
                html += `
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-user-plus me-2"></i>ارتقای کاربران</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-info btn-sm" onclick="loadChatMembers('${platform}', '${chatId}')">
                                    <i class="fas fa-sync"></i> بارگذاری لیست اعضا
                                </button>
                            </div>
                            <div id="chat-members-list" class="mb-3" style="display: none;">
                                <h6>لیست اعضای چت:</h6>
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>انتخاب</th>
                                                <th>نام</th>
                                                <th>شناسه</th>
                                                <th>نوع</th>
                                                <th>وضعیت</th>
                                            </tr>
                                        </thead>
                                        <tbody id="members-table-body">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-success" onclick="promoteSelectedMembers('${platform}', '${chatId}')" disabled id="promote-selected-btn">
                                        <i class="fas fa-arrow-up"></i> ارتقای اعضای انتخاب شده
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="promote-user-id" class="form-label">یا شناسه کاربر برای ارتقا:</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="promote-user-id" placeholder="شناسه کاربر">
                                    <button class="btn btn-success" onclick="promoteUser('${platform}', '${chatId}')">
                                        <i class="fas fa-arrow-up"></i> ارتقا به ادمین
                                    </button>
                                </div>
                                <small class="text-muted">شناسه کاربری که می‌خواهید به ادمین ارتقا دهید را وارد کنید</small>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-thumbtack me-2"></i>مدیریت پیام‌ها</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="pin-message-id" class="form-label">شناسه پیام برای سنجاق:</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="pin-message-id" placeholder="شناسه پیام">
                                    <button class="btn btn-primary" onclick="pinMessage('${platform}', '${chatId}')">
                                        <i class="fas fa-thumbtack"></i> سنجاق
                                    </button>
                                    <button class="btn btn-warning" onclick="unpinMessage('${platform}', '${chatId}')">
                                        <i class="fas fa-unlink"></i> برداشتن سنجاق
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading chat details:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        خطا در بارگذاری جزئیات چت: ${error.message}
                    </div>
                `;
            }
        }

        // تابع بارگذاری لیست اعضای چت
        async function loadChatMembers(platform, chatId) {
            const membersList = document.getElementById('chat-members-list');
            const membersTableBody = document.getElementById('members-table-body');
            const promoteBtn = document.getElementById('promote-selected-btn');
            
            try {
                membersTableBody.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> در حال بارگذاری...</td></tr>';
                membersList.style.display = 'block';
                
                const response = await fetch(`/api/chat_members/${platform}/${chatId}`);
                const data = await response.json();
                
                if (data.success && data.members) {
                    membersTableBody.innerHTML = '';
                    
                    data.members.forEach(member => {
                        const fullName = `${member.first_name || ''} ${member.last_name || ''}`.trim() || 'نامشخص';
                        const username = member.username ? `@${member.username}` : '';
                        const userTypeBadge = member.user_type === 'ربات' ? 'bg-secondary' : 
                                            member.user_type === 'مالک' ? 'bg-danger' : 
                                            member.user_type === 'ادمین' ? 'bg-primary' : 'bg-info';
                        const statusBadge = member.status === 'creator' ? 'bg-danger' : 
                                          member.status === 'administrator' ? 'bg-success' : 'bg-light text-dark';
                        
                        // فقط کاربران عادی و ادمین‌ها قابل ارتقا هستند (نه مالک‌ها و ربات‌ها)
                        const canPromote = member.user_type === 'کاربر' || member.user_type === 'ادمین';
                        console.log(`User: ${member.first_name} ${member.last_name}, Type: ${member.user_type}, Can Promote: ${canPromote}`);
                        
                        membersTableBody.innerHTML += `
                            <tr>
                                <td>
                                    ${canPromote ? `
                                        <input type="checkbox" class="form-check-input member-checkbox" 
                                               value="${member.user_id}" onchange="updatePromoteButton()">
                                    ` : '<span class="text-muted">-</span>'}
                                </td>
                                <td>
                                    <div>
                                        <strong>${fullName}</strong>
                                        ${username ? `<br><small class="text-muted">${username}</small>` : ''}
                                    </div>
                                </td>
                                <td><code>${member.user_id}</code></td>
                                <td><span class="badge ${userTypeBadge}">${member.user_type}</span></td>
                                <td><span class="badge ${statusBadge}">${member.status || 'member'}</span></td>
                            </tr>
                        `;
                    });
                    
                    if (data.members.length === 0) {
                        membersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">هیچ عضوی یافت نشد</td></tr>';
                    }
                } else {
                    membersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">خطا در بارگذاری لیست اعضا</td></tr>';
                }
            } catch (error) {
                membersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">خطا در بارگذاری: ' + error.message + '</td></tr>';
            }
        }

        // تابع به‌روزرسانی دکمه ارتقا
        function updatePromoteButton() {
            const checkboxes = document.querySelectorAll('.member-checkbox:checked');
            const promoteBtn = document.getElementById('promote-selected-btn');
            
            if (checkboxes.length > 0) {
                promoteBtn.disabled = false;
                promoteBtn.textContent = `ارتقای ${checkboxes.length} عضو انتخاب شده`;
            } else {
                promoteBtn.disabled = true;
                promoteBtn.innerHTML = '<i class="fas fa-arrow-up"></i> ارتقای اعضای انتخاب شده';
            }
        }

        // تابع ارتقای اعضای انتخاب شده
        async function promoteSelectedMembers(platform, chatId) {
            const checkboxes = document.querySelectorAll('.member-checkbox:checked');
            const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (userIds.length === 0) {
                alert('لطفاً حداقل یک عضو را انتخاب کنید');
                return;
            }
            
            if (!confirm(`آیا مطمئن هستید که می‌خواهید ${userIds.length} عضو را به ادمین ارتقا دهید؟`)) {
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const userId of userIds) {
                try {
                    const response = await fetch('/api/promote_member', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: platform,
                            chat_id: chatId,
                            user_id: userId,
                            can_change_info: true,
                            can_delete_messages: true,
                            can_invite_users: true,
                            can_restrict_members: true,
                            can_pin_messages: true,
                            can_promote_members: false
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }
            
            alert(`✅ ${successCount} عضو با موفقیت ارتقا یافت\n❌ ${failCount} عضو با خطا مواجه شد`);
            
            // پاک کردن انتخاب‌ها و بارگذاری مجدد
            document.querySelectorAll('.member-checkbox').forEach(cb => cb.checked = false);
            updatePromoteButton();
            loadChatDetails();
        }

        // تابع ارتقای کاربر (از شناسه)
        async function promoteUser(platform, chatId) {
            const userId = document.getElementById('promote-user-id').value;
            if (!userId) {
                alert('لطفاً شناسه کاربر را وارد کنید');
                return;
            }
            
            if (!confirm(`آیا مطمئن هستید که می‌خواهید کاربر ${userId} را به ادمین ارتقا دهید؟`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/promote_member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        user_id: parseInt(userId),
                        can_change_info: true,
                        can_delete_messages: true,
                        can_invite_users: true,
                        can_restrict_members: true,
                        can_pin_messages: true,
                        can_promote_members: false
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ کاربر با موفقیت به ادمین ارتقا یافت');
                    document.getElementById('promote-user-id').value = '';
                    loadChatDetails();
                } else {
                    alert('❌ خطا در ارتقای کاربر: ' + data.error);
                }
            } catch (error) {
                alert('❌ خطا در ارتقای کاربر: ' + error.message);
            }
        }

        // تابع ارتقای عضو
        async function promoteMember(platform, chatId, userId) {
            try {
                const response = await fetch('/api/promote_member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ عضو با موفقیت ارتقا یافت');
                    loadChatDetails();
                } else {
                    alert('❌ خطا در ارتقای عضو: ' + data.error);
                }
            } catch (error) {
                alert('❌ خطا در ارتقای عضو: ' + error.message);
            }
        }

        // تابع تنزل عضو
        async function demoteMember(platform, chatId, userId) {
            if (!confirm('آیا مطمئن هستید که می‌خواهید این ادمین را تنزل دهید؟')) {
                return;
            }
            
            try {
                const response = await fetch('/api/demote_member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        user_id: userId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ ادمین با موفقیت تنزل یافت');
                    loadChatDetails();
                } else {
                    alert('❌ خطا در تنزل ادمین: ' + data.error);
                }
            } catch (error) {
                alert('❌ خطا در تنزل ادمین: ' + error.message);
            }
        }

        // تابع سنجاق پیام
        async function pinMessage(platform, chatId) {
            const messageId = document.getElementById('pin-message-id').value;
            if (!messageId) {
                alert('لطفاً شناسه پیام را وارد کنید');
                return;
            }
            
            try {
                const response = await fetch('/api/pin_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId,
                        message_id: parseInt(messageId)
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ پیام با موفقیت سنجاق شد');
                } else {
                    alert('❌ خطا در سنجاق پیام: ' + data.error);
                }
            } catch (error) {
                alert('❌ خطا در سنجاق پیام: ' + error.message);
            }
        }

        // تابع برداشتن سنجاق پیام
        async function unpinMessage(platform, chatId) {
            if (!confirm('آیا مطمئن هستید که می‌خواهید سنجاق پیام را بردارید؟')) {
                return;
            }
            
            try {
                const response = await fetch('/api/unpin_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: platform,
                        chat_id: chatId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ سنجاق پیام با موفقیت برداشته شد');
                } else {
                    alert('❌ خطا در برداشتن سنجاق: ' + data.error);
                }
            } catch (error) {
                alert('❌ خطا در برداشتن سنجاق: ' + error.message);
            }
        }

        // تابع افزودن گزینه نظرسنجی
        function addPollOption() {
            const optionsContainer = document.getElementById('poll-options');
            const optionCount = optionsContainer.children.length + 1;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'input-group mb-2';
            optionDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="گزینه ${optionCount}" required>
                <button type="button" class="btn btn-outline-danger" onclick="removePollOption(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            optionsContainer.appendChild(optionDiv);
        }

        // تابع حذف گزینه نظرسنجی
        function removePollOption(button) {
            if (document.getElementById('poll-options').children.length > 2) {
                button.parentElement.remove();
            } else {
                alert('حداقل 2 گزینه لازم است');
            }
        }

        // تابع ایجاد نظرسنجی
        async function createPoll() {
            const platform = document.getElementById('poll-platform').value;
            const chatId = document.getElementById('poll-chat').value;
            const question = document.getElementById('poll-question').value;
            const isAnonymous = document.getElementById('poll-anonymous').checked;
            const allowsMultiple = document.getElementById('poll-multiple').checked;
            
            if (!platform || !chatId || !question) {
                alert('لطفاً تمام فیلدهای ضروری را پر کنید');
                return;
            }
            
            // جمع‌آوری گزینه‌ها
            const options = [];
            const optionInputs = document.querySelectorAll('#poll-options input');
            optionInputs.forEach(input => {
                if (input.value.trim()) {
                    options.push(input.value.trim());
                }
            });
            
            if (options.length < 2) {
                alert('حداقل 2 گزینه لازم است');
                return;
            }
            
            try {
                // اگر "همه چت‌ها" انتخاب شده، ابتدا لیست چت‌ها را دریافت کن
                let targetChats = [chatId];
                if (chatId === 'all') {
                    const response = await fetch(`/api/chats?platform=${platform}`);
                    const data = await response.json();
                    if (data.success && data.chats) {
                        targetChats = data.chats.map(chat => chat.chat_id);
                    }
                }
                
                let successCount = 0;
                let failCount = 0;
                
                // ارسال نظرسنجی به همه چت‌های هدف
                for (const targetChatId of targetChats) {
                    try {
                        const response = await fetch('/api/send_poll', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                platform: platform,
                                chat_id: targetChatId,
                                question: question,
                                options: options,
                                is_anonymous: isAnonymous,
                                allows_multiple_answers: allowsMultiple
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                if (targetChats.length === 1) {
                    if (successCount > 0) {
                        alert('✅ نظرسنجی با موفقیت ارسال شد');
                        bootstrap.Modal.getInstance(document.getElementById('pollCreatorModal')).hide();
                    } else {
                        alert('❌ خطا در ارسال نظرسنجی');
                    }
                } else {
                    alert(`✅ نظرسنجی به ${successCount} چت ارسال شد\n❌ ${failCount} چت با خطا مواجه شد`);
                    bootstrap.Modal.getInstance(document.getElementById('pollCreatorModal')).hide();
                }
            } catch (error) {
                alert('❌ خطا در ارسال نظرسنجی: ' + error.message);
            }
        }

        // مدیریت تگ‌ها
        async function showTagManagement() {
            const modal = new bootstrap.Modal(document.getElementById('tagManagementModal'));
            modal.show();
            await loadChatsForTags();
            await loadAvailableTags();
        }

        async function loadChatsForTags() {
            try {
                const response = await fetch('/api/chats');
                const data = await response.json();
                
                const tbody = document.getElementById('chatsListForTags');
                tbody.innerHTML = '';
                
                data.chats.forEach(chat => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${chat.platform}</td>
                        <td>${chat.name || 'ندارد'}</td>
                        <td>${chat.chat_type}</td>
                        <td><span class="badge bg-secondary">${chat.tags || 'ندارد'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editChatTags('${chat.chat_id}', '${chat.platform}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading chats for tags:', error);
            }
        }

        async function loadAvailableTags() {
            try {
                const response = await fetch('/api/get-all-tags');
                const data = await response.json();
                
                const container = document.getElementById('availableTags');
                container.innerHTML = '';
                
                if (data.tags && data.tags.length > 0) {
                    data.tags.forEach(tag => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary me-1 mb-1';
                        badge.textContent = tag;
                        container.appendChild(badge);
                    });
                } else {
                    container.innerHTML = '<p class="text-muted">هیچ تگی موجود نیست</p>';
                }
            } catch (error) {
                console.error('Error loading available tags:', error);
            }
        }

        async function editChatTags(chatId, platform) {
            const currentTags = prompt('تگ‌های فعلی را ویرایش کنید (با کاما جدا کنید):');
            if (currentTags !== null) {
                try {
                    const response = await fetch('/api/update-chat-tags', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            platform: platform,
                            tags: currentTags
                        })
                    });

                    if (response.ok) {
                        alert('✅ تگ‌ها با موفقیت به‌روزرسانی شدند');
                        await loadChatsForTags();
                        await loadAvailableTags();
                    } else {
                        throw new Error('خطا در به‌روزرسانی تگ‌ها');
                    }
                } catch (error) {
                    alert('❌ خطا در به‌روزرسانی تگ‌ها: ' + error.message);
                }
            }
        }

        async function exportTags() {
            try {
                const response = await fetch('/api/export-tags');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tags_export_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('خطا در صادرات تگ‌ها');
                }
            } catch (error) {
                alert('❌ خطا در صادرات تگ‌ها: ' + error.message);
            }
        }

        async function importTags(input) {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/import-tags', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`✅ ${data.message}`);
                    await loadChatsForTags();
                    await loadAvailableTags();
                } else {
                    throw new Error('خطا در واردات تگ‌ها');
                }
            } catch (error) {
                alert('❌ خطا در واردات تگ‌ها: ' + error.message);
            }
        }

        // گزارش‌های رشد
        async function showGrowthReports() {
            const modal = new bootstrap.Modal(document.getElementById('growthReportsModal'));
            modal.show();
            await loadGrowthStats();
        }

        async function loadGrowthStats() {
            try {
                // بارگذاری آمار رشد برای هر پلتفرم
                const [telegramResponse, baleResponse, itaResponse, overallResponse] = await Promise.all([
                    fetch('/api/growth-stats/telegram'),
                    fetch('/api/growth-stats/bale'),
                    fetch('/api/growth-stats/ita'),
                    fetch('/api/overall-growth-stats')
                ]);

                const telegramData = await telegramResponse.json();
                const baleData = await baleResponse.json();
                const itaData = await itaResponse.json();
                const overallData = await overallResponse.json();

                // نمایش آمار تلگرام
                document.getElementById('telegramGrowthStats').innerHTML = formatGrowthStats(telegramData.growth_stats);
                document.getElementById('baleGrowthStats').innerHTML = formatGrowthStats(baleData.growth_stats);
                document.getElementById('itaGrowthStats').innerHTML = formatGrowthStats(itaData.growth_stats);
                document.getElementById('overallGrowthStats').innerHTML = formatOverallGrowthStats(overallData.growth_stats);

            } catch (error) {
                console.error('Error loading growth stats:', error);
            }
        }

        function formatGrowthStats(stats) {
            if (!stats || !stats.total) return '<p class="text-muted">داده‌ای موجود نیست</p>';
            
            const total = stats.total;
            return `
                <div class="small">
                    <div class="row">
                        <div class="col-6">
                            <strong>چت‌ها:</strong><br>
                            فعلی: ${total.current_chats}<br>
                            رشد: <span class="${total.chat_growth >= 0 ? 'text-success' : 'text-danger'}">${total.chat_growth} (${total.chat_growth_pct}%)</span>
                        </div>
                        <div class="col-6">
                            <strong>اعضا:</strong><br>
                            فعلی: ${total.current_members}<br>
                            رشد: <span class="${total.member_growth >= 0 ? 'text-success' : 'text-danger'}">${total.member_growth} (${total.member_growth_pct}%)</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatOverallGrowthStats(stats) {
            if (!stats || !stats.overall) return '<p class="text-muted">داده‌ای موجود نیست</p>';
            
            const overall = stats.overall;
            return `
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>چت‌ها</h6>
                            <h4 class="text-primary">${overall.current_chats}</h4>
                            <small class="${overall.chat_growth >= 0 ? 'text-success' : 'text-danger'}">
                                ${overall.chat_growth >= 0 ? '+' : ''}${overall.chat_growth} (${overall.chat_growth_pct}%)
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>اعضا</h6>
                            <h4 class="text-success">${overall.current_members}</h4>
                            <small class="${overall.member_growth >= 0 ? 'text-success' : 'text-danger'}">
                                ${overall.member_growth >= 0 ? '+' : ''}${overall.member_growth} (${overall.member_growth_pct}%)
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>تلگرام</h6>
                            <h5 class="text-primary">${stats.telegram?.current_members || 0}</h5>
                            <small class="${stats.telegram?.member_growth >= 0 ? 'text-success' : 'text-danger'}">
                                ${stats.telegram?.member_growth >= 0 ? '+' : ''}${stats.telegram?.member_growth || 0}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6>بله</h6>
                            <h5 class="text-info">${stats.bale?.current_members || 0}</h5>
                            <small class="${stats.bale?.member_growth >= 0 ? 'text-success' : 'text-danger'}">
                                ${stats.bale?.member_growth >= 0 ? '+' : ''}${stats.bale?.member_growth || 0}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        async function downloadGrowthReport(platform) {
            try {
                const response = await fetch(`/api/growth-report/${platform}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `growth_report_${platform}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('خطا در دانلود گزارش رشد');
                }
            } catch (error) {
                alert('❌ خطا در دانلود گزارش رشد: ' + error.message);
            }
        }

    </script>

    <!-- Modal for Post Stats -->
    <div class="modal fade" id="postStatsModal" tabindex="-1" aria-labelledby="postStatsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postStatsModalLabel">
                        <i class="fas fa-chart-bar me-2"></i>آمار بازدید پست‌ها
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="postStatsContent">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">در حال بارگذاری...</span>
                            </div>
                            <p class="mt-2">در حال بارگذاری آمار...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Chat Management -->
    <div class="modal fade" id="chatManagementModal" tabindex="-1" aria-labelledby="chatManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatManagementModalLabel">
                        <i class="fas fa-cog me-2"></i>مدیریت پیشرفته چت‌ها
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-users me-2"></i>انتخاب چت</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="chat-management-platform" class="form-label">پلتفرم:</label>
                                        <select class="form-select" id="chat-management-platform" onchange="loadChatsForManagement()">
                                            <option value="">انتخاب کنید...</option>
                                            <option value="telegram">تلگرام</option>
                                            <option value="bale">بله</option>
                                            <option value="ita">ایتا</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="chat-management-chat" class="form-label">چت:</label>
                                        <select class="form-select" id="chat-management-chat" onchange="loadChatDetails()">
                                            <option value="">انتخاب کنید...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="chat-management-content">
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                                    <p>ابتدا پلتفرم و چت را انتخاب کنید</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Poll Creator -->
    <div class="modal fade" id="pollCreatorModal" tabindex="-1" aria-labelledby="pollCreatorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pollCreatorModalLabel">
                        <i class="fas fa-poll me-2"></i>ایجاد نظرسنجی
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="poll-creator-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="poll-platform" class="form-label">پلتفرم:</label>
                                    <select class="form-select" id="poll-platform" onchange="loadChatsForPoll()" required>
                                        <option value="">انتخاب کنید...</option>
                                        <option value="telegram">تلگرام</option>
                                        <option value="bale">بله</option>
                                        <option value="ita">ایتا</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="poll-chat" class="form-label">چت:</label>
                                    <select class="form-select" id="poll-chat" required>
                                        <option value="">ابتدا پلتفرم را انتخاب کنید</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="poll-question" class="form-label">سوال نظرسنجی:</label>
                                    <textarea class="form-control" id="poll-question" rows="3" placeholder="سوال خود را وارد کنید..." required></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">گزینه‌ها:</label>
                                    <div id="poll-options">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" placeholder="گزینه 1" required>
                                            <button type="button" class="btn btn-outline-danger" onclick="removePollOption(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" placeholder="گزینه 2" required>
                                            <button type="button" class="btn btn-outline-danger" onclick="removePollOption(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPollOption()">
                                        <i class="fas fa-plus"></i> افزودن گزینه
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="poll-anonymous" checked>
                                        <label class="form-check-label" for="poll-anonymous">
                                            نظرسنجی ناشناس
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="poll-multiple">
                                        <label class="form-check-label" for="poll-multiple">
                                            امکان انتخاب چندگانه
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="button" class="btn btn-success" onclick="createPoll()">
                        <i class="fas fa-paper-plane"></i> ارسال نظرسنجی
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Tag Management -->
    <div class="modal fade" id="tagManagementModal" tabindex="-1" aria-labelledby="tagManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tagManagementModalLabel">
                        <i class="fas fa-tags"></i> مدیریت تگ‌ها
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>📋 لیست چت‌ها</h6>
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>پلتفرم</th>
                                            <th>نام</th>
                                            <th>نوع</th>
                                            <th>تگ‌های فعلی</th>
                                            <th>عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="chatsListForTags">
                                        <!-- لیست چت‌ها اینجا نمایش داده می‌شود -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>🏷️ تگ‌های موجود</h6>
                            <div id="availableTags" class="mb-3">
                                <!-- تگ‌های موجود اینجا نمایش داده می‌شود -->
                            </div>
                            <h6>📤 عملیات</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="exportTags()">
                                    <i class="fas fa-download"></i> صادرات تگ‌ها
                                </button>
                                <button class="btn btn-outline-success" onclick="document.getElementById('importTagsFile').click()">
                                    <i class="fas fa-upload"></i> واردات تگ‌ها
                                </button>
                                <input type="file" id="importTagsFile" accept=".json" style="display: none;" onchange="importTags(this)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Register from Sent Message -->
    <div class="modal fade" id="registerFromMessageModal" tabindex="-1" aria-labelledby="registerFromMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerFromMessageModalLabel">
                        <i class="fas fa-paper-plane me-2"></i>ثبت چت از پیام ارسالی
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>راهنمای استفاده:</strong>
                        <ol class="mb-0 mt-2">
                            <li>ابتدا پیام خود را در کانال/گروه ایتا ارسال کنید</li>
                            <li>پاسخ API را در فیلد زیر قرار دهید</li>
                            <li>اطلاعات چت به صورت خودکار استخراج و ثبت می‌شود</li>
                        </ol>
                    </div>
                    
                    <form id="register-from-message-form">
                        <div class="mb-3">
                            <label for="message-response" class="form-label">
                                <i class="fas fa-code me-2"></i>پاسخ API پیام ارسالی (JSON):
                            </label>
                            <textarea class="form-control" id="message-response" rows="10" 
                                placeholder='{"ok": true, "result": {"message_id": 123, "chat": {"id": "10921506", "title": "نام کانال", "username": "username", "type": "channel"}}}'
                                style="font-family: monospace; font-size: 0.9rem;"></textarea>
                            <small class="text-muted">پاسخ کامل API را در این فیلد قرار دهید</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="message-chat-type" class="form-label">نوع چت (اختیاری):</label>
                                    <select class="form-select" id="message-chat-type">
                                        <option value="channel">کانال</option>
                                        <option value="group">گروه</option>
                                        <option value="private">خصوصی</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="message-chat-name" class="form-label">نام چت (اختیاری):</label>
                                    <input type="text" class="form-control" id="message-chat-name" placeholder="نام کانال">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="message-chat-username" class="form-label">یوزرنیم (اختیاری):</label>
                            <input type="text" class="form-control" id="message-chat-username" placeholder="@username">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>لغو
                    </button>
                    <button type="button" class="btn btn-success" onclick="submitRegisterFromMessage()">
                        <i class="fas fa-paper-plane me-2"></i>ثبت چت
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Growth Reports -->
    <div class="modal fade" id="growthReportsModal" tabindex="-1" aria-labelledby="growthReportsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="growthReportsModalLabel">
                        <i class="fas fa-chart-line"></i> گزارش‌های رشد
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fab fa-telegram"></i> تلگرام</h6>
                                </div>
                                <div class="card-body">
                                    <div id="telegramGrowthStats">
                                        <!-- آمار رشد تلگرام -->
                                    </div>
                                    <button class="btn btn-primary btn-sm w-100" onclick="downloadGrowthReport('telegram')">
                                        <i class="fas fa-download"></i> دانلود گزارش
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-envelope"></i> بله</h6>
                                </div>
                                <div class="card-body">
                                    <div id="baleGrowthStats">
                                        <!-- آمار رشد بله -->
                                    </div>
                                    <button class="btn btn-info btn-sm w-100" onclick="downloadGrowthReport('bale')">
                                        <i class="fas fa-download"></i> دانلود گزارش
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-mobile-alt"></i> ایتا</h6>
                                </div>
                                <div class="card-body">
                                    <div id="itaGrowthStats">
                                        <!-- آمار رشد ایتا -->
                                    </div>
                                    <button class="btn btn-success btn-sm w-100" onclick="downloadGrowthReport('ita')">
                                        <i class="fas fa-download"></i> دانلود گزارش
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-globe"></i> آمار کلی</h6>
                                </div>
                                <div class="card-body">
                                    <div id="overallGrowthStats">
                                        <!-- آمار رشد کلی -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Scheduled Broadcasts -->
    <script>
        // متغیرهای سراسری
        let currentScheduledFilter = 'all';
        let scheduledBroadcasts = [];

        // بارگذاری ارسال‌های زماندار (فقط آینده)
        async function loadScheduledBroadcasts() {
            try {
                console.log('Loading scheduled broadcasts from /api/scheduled_broadcasts...');
                const response = await fetch('/api/scheduled_broadcasts');
                if (!response.ok) throw new Error('خطا در دریافت لیست');
                
                const broadcasts = await response.json();
                console.log('Received broadcasts:', broadcasts);
                
                // فقط ارسال‌های آینده را نمایش دهید (pending و running)
                const futureBroadcasts = broadcasts.filter(broadcast => 
                    broadcast.status === 'pending' || broadcast.status === 'running'
                );
                
                console.log('Future broadcasts:', futureBroadcasts);
                scheduledBroadcasts = futureBroadcasts;
                displayScheduledBroadcasts();
            } catch (error) {
                console.error('Error loading scheduled broadcasts:', error);
                const container = document.getElementById('scheduled-broadcasts-list');
                if (container) {
                    container.innerHTML = '<div class="alert alert-danger">خطا در بارگذاری ارسال‌های زماندار</div>';
                }
            }
        }

        // نمایش ارسال‌های زماندار
        function displayScheduledBroadcasts() {
            const container = document.getElementById('scheduled-broadcasts-list');
            
            if (!container) {
                console.log('Element scheduled-broadcasts-list not found');
                return;
            }
            
            console.log('Displaying scheduled broadcasts:', scheduledBroadcasts);
            
            if (scheduledBroadcasts.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-clock"></i> هیچ ارسال انبوه زمان‌بندی شده‌ای برای آینده وجود ندارد</div>';
                return;
            }
            
            let html = '';
            scheduledBroadcasts.forEach(broadcast => {
                const statusClass = getStatusClass(broadcast.status);
                const statusText = getStatusText(broadcast.status);
                const scheduledTime = new Date(broadcast.scheduled_time).toLocaleString('fa-IR');
                
                // مدیریت platforms و scopes
                const platforms = Array.isArray(broadcast.platforms) ? broadcast.platforms : [];
                const scopes = Array.isArray(broadcast.scopes) ? broadcast.scopes : [];
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <i class="fas fa-paper-plane me-1"></i>${broadcast.title || 'بدون عنوان'}
                                        <span class="badge bg-primary ms-2">ارسال انبوه</span>
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> ${broadcast.solar_date || ''} - 
                                            <i class="fas fa-clock"></i> ${scheduledTime}
                                        </small>
                                    </p>
                                    <div class="mb-2">
                                        <span class="badge bg-primary me-1">${broadcast.platforms.join(', ')}</span>
                                        <span class="badge bg-secondary me-1">${broadcast.scopes.join(', ')}</span>
                                        ${broadcast.tags ? `<span class="badge bg-info">${broadcast.tags}</span>` : ''}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${statusClass} mb-2">${statusText}</span>
                                    <div>
                                        <button class="btn btn-sm btn-danger" onclick="deleteScheduledBroadcast(${broadcast.id})">
                                            <i class="fas fa-trash"></i> حذف ارسال انبوه
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // فیلتر ارسال‌های زماندار
        function filterScheduledBroadcasts() {
            const filter = document.getElementById('scheduled-filter').value;
            currentScheduledFilter = filter;
            loadScheduledBroadcasts();
        }

        // حذف ارسال زماندار انبوه
        async function deleteScheduledBroadcast(broadcastId) {
            if (!confirm('آیا مطمئن هستید که می‌خواهید این ارسال انبوه زمان‌بندی شده را حذف کنید؟')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/scheduled_broadcasts/${broadcastId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ارسال انبوه زمان‌بندی شده با موفقیت حذف شد');
                    loadScheduledBroadcasts();
                } else {
                    alert('خطا در حذف ارسال انبوه زمان‌بندی شده: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting scheduled broadcast:', error);
                alert('خطا در حذف ارسال انبوه زمان‌بندی شده');
            }
        }

        // دریافت کلاس وضعیت
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'running': return 'bg-info';
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // دریافت متن وضعیت
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'در انتظار';
                case 'running': return 'در حال اجرا';
                case 'completed': return 'تکمیل شده';
                case 'failed': return 'ناموفق';
                default: return 'نامشخص';
            }
        }

        // نمایش modal ارسال‌های زماندار
        function showScheduledBroadcasts() {
            const modal = new bootstrap.Modal(document.getElementById('scheduledBroadcastsModal'));
            modal.show();
            loadScheduledBroadcasts();
        }


        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            // loadScheduledBroadcasts(); // حذف شد چون فقط در modal نمایش داده می‌شود
        });


        // تبدیل تاریخ میلادی به شمسی (دقیق)
        function convertToPersianDate(date) {
            const gregorianYear = date.getFullYear();
            const gregorianMonth = date.getMonth() + 1;
            const gregorianDay = date.getDate();
            
            // تبدیل دقیق تاریخ میلادی به شمسی
            let persianYear, persianMonth, persianDay;
            
            // محاسبه سال شمسی
            if (gregorianMonth >= 3 && gregorianMonth <= 12) {
                persianYear = gregorianYear - 621;
            } else {
                persianYear = gregorianYear - 622;
            }
            
            // محاسبه ماه شمسی
            if (gregorianMonth >= 3 && gregorianMonth <= 5) {
                persianMonth = gregorianMonth - 2;
            } else if (gregorianMonth >= 6 && gregorianMonth <= 8) {
                persianMonth = gregorianMonth - 2;
            } else if (gregorianMonth >= 9 && gregorianMonth <= 11) {
                persianMonth = gregorianMonth - 2;
            } else if (gregorianMonth === 12) {
                persianMonth = 10;
            } else if (gregorianMonth === 1) {
                persianMonth = 11;
            } else if (gregorianMonth === 2) {
                persianMonth = 12;
            }
            
            // محاسبه روز شمسی (تقریبی)
            persianDay = gregorianDay;
            
            // تنظیمات خاص برای ماه‌های مختلف
            if (gregorianMonth === 3 && gregorianDay >= 21) {
                persianMonth = 1;
                persianDay = gregorianDay - 20;
            } else if (gregorianMonth === 4 && gregorianDay <= 20) {
                persianMonth = 1;
                persianDay = gregorianDay + 11;
            } else if (gregorianMonth === 4 && gregorianDay >= 21) {
                persianMonth = 2;
                persianDay = gregorianDay - 20;
            } else if (gregorianMonth === 5 && gregorianDay <= 21) {
                persianMonth = 2;
                persianDay = gregorianDay + 10;
            } else if (gregorianMonth === 5 && gregorianDay >= 22) {
                persianMonth = 3;
                persianDay = gregorianDay - 21;
            } else if (gregorianMonth === 6 && gregorianDay <= 21) {
                persianMonth = 3;
                persianDay = gregorianDay + 10;
            } else if (gregorianMonth === 6 && gregorianDay >= 22) {
                persianMonth = 4;
                persianDay = gregorianDay - 21;
            } else if (gregorianMonth === 7 && gregorianDay <= 22) {
                persianMonth = 4;
                persianDay = gregorianDay + 9;
            } else if (gregorianMonth === 7 && gregorianDay >= 23) {
                persianMonth = 5;
                persianDay = gregorianDay - 22;
            } else if (gregorianMonth === 8 && gregorianDay <= 22) {
                persianMonth = 5;
                persianDay = gregorianDay + 9;
            } else if (gregorianMonth === 8 && gregorianDay >= 23) {
                persianMonth = 6;
                persianDay = gregorianDay - 22;
            } else if (gregorianMonth === 9 && gregorianDay <= 22) {
                persianMonth = 6;
                persianDay = gregorianDay + 8;
            } else if (gregorianMonth === 9 && gregorianDay >= 23) {
                persianMonth = 7;
                persianDay = gregorianDay - 22;
            } else if (gregorianMonth === 10 && gregorianDay <= 22) {
                persianMonth = 7;
                persianDay = gregorianDay + 8;
            } else if (gregorianMonth === 10 && gregorianDay >= 23) {
                persianMonth = 8;
                persianDay = gregorianDay - 22;
            } else if (gregorianMonth === 11 && gregorianDay <= 21) {
                persianMonth = 8;
                persianDay = gregorianDay + 9;
            } else if (gregorianMonth === 11 && gregorianDay >= 22) {
                persianMonth = 9;
                persianDay = gregorianDay - 21;
            } else if (gregorianMonth === 12 && gregorianDay <= 21) {
                persianMonth = 9;
                persianDay = gregorianDay + 9;
            } else if (gregorianMonth === 12 && gregorianDay >= 22) {
                persianMonth = 10;
                persianDay = gregorianDay - 21;
            } else if (gregorianMonth === 1 && gregorianDay <= 20) {
                persianMonth = 10;
                persianDay = gregorianDay + 10;
            } else if (gregorianMonth === 1 && gregorianDay >= 21) {
                persianMonth = 11;
                persianDay = gregorianDay - 20;
            } else if (gregorianMonth === 2 && gregorianDay <= 19) {
                persianMonth = 11;
                persianDay = gregorianDay + 11;
            } else if (gregorianMonth === 2 && gregorianDay >= 20) {
                persianMonth = 12;
                persianDay = gregorianDay - 19;
            }
            
            return `${persianYear}/${persianMonth.toString().padStart(2, '0')}/${persianDay.toString().padStart(2, '0')}`;
        }

        // تنظیم مقادیر پیش‌فرض تاریخ و زمان
        function setDefaultDateTime() {
            // بررسی وجود عناصر DOM
            const dateInput = document.getElementById('scheduled-date');
            const timeInput = document.getElementById('scheduled-time');
            
            if (!dateInput || !timeInput) {
                console.log('عناصر تاریخ و زمان هنوز بارگذاری نشده‌اند');
                return;
            }
            
            // دریافت زمان فعلی تهران
            const now = new Date();
            const tehranTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Tehran"}));
            
            // تنظیم تاریخ شمسی
            const persianDate = convertToPersianDate(tehranTime);
            dateInput.value = persianDate;
            console.log('تاریخ شمسی تنظیم شد:', persianDate);
            
            // تنظیم زمان تهران (24 ساعته)
            const hours = tehranTime.getHours().toString().padStart(2, '0');
            const minutes = tehranTime.getMinutes().toString().padStart(2, '0');
            timeInput.value = `${hours}:${minutes}`;
            console.log('زمان تهران تنظیم شد:', `${hours}:${minutes}`);
        }

        // تبدیل تاریخ شمسی به میلادی (دقیق با استفاده از کتابخانه)
        function convertPersianToGregorian(persianDate, time = '00:00') {
            console.log('🔄 تابع convertPersianToGregorian فراخوانی شد:', persianDate, time);
            const [year, month, day] = persianDate.split('/').map(Number);
            const [hour, minute] = time.split(':').map(Number);
            
            // تبدیل تقریبی اما دقیق‌تر تاریخ شمسی به میلادی
            let gregorianYear = year + 621;
            let gregorianMonth, gregorianDay;
            
            // محاسبه ماه و روز میلادی بر اساس ماه شمسی
            if (month === 1) {
                gregorianMonth = 3;
                gregorianDay = day + 20;
            } else if (month === 2) {
                gregorianMonth = 4;
                gregorianDay = day + 20;
            } else if (month === 3) {
                gregorianMonth = 5;
                gregorianDay = day + 21;
            } else if (month === 4) {
                gregorianMonth = 6;
                gregorianDay = day + 21;
            } else if (month === 5) {
                gregorianMonth = 7;
                gregorianDay = day + 22;
            } else if (month === 6) {
                gregorianMonth = 8;
                gregorianDay = day + 22;
            } else if (month === 7) {
                gregorianMonth = 9;
                gregorianDay = day + 22;
            } else if (month === 8) {
                gregorianMonth = 10;
                gregorianDay = day + 22;
            } else if (month === 9) {
                gregorianMonth = 11;
                gregorianDay = day + 21;
            } else if (month === 10) {
                gregorianMonth = 12;
                gregorianDay = day + 21;
            } else if (month === 11) {
                gregorianMonth = 1;
                gregorianDay = day + 20;
                gregorianYear = year + 622; // سال بعد
            } else if (month === 12) {
                gregorianMonth = 2;
                gregorianDay = day + 19;
                gregorianYear = year + 622; // سال بعد
            }
            
            // ایجاد تاریخ میلادی
            const gregorianDate = new Date(gregorianYear, gregorianMonth - 1, gregorianDay, hour, minute);
            
            console.log(`تاریخ شمسی: ${persianDate} ${time} -> میلادی: ${gregorianDate.toISOString()}`);
            
            return gregorianDate;
        }

        // ارسال فرم ارسال زماندار (حذف شد - فرم جداگانه وجود ندارد)
        /*
        document.getElementById('scheduled-broadcast-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('schedule-title').value,
                message: document.getElementById('schedule-message').value,
                platforms: Array.from(document.getElementById('schedule-platforms').selectedOptions).map(option => option.value),
                scopes: Array.from(document.getElementById('schedule-scopes').selectedOptions).map(option => option.value),
                repeat_type: document.getElementById('schedule-repeat').value,
                solar_date: document.getElementById('schedule-date').value,
                time: document.getElementById('schedule-time').value
            };

            try {
                const response = await fetch('/api/scheduler/schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'ارسال زماندار با موفقیت برنامه‌ریزی شد!');
                    hideScheduleForm();
                    refreshScheduledList();
                } else {
                    showAlert('danger', `خطا: ${result.error}`);
                }
            } catch (error) {
                showAlert('danger', `خطا در ارسال درخواست: ${error.message}`);
            }
        });
        */

        // بروزرسانی لیست ارسال‌های زماندار
        async function refreshScheduledList() {
            try {
                const response = await fetch('/api/scheduler/list');
                const result = await response.json();
                
                if (response.ok) {
                    scheduledBroadcasts = result;
                    displayScheduledList();
                } else {
                    console.error('Error fetching scheduled broadcasts:', result.error);
                    // نمایش پیام خطا در container
                    const container = document.getElementById('scheduled-list');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                <p class="text-warning mt-2">خطا در بارگذاری ارسال‌های زماندار</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshScheduledList()">
                                    <i class="fas fa-sync"></i> تلاش مجدد
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error fetching scheduled broadcasts:', error);
                // نمایش پیام خطا در container
                const container = document.getElementById('scheduled-list');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            <p class="text-warning mt-2">خطا در اتصال به سرور</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshScheduledList()">
                                <i class="fas fa-sync"></i> تلاش مجدد
                            </button>
                        </div>
                    `;
                }
            }
        }

        // نمایش لیست ارسال‌های زماندار
        function displayScheduledList() {
            const container = document.getElementById('scheduled-list');
            let filteredBroadcasts = scheduledBroadcasts;

            // فیلتر بر اساس وضعیت
            if (currentScheduledFilter !== 'all') {
                filteredBroadcasts = scheduledBroadcasts.filter(broadcast => 
                    broadcast.status === currentScheduledFilter
                );
            }

            if (filteredBroadcasts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clock text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">هیچ ارسال زمانداری یافت نشد</p>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="document.querySelector('[data-section=\\"broadcast-section\\"]').click()">
                                <i class="fas fa-plus"></i> ایجاد ارسال زماندار جدید
                            </button>
                        </div>
                    </div>
                `;
                
                // نمایش راهنمای ایجاد ارسال زماندار
                const helpDiv = document.getElementById('scheduled-help');
                if (helpDiv) {
                    helpDiv.style.display = 'block';
                }
                return;
            }

            let html = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllScheduled()">
                                <i class="fas fa-check-square"></i> انتخاب همه
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllScheduled()">
                                <i class="fas fa-square"></i> لغو انتخاب
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedScheduled()" id="deleteSelectedBtn" disabled>
                                <i class="fas fa-trash"></i> حذف انتخاب شده‌ها
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th>عنوان</th>
                                <th>وضعیت</th>
                                <th>زمان برنامه‌ریزی</th>
                                <th>پلتفرم‌ها</th>
                                <th>محدوده</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredBroadcasts.forEach(broadcast => {
                const statusClass = getStatusClass(broadcast.status);
                const statusText = getStatusText(broadcast.status);
                const scheduledTime = formatPersianDateTime(broadcast.scheduled_time);
                const platforms = broadcast.platforms ? (Array.isArray(broadcast.platforms) ? broadcast.platforms.join(', ') : broadcast.platforms) : 'نامشخص';
                const scopes = broadcast.scopes ? (Array.isArray(broadcast.scopes) ? broadcast.scopes.join(', ') : broadcast.scopes) : 'نامشخص';
                
                // بررسی دلایل ناموفق بودن
                let failureReason = '';
                if (broadcast.status === 'failed') {
                    const reasons = [];
                    if (!broadcast.title || broadcast.title === 'null') reasons.push('عنوان نداشته');
                    if (!broadcast.message || broadcast.message === 'null') reasons.push('پیام نداشته');
                    if (broadcast.scheduled_time && new Date(broadcast.scheduled_time) < new Date()) reasons.push('زمان عقب بوده');
                    if (!broadcast.platforms || broadcast.platforms.length === 0) reasons.push('پلتفرم انتخاب نشده');
                    if (!broadcast.scopes || broadcast.scopes.length === 0) reasons.push('محدوده انتخاب نشده');
                    if (reasons.length === 0) reasons.push('خطای نامشخص');
                    failureReason = reasons.join('، ');
                }

                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="scheduled-checkbox" value="${broadcast.id}" onchange="updateDeleteButton()">
                        </td>
                        <td>
                            <strong>${broadcast.title || 'بدون عنوان'}</strong>
                            <br>
                            <small class="text-muted">${broadcast.message ? broadcast.message.substring(0, 50) + (broadcast.message.length > 50 ? '...' : '') : 'پیام موجود نیست'}</small>
                            ${failureReason ? `<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${failureReason}</small>` : ''}
                        </td>
                        <td>
                            <span class="badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <small>${scheduledTime}</small>
                        </td>
                        <td>
                            <small>${platforms}</small>
                        </td>
                        <td>
                            <small>${scopes}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                ${broadcast.status === 'pending' ? 
                                    `<button class="btn btn-danger btn-sm" onclick="cancelScheduled(${broadcast.id})" title="لغو">
                                        <i class="fas fa-times"></i>
                                    </button>` : ''
                                }
                                <button class="btn btn-info btn-sm" onclick="viewScheduledDetails(${broadcast.id})" title="جزئیات">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // فیلتر ارسال‌های زماندار
        function filterScheduled(status) {
            currentScheduledFilter = status;
            
            // بروزرسانی دکمه‌های فیلتر
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayScheduledList();
        }

        // لغو ارسال زماندار
        async function cancelScheduled(broadcastId) {
            if (!confirm('آیا از لغو این ارسال زماندار اطمینان دارید؟')) {
                return;
            }

            try {
                const response = await fetch(`/api/scheduler/cancel/${broadcastId}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'ارسال زماندار با موفقیت لغو شد!');
                    refreshScheduledList();
                } else {
                    showAlert('danger', `خطا در لغو: ${result.error}`);
                }
            } catch (error) {
                showAlert('danger', `خطا در لغو: ${error.message}`);
            }
        }

        // نمایش جزئیات ارسال زماندار
        function viewScheduledDetails(broadcastId) {
            const broadcast = scheduledBroadcasts.find(b => b.id === broadcastId);
            if (!broadcast) return;

            const modal = `
                <div class="modal fade" id="scheduledDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">جزئیات ارسال زماندار</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>عنوان:</strong> ${broadcast.title}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>وضعیت:</strong> <span class="badge ${getStatusClass(broadcast.status)}">${getStatusText(broadcast.status)}</span>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <strong>زمان برنامه‌ریزی:</strong> ${formatPersianDateTime(broadcast.scheduled_time)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>پلتفرم‌ها:</strong> ${broadcast.platforms ? (Array.isArray(broadcast.platforms) ? broadcast.platforms.join(', ') : broadcast.platforms) : 'نامشخص'}
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <strong>محدوده:</strong> ${broadcast.scopes ? (Array.isArray(broadcast.scopes) ? broadcast.scopes.join(', ') : broadcast.scopes) : 'نامشخص'}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>تکرار:</strong> ${getRepeatText(broadcast.repeat_type)}
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <strong>متن پیام:</strong>
                                    <div class="border p-2 mt-1" style="background-color: #f8f9fa;">
                                        ${broadcast.message}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // حذف modal قبلی اگر وجود دارد
            const existingModal = document.getElementById('scheduledDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // اضافه کردن modal جدید
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // نمایش modal
            const modalElement = new bootstrap.Modal(document.getElementById('scheduledDetailsModal'));
            modalElement.show();
        }

        // توابع کمکی
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'executing': return 'bg-info';
                case 'executed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'cancelled': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'در انتظار';
                case 'executing': return 'در حال اجرا';
                case 'executed': return 'اجرا شده';
                case 'failed': return 'ناموفق';
                case 'cancelled': return 'لغو شده';
                default: return 'نامشخص';
            }
        }

        function getRepeatText(repeatType) {
            switch (repeatType) {
                case 'once': return 'یک بار';
                case 'daily': return 'روزانه';
                case 'weekly': return 'هفتگی';
                case 'monthly': return 'ماهانه';
                default: return 'یک بار';
            }
        }

        function formatPersianDateTime(dateTimeString) {
            // این تابع باید با کتابخانه jdatetime پیاده‌سازی شود
            // فعلاً تاریخ میلادی را نمایش می‌دهیم
            const date = new Date(dateTimeString);
            return date.toLocaleString('fa-IR');
        }

        // مدیریت کاربران و تگ‌ها
        // توابع مدیریت کاربران حذف شده - حالا از بخش چت‌های ثبت شده قابل مدیریت است

        // Dark Mode Toggle Function
        function toggleDarkMode() {
            const body = document.body;
            const toggle = document.getElementById('darkModeToggle');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                toggle.innerHTML = '<i class="fas fa-moon"></i> حالت تاریک';
                localStorage.setItem('darkMode', 'false');
                } else {
                body.classList.add('dark-mode');
                toggle.innerHTML = '<i class="fas fa-sun"></i> حالت روشن';
                localStorage.setItem('darkMode', 'true');
            }
        }
        
        // Load Dark Mode Preference
        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const toggle = document.getElementById('darkModeToggle');
            
            if (darkMode === 'true') {
                document.body.classList.add('dark-mode');
                toggle.innerHTML = '<i class="fas fa-sun"></i> حالت روشن';
            }
        }
        
        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl + D: Toggle Dark Mode
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    toggleDarkMode();
                }
                
                // Ctrl + R: Refresh Chats
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    loadRegisteredChats();
                }
                
                // Ctrl + A: Toggle Auto Refresh
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    toggleAutoRefresh();
                }
                
                // Ctrl + N: New Chat Registration
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    showBatchImportModal();
                }
                
                // Escape: Close Modals
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.show');
                    modals.forEach(modal => {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) bsModal.hide();
                    });
                }
            });
        }
        
        // Add loading states to buttons
        function addLoadingState(button, text = 'در حال پردازش...') {
            const originalText = button.innerHTML;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
            button.disabled = true;
            button.classList.add('loading');
            
            return function removeLoadingState() {
                button.innerHTML = originalText;
                button.disabled = false;
                button.classList.remove('loading');
            };
        }
        
        // Show Keyboard Shortcuts
        function showKeyboardShortcuts() {
            const shortcuts = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-keyboard text-primary"></i> میانبرهای صفحه‌کلید</h6>
                        <ul class="list-unstyled">
                            <li><kbd>Ctrl</kbd> + <kbd>D</kbd> - تغییر حالت تاریک/روشن</li>
                            <li><kbd>Ctrl</kbd> + <kbd>R</kbd> - به‌روزرسانی لیست چت‌ها</li>
                            <li><kbd>Ctrl</kbd> + <kbd>A</kbd> - فعال/غیرفعال کردن Auto Refresh</li>
                            <li><kbd>Ctrl</kbd> + <kbd>N</kbd> - ثبت چت جدید</li>
                            <li><kbd>Esc</kbd> - بستن پنجره‌های باز</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-lightbulb text-warning"></i> نکات کاربردی</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> از فیلترها برای جستجوی سریع استفاده کنید</li>
                            <li><i class="fas fa-check text-success"></i> تگ‌ها را در ستون مربوطه ویرایش کنید</li>
                            <li><i class="fas fa-check text-success"></i> از حالت تاریک برای کاهش خستگی چشم استفاده کنید</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showAlert('info', shortcuts, false);
        }
        
        // Auto-refresh functionality
        function toggleAutoRefresh() {
            const autoRefreshBtn = document.getElementById('auto-refresh-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            const statusAlert = document.getElementById('auto-refresh-status');
            const intervalDisplay = document.getElementById('refresh-interval-display');
            
            if (autoRefreshEnabled) {
                // Stop auto-refresh
                clearInterval(autoRefreshInterval);
                autoRefreshEnabled = false;
                autoRefreshBtn.innerHTML = '<i class="fas fa-play"></i> Auto Refresh';
                autoRefreshBtn.className = 'btn btn-sm btn-outline-success';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> به‌روزرسانی';
                statusAlert.style.display = 'none';
                
                showAlert('info', 'Auto-refresh متوقف شد', true);
            } else {
                // Start auto-refresh
                autoRefreshEnabled = true;
                autoRefreshBtn.innerHTML = '<i class="fas fa-pause"></i> Stop Auto';
                autoRefreshBtn.className = 'btn btn-sm btn-outline-warning';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> به‌روزرسانی';
                statusAlert.style.display = 'block';
                intervalDisplay.textContent = autoRefreshIntervalTime / 1000;
                
                // Start the interval
                autoRefreshInterval = setInterval(() => {
                    if (autoRefreshEnabled) {
                        loadRegisteredChats(currentPage);
                        // Add a subtle notification
                        const refreshBtn = document.getElementById('refresh-btn');
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> به‌روزرسانی';
                        setTimeout(() => {
                            if (autoRefreshEnabled) {
                                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> به‌روزرسانی';
                            }
                        }, 1000);
                    }
                }, autoRefreshIntervalTime);
                
                showAlert('success', `Auto-refresh فعال شد (هر ${autoRefreshIntervalTime/1000} ثانیه)`, true);
            }
        }
        
        // Set refresh interval
        function setRefreshInterval(interval) {
            autoRefreshIntervalTime = interval;
            const intervalBtn = document.getElementById('refresh-interval-btn');
            const intervalDisplay = document.getElementById('refresh-interval-display');
            
            // Update button text
            if (interval === 10000) {
                intervalBtn.innerHTML = '<i class="fas fa-bolt"></i> 10s';
            } else if (interval === 30000) {
                intervalBtn.innerHTML = '<i class="fas fa-clock"></i> 30s';
            } else if (interval === 60000) {
                intervalBtn.innerHTML = '<i class="fas fa-hourglass-half"></i> 1m';
            } else if (interval === 300000) {
                intervalBtn.innerHTML = '<i class="fas fa-hourglass"></i> 5m';
            }
            
            // Update status display
            if (intervalDisplay) {
                intervalDisplay.textContent = interval / 1000;
            }
            
            // If auto-refresh is currently running, restart it with new interval
            if (autoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = setInterval(() => {
                    if (autoRefreshEnabled) {
                        loadRegisteredChats(currentPage);
                    }
                }, autoRefreshIntervalTime);
            }
            
            // Save settings
            saveAutoRefreshSettings();
            
            showAlert('info', `فاصله زمانی auto-refresh به ${interval/1000} ثانیه تغییر یافت`, true);
        }
        
        // Stop auto-refresh when page is not visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && autoRefreshEnabled) {
                // Page is hidden, pause auto-refresh
                clearInterval(autoRefreshInterval);
            } else if (!document.hidden && autoRefreshEnabled) {
                // Page is visible again, resume auto-refresh
                autoRefreshInterval = setInterval(() => {
                    if (autoRefreshEnabled) {
                        loadRegisteredChats(currentPage);
                    }
                }, autoRefreshIntervalTime);
            }
        });
        
        // Load auto-refresh settings
        function loadAutoRefreshSettings() {
            const savedInterval = localStorage.getItem('autoRefreshInterval');
            if (savedInterval) {
                setRefreshInterval(parseInt(savedInterval));
            }
        }
        
        // Save auto-refresh settings
        function saveAutoRefreshSettings() {
            localStorage.setItem('autoRefreshInterval', autoRefreshIntervalTime);
        }
        
        // Update last refresh time
        function updateLastRefreshTime() {
            const lastRefreshTime = document.getElementById('last-refresh-time');
            const lastRefreshInfo = document.getElementById('last-refresh-info');
            
            if (lastRefreshTime && lastRefreshInfo) {
                refreshCount++;
                const now = new Date();
                const timeString = now.toLocaleTimeString('fa-IR');
                lastRefreshTime.textContent = `${timeString} (${refreshCount} بار)`;
                lastRefreshInfo.style.display = 'block';
            }
        }
        
        // Reset refresh counter
        function resetRefreshCounter() {
            refreshCount = 0;
            const lastRefreshTime = document.getElementById('last-refresh-time');
            if (lastRefreshTime) {
                lastRefreshTime.textContent = '-';
            }
            showAlert('info', 'شمارنده به‌روزرسانی reset شد', true);
        }
        
        // Show auto-refresh statistics
        function showAutoRefreshStats() {
            const stats = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line text-primary"></i> آمار Auto Refresh</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-sync-alt text-info"></i> تعداد به‌روزرسانی‌ها: <strong>${refreshCount}</strong></li>
                            <li><i class="fas fa-clock text-warning"></i> فاصله زمانی: <strong>${autoRefreshIntervalTime/1000} ثانیه</strong></li>
                            <li><i class="fas fa-toggle-${autoRefreshEnabled ? 'on' : 'off'} text-${autoRefreshEnabled ? 'success' : 'danger'}"></i> وضعیت: <strong>${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}</strong></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog text-secondary"></i> تنظیمات</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-keyboard text-info"></i> میانبر: <kbd>Ctrl</kbd> + <kbd>A</kbd></li>
                            <li><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه: <strong>فعال</strong></li>
                            <li><i class="fas fa-save text-primary"></i> ذخیره تنظیمات: <strong>فعال</strong></li>
                        </ul>
                    </div>
                </div>
            `;
            
            showAlert('info', stats, false);
        }
        
        // Preview auto-refresh (test without enabling)
        function previewAutoRefresh() {
            if (autoRefreshEnabled) {
                showAlert('warning', 'Auto-refresh در حال حاضر فعال است', true);
                return;
            }
            
            showAlert('info', 'شروع پیش‌نمایش auto-refresh...', true);
            
            // Simulate auto-refresh for 3 cycles
            let previewCount = 0;
            const previewInterval = setInterval(() => {
                previewCount++;
                loadRegisteredChats(currentPage);
                showAlert('success', `پیش‌نمایش ${previewCount}/3 - به‌روزرسانی انجام شد`, true);
                
                if (previewCount >= 3) {
                    clearInterval(previewInterval);
                    showAlert('info', 'پیش‌نمایش auto-refresh تکمیل شد', true);
                }
            }, 5000); // 5 seconds for preview
        }
        
        // Show auto-refresh help
        function showAutoRefreshHelp() {
            const help = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-question-circle text-primary"></i> راهنمای Auto Refresh</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-play text-success"></i> <strong>فعال کردن:</strong> روی دکمه "Auto Refresh" کلیک کنید</li>
                            <li><i class="fas fa-pause text-warning"></i> <strong>متوقف کردن:</strong> روی دکمه "Stop Auto" کلیک کنید</li>
                            <li><i class="fas fa-clock text-info"></i> <strong>تنظیم زمان:</strong> از منوی کشویی استفاده کنید</li>
                            <li><i class="fas fa-chart-line text-primary"></i> <strong>مشاهده آمار:</strong> روی دکمه "آمار" کلیک کنید</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-lightbulb text-warning"></i> نکات مهم</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-eye text-success"></i> Auto-refresh در پس‌زمینه متوقف می‌شود</li>
                            <li><i class="fas fa-save text-primary"></i> تنظیمات در localStorage ذخیره می‌شود</li>
                            <li><i class="fas fa-keyboard text-info"></i> میانبر: <kbd>Ctrl</kbd> + <kbd>A</kbd></li>
                            <li><i class="fas fa-undo text-secondary"></i> شمارنده قابل reset است</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showAlert('info', help, false);
        }
        
        // Show real-time auto-refresh status
        function showRealTimeStatus() {
            const status = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-sync-alt text-primary"></i> وضعیت Real-time</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-toggle-${autoRefreshEnabled ? 'on' : 'off'} text-${autoRefreshEnabled ? 'success' : 'danger'}"></i> Auto-refresh: <strong>${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}</strong></li>
                            <li><i class="fas fa-clock text-info"></i> فاصله زمانی: <strong>${autoRefreshIntervalTime/1000} ثانیه</strong></li>
                            <li><i class="fas fa-sync-alt text-warning"></i> تعداد به‌روزرسانی‌ها: <strong>${refreshCount}</strong></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog text-secondary"></i> تنظیمات فعال</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-save text-primary"></i> ذخیره تنظیمات: <strong>فعال</strong></li>
                            <li><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه: <strong>فعال</strong></li>
                            <li><i class="fas fa-keyboard text-info"></i> میانبر صفحه‌کلید: <strong>فعال</strong></li>
                        </ul>
                    </div>
                </div>
            `;
            
            showAlert('info', status, false);
        }
        
        // Show countdown to next refresh
        function showCountdown() {
            if (!autoRefreshEnabled) {
                showAlert('warning', 'Auto-refresh فعال نیست', true);
                return;
            }
            
            let countdown = autoRefreshIntervalTime / 1000;
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    showAlert('success', 'به‌روزرسانی انجام شد!', true);
                } else {
                    showAlert('info', `به‌روزرسانی بعدی در ${countdown} ثانیه`, true);
                }
            }, 1000);
        }
        
        // Show advanced auto-refresh settings
        function showAdvancedSettings() {
            const settings = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-cogs text-primary"></i> تنظیمات پیشرفته</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-clock text-info"></i> فاصله زمانی فعلی: <strong>${autoRefreshIntervalTime/1000} ثانیه</strong></li>
                            <li><i class="fas fa-sync-alt text-warning"></i> تعداد به‌روزرسانی‌ها: <strong>${refreshCount}</strong></li>
                            <li><i class="fas fa-toggle-${autoRefreshEnabled ? 'on' : 'off'} text-${autoRefreshEnabled ? 'success' : 'danger'}"></i> وضعیت: <strong>${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}</strong></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-tools text-secondary"></i> گزینه‌های پیشرفته</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-save text-primary"></i> ذخیره تنظیمات: <strong>فعال</strong></li>
                            <li><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه: <strong>فعال</strong></li>
                            <li><i class="fas fa-keyboard text-info"></i> میانبر صفحه‌کلید: <strong>فعال</strong></li>
                        </ul>
                    </div>
                </div>
            `;
            
            showAlert('info', settings, false);
        }
        
        // Show auto-refresh summary
        function showAutoRefreshSummary() {
            const summary = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-primary"></i> خلاصه Auto Refresh</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-play text-success"></i> <strong>فعال کردن:</strong> دکمه "Auto Refresh"</li>
                            <li><i class="fas fa-pause text-warning"></i> <strong>متوقف کردن:</strong> دکمه "Stop Auto"</li>
                            <li><i class="fas fa-clock text-info"></i> <strong>تنظیم زمان:</strong> منوی کشویی</li>
                            <li><i class="fas fa-chart-line text-primary"></i> <strong>مشاهده آمار:</strong> دکمه "آمار"</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-lightbulb text-warning"></i> نکات مهم</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه</li>
                            <li><i class="fas fa-save text-primary"></i> ذخیره تنظیمات</li>
                            <li><i class="fas fa-keyboard text-info"></i> میانبر: <kbd>Ctrl</kbd> + <kbd>A</kbd></li>
                            <li><i class="fas fa-undo text-secondary"></i> Reset شمارنده</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showAlert('info', summary, false);
        }
        
        // Show auto-refresh modal
        function showAutoRefreshModal() {
            const modal = `
                <div class="modal fade" id="autoRefreshModal" tabindex="-1" aria-labelledby="autoRefreshModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="autoRefreshModalLabel">
                                    <i class="fas fa-sync-alt text-primary"></i> تنظیمات Auto Refresh
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-cog text-primary"></i> تنظیمات فعلی</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-toggle-${autoRefreshEnabled ? 'on' : 'off'} text-${autoRefreshEnabled ? 'success' : 'danger'}"></i> وضعیت: <strong>${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}</strong></li>
                                            <li><i class="fas fa-clock text-info"></i> فاصله زمانی: <strong>${autoRefreshIntervalTime/1000} ثانیه</strong></li>
                                            <li><i class="fas fa-sync-alt text-warning"></i> تعداد به‌روزرسانی‌ها: <strong>${refreshCount}</strong></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-tools text-secondary"></i> گزینه‌ها</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-save text-primary"></i> ذخیره تنظیمات: <strong>فعال</strong></li>
                                            <li><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه: <strong>فعال</strong></li>
                                            <li><i class="fas fa-keyboard text-info"></i> میانبر صفحه‌کلید: <strong>فعال</strong></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                                <button type="button" class="btn btn-primary" onclick="toggleAutoRefresh()">${autoRefreshEnabled ? 'متوقف کردن' : 'فعال کردن'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('autoRefreshModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modal);
            
            // Show modal
            const modalElement = new bootstrap.Modal(document.getElementById('autoRefreshModal'));
            modalElement.show();
        }
        
        // Show auto-refresh tooltip
        function showAutoRefreshTooltip() {
            const tooltip = `
                <div class="tooltip show" role="tooltip" style="position: absolute; z-index: 1070; display: block;">
                    <div class="tooltip-inner">
                        <strong>Auto Refresh:</strong> ${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}<br>
                        <strong>فاصله زمانی:</strong> ${autoRefreshIntervalTime/1000} ثانیه<br>
                        <strong>تعداد به‌روزرسانی‌ها:</strong> ${refreshCount}
                    </div>
                </div>
            `;
            
            showAlert('info', tooltip, false);
        }
        
        // Show auto-refresh popover
        function showAutoRefreshPopover() {
            const popover = `
                <div class="popover show" role="tooltip" style="position: absolute; z-index: 1070; display: block;">
                    <div class="popover-header">
                        <strong>Auto Refresh Status</strong>
                    </div>
                    <div class="popover-body">
                        <strong>وضعیت:</strong> ${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}<br>
                        <strong>فاصله زمانی:</strong> ${autoRefreshIntervalTime/1000} ثانیه<br>
                        <strong>تعداد به‌روزرسانی‌ها:</strong> ${refreshCount}<br>
                        <strong>ذخیره تنظیمات:</strong> فعال<br>
                        <strong>توقف در پس‌زمینه:</strong> فعال
                    </div>
                </div>
            `;
            
            showAlert('info', popover, false);
        }
        
        // Show auto-refresh dropdown
        function showAutoRefreshDropdown() {
            const dropdown = `
                <div class="dropdown-menu show" style="position: absolute; z-index: 1070; display: block;">
                    <h6 class="dropdown-header">
                        <i class="fas fa-sync-alt text-primary"></i> Auto Refresh Status
                    </h6>
                    <div class="dropdown-item-text">
                        <strong>وضعیت:</strong> ${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}<br>
                        <strong>فاصله زمانی:</strong> ${autoRefreshIntervalTime/1000} ثانیه<br>
                        <strong>تعداد به‌روزرسانی‌ها:</strong> ${refreshCount}
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" onclick="toggleAutoRefresh()">
                        <i class="fas fa-${autoRefreshEnabled ? 'pause' : 'play'}"></i> ${autoRefreshEnabled ? 'متوقف کردن' : 'فعال کردن'}
                    </a>
                    <a class="dropdown-item" href="#" onclick="showAutoRefreshStats()">
                        <i class="fas fa-chart-line"></i> آمار
                    </a>
                    <a class="dropdown-item" href="#" onclick="showAutoRefreshHelp()">
                        <i class="fas fa-question-circle"></i> راهنما
                    </a>
                </div>
            `;
            
            showAlert('info', dropdown, false);
        }
        
        // Show auto-refresh accordion
        function showAutoRefreshAccordion() {
            const accordion = `
                <div class="accordion" id="autoRefreshAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <i class="fas fa-sync-alt text-primary"></i> Auto Refresh Status
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#autoRefreshAccordion">
                            <div class="accordion-body">
                                <strong>وضعیت:</strong> ${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}<br>
                                <strong>فاصله زمانی:</strong> ${autoRefreshIntervalTime/1000} ثانیه<br>
                                <strong>تعداد به‌روزرسانی‌ها:</strong> ${refreshCount}<br>
                                <strong>ذخیره تنظیمات:</strong> فعال<br>
                                <strong>توقف در پس‌زمینه:</strong> فعال
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showAlert('info', accordion, false);
        }
        
        // Show auto-refresh card
        function showAutoRefreshCard() {
            const card = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sync-alt text-primary"></i> Auto Refresh Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-cog text-primary"></i> تنظیمات فعلی</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-toggle-${autoRefreshEnabled ? 'on' : 'off'} text-${autoRefreshEnabled ? 'success' : 'danger'}"></i> وضعیت: <strong>${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}</strong></li>
                                    <li><i class="fas fa-clock text-info"></i> فاصله زمانی: <strong>${autoRefreshIntervalTime/1000} ثانیه</strong></li>
                                    <li><i class="fas fa-sync-alt text-warning"></i> تعداد به‌روزرسانی‌ها: <strong>${refreshCount}</strong></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-tools text-secondary"></i> گزینه‌ها</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-save text-primary"></i> ذخیره تنظیمات: <strong>فعال</strong></li>
                                    <li><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه: <strong>فعال</strong></li>
                                    <li><i class="fas fa-keyboard text-info"></i> میانبر صفحه‌کلید: <strong>فعال</strong></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showAlert('info', card, false);
        }
        
        // Show auto-refresh table
        function showAutoRefreshTable() {
            const table = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th><i class="fas fa-sync-alt text-primary"></i> Auto Refresh Status</th>
                                <th>مقدار</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="fas fa-toggle-${autoRefreshEnabled ? 'on' : 'off'} text-${autoRefreshEnabled ? 'success' : 'danger'}"></i> وضعیت</td>
                                <td><strong>${autoRefreshEnabled ? 'فعال' : 'غیرفعال'}</strong></td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-clock text-info"></i> فاصله زمانی</td>
                                <td><strong>${autoRefreshIntervalTime/1000} ثانیه</strong></td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-sync-alt text-warning"></i> تعداد به‌روزرسانی‌ها</td>
                                <td><strong>${refreshCount}</strong></td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-save text-primary"></i> ذخیره تنظیمات</td>
                                <td><strong>فعال</strong></td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-eye text-success"></i> توقف در پس‌زمینه</td>
                                <td><strong>فعال</strong></td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-keyboard text-info"></i> میانبر صفحه‌کلید</td>
                                <td><strong>فعال</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            showAlert('info', table, false);
        }

        // توابع انتخاب چندگانه برای ارسال‌های زماندار
        function selectAllScheduled() {
            const checkboxes = document.querySelectorAll('.scheduled-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            document.getElementById('selectAllCheckbox').checked = true;
            updateDeleteButton();
        }

        function deselectAllScheduled() {
            const checkboxes = document.querySelectorAll('.scheduled-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateDeleteButton();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.scheduled-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.scheduled-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (checkboxes.length > 0) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = `حذف انتخاب شده‌ها (${checkboxes.length})`;
            } else {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'حذف انتخاب شده‌ها';
            }
        }

        async function deleteSelectedScheduled() {
            const checkboxes = document.querySelectorAll('.scheduled-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('warning', 'لطفاً حداقل یک ارسال را انتخاب کنید');
                return;
            }

            if (!confirm(`آیا از حذف ${checkboxes.length} ارسال زماندار اطمینان دارید؟ این عمل غیرقابل بازگشت است.`)) {
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال حذف...';

            try {
                const response = await fetch('/api/scheduler/delete_multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        broadcast_ids: selectedIds
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', `${result.deleted_count} ارسال زماندار با موفقیت حذف شد`);
                    refreshScheduledList();
                } else {
                    showAlert('danger', `خطا در حذف: ${result.error}`);
                }
            } catch (error) {
                showAlert('danger', `خطا در حذف: ${error.message}`);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        }

        // توابع انتخاب چندگانه برای تاریخچه ارسال
        function selectAllHistory() {
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            document.getElementById('selectAllHistoryCheckbox').checked = true;
            updateDeleteHistoryButton();
        }

        function deselectAllHistory() {
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllHistoryCheckbox').checked = false;
            updateDeleteHistoryButton();
        }

        function toggleSelectAllHistory() {
            const selectAllCheckbox = document.getElementById('selectAllHistoryCheckbox');
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateDeleteHistoryButton();
        }

        function updateDeleteHistoryButton() {
            const checkboxes = document.querySelectorAll('.history-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedHistoryBtn');
            if (checkboxes.length > 0) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = `حذف انتخاب شده‌ها (${checkboxes.length})`;
            } else {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'حذف انتخاب شده‌ها';
            }
        }

        async function deleteSelectedHistory() {
            const checkboxes = document.querySelectorAll('.history-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('warning', 'لطفاً حداقل یک ارسال را انتخاب کنید');
                return;
            }

            if (!confirm(`آیا از حذف ${checkboxes.length} ارسال اطمینان دارید؟ این عمل غیرقابل بازگشت است.`)) {
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const deleteBtn = document.getElementById('deleteSelectedHistoryBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال حذف...';

            try {
                const response = await fetch('/api/history/delete_multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        history_ids: selectedIds
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', `${result.deleted_count} ارسال با موفقیت حذف شد`);
                    fetchHistory();
                } else {
                    showAlert('danger', `خطا در حذف: ${result.error}`);
                }
            } catch (error) {
                showAlert('danger', `خطا در حذف: ${error.message}`);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        }

        function changeHistoryLimit() {
            const select = document.getElementById('historyLimit');
            historyLimit = parseInt(select.value);
            currentHistoryPage = 1;
            fetchHistory();
        }

        function updateHistoryPagination() {
            const paginationContainer = document.getElementById('history-pagination');
            if (totalHistoryPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHtml = '<nav><ul class="pagination pagination-sm">';
            
            // Previous button
            if (currentHistoryPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToHistoryPage(${currentHistoryPage - 1})">قبلی</a></li>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentHistoryPage - 2);
            const endPage = Math.min(totalHistoryPages, currentHistoryPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentHistoryPage ? 'active' : '';
                paginationHtml += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="goToHistoryPage(${i})">${i}</a></li>`;
            }
            
            // Next button
            if (currentHistoryPage < totalHistoryPages) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToHistoryPage(${currentHistoryPage + 1})">بعدی</a></li>`;
            }
            
            paginationHtml += '</ul></nav>';
            paginationContainer.innerHTML = paginationHtml;
        }

        function goToHistoryPage(page) {
            currentHistoryPage = page;
            fetchHistory();
        }

        // بارگذاری اولیه لیست ارسال‌های زماندار
        document.addEventListener('DOMContentLoaded', function() {
            refreshScheduledList();
            loadDarkModePreference();
            loadAutoRefreshSettings();
            setupKeyboardShortcuts();
        });
    </script>

</body>
</html>